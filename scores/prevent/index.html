<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teste PREVENT (10y + 30y)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px;max-width:920px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;font-size:12px;color:#555;margin:10px 0 6px}
    input,select{padding:10px 12px;border:1px solid #ddd;border-radius:10px;min-width:220px}
    .card{border:1px solid #eee;border-radius:14px;padding:16px;margin-top:14px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer;font-weight:700}
    .out{font-size:18px;font-weight:800;margin-top:10px}
    .muted{color:#666;font-size:13px}
  </style>
</head>
<body>
  <h1>PREVENT — teste rápido (Full 10y + 30y)</h1>
  <p class="muted">Isso é só um teste do motor. Depois a gente encaixa no seu layout.</p>

  <div class="card">
    <div class="row">
      <div>
        <label>Desfecho</label>
        <select id="outcome">
          <option value="total_cvd">DCV total</option>
          <option value="ascvd">ASCVD</option>
          <option value="heart_failure">Insuficiência cardíaca</option>
        </select>
      </div>

      <div>
        <label>Sexo</label>
        <select id="sex">
          <option value="female">Feminino</option>
          <option value="male">Masculino</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div><label>Idade (anos)</label><input id="age" type="number" min="18" max="100" value="55"></div>
      <div><label>PAS (mmHg)</label><input id="sbp" type="number" min="70" max="250" value="130"></div>
      <div><label>eGFR (mL/min/1,73m²)</label><input id="egfr" type="number" min="5" max="200" value="85"></div>
    </div>

    <div class="row">
      <div>
        <label>non-HDL</label>
        <input id="nonhdl" type="number" min="30" max="400" value="160">
        <div class="muted">
          <label style="margin:6px 0 0">Unidade</label>
          <select id="nonhdl_unit">
            <option value="mgdl">mg/dL</option>
            <option value="mmol">mmol/L</option>
          </select>
        </div>
      </div>

      <div>
        <label>HDL</label>
        <input id="hdl" type="number" min="10" max="150" value="45">
        <div class="muted">
          <label style="margin:6px 0 0">Unidade</label>
          <select id="hdl_unit">
            <option value="mgdl">mg/dL</option>
            <option value="mmol">mmol/L</option>
          </select>
        </div>
      </div>

      <div><label>IMC (opcional)</label><input id="bmi" type="number" min="10" max="70" placeholder="ex: 28"></div>
    </div>

    <div class="row">
      <label><input id="dm" type="checkbox"> Diabetes</label>
      <label><input id="smoke" type="checkbox"> Tabagismo atual</label>
      <label><input id="antihtn" type="checkbox"> Usa anti-hipertensivo</label>
      <label><input id="statin" type="checkbox"> Usa estatina</label>
    </div>

    <div class="row">
      <div><label>ACR/UACR mg/g (opcional)</label><input id="acr" type="number" min="0" step="0.1" placeholder="ex: 30"></div>
      <div><label>HbA1c % (opcional)</label><input id="hba1c" type="number" min="3" max="20" step="0.1" placeholder="ex: 7.2"></div>
      <div>
        <label>SDI decile 1–10 (opcional)</label>
        <input id="sdi" type="number" min="1" max="10" step="1" placeholder="ex: 4">
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" id="btnCalc">Calcular</button>
      <div class="muted" id="status"></div>
    </div>

    <div class="out">
      10 anos: <span id="res10">—</span> &nbsp;|&nbsp; 30 anos: <span id="res30">—</span>
    </div>
  </div>

<script>
  let PREVENT_MODELS = null;

  async function loadPreventModels() {
  if (PREVENT_MODELS) return PREVENT_MODELS;
  // Use o link raw.githubusercontent.com
  const res = await fetch("https://raw.githubusercontent.com/arthurambrosi/usojaleco-site/0722ef72f586e6bddf5ee0ba1a2290ccb5548cbf/scores/prevent/prevent_full_models.json");
  
  if (!res.ok) throw new Error("Não consegui carregar prevent_full_models.json");
  PREVENT_MODELS = await res.json();
  return PREVENT_MODELS;
}

  function logistic(x) { return 1 / (1 + Math.exp(-x)); }
  const CHOL_MGDL_TO_MMOL = 1 / 38.67;

  const TERM_VALUE = {
    "Age, 10 years": (i) => i.age / 10,
    "non-HDL-C per 1 mmol/L": (i) => i.nonHdl_mmol,
    "HDL-C per 0.3 mmol/L": (i) => i.hdl_mmol / 0.3,

    "SBP <110 per 20 mmHg": (i) => Math.max(0, (110 - i.sbp) / 20),
    "SBP ≥110 per 20 mmHg": (i) => Math.max(0, (i.sbp - 110) / 20),

    "Diabetes": (i) => (i.dm ? 1 : 0),
    "Current smoking": (i) => (i.smoke ? 1 : 0),

    "BMI <30, per 5 kg/m2": (i) => Math.max(0, (30 - (i.bmi ?? 30)) / 5),
    "BMI 30+, per 5 kg/m2": (i) => Math.max(0, (((i.bmi ?? 30) - 30)) / 5),

    "eGFR <60, per -15 ml": (i) => Math.max(0, (60 - i.egfr) / 15),
    "eGFR 60+, per -15 ml": (i) => Math.min(0, (60 - i.egfr) / 15),

    "Anti-hypertensive use": (i) => (i.antiHTN ? 1 : 0),
    "Statin use": (i) => (i.statin ? 1 : 0),

    "Treated SBP ≥110 mm Hg per 20 mm Hg": (i) => (i.antiHTN ? 1 : 0) * Math.max(0, (i.sbp - 110) / 20),
    "Treated non-HDL-C": (i) => (i.statin ? 1 : 0) * i.nonHdl_mmol,

    "Age per 10yr * non-HDL-C per 1 mmol/L": (i) => (i.age / 10) * i.nonHdl_mmol,
    "Age per 10yr * HDL-C per 1 mml/L": (i) => (i.age / 10) * i.hdl_mmol,
    "Age per 10yr * SBP ≥110 mm Hg per 20 mmHg": (i) => (i.age / 10) * Math.max(0, (i.sbp - 110) / 20),
    "Age per 10yr * diabetes": (i) => (i.age / 10) * (i.dm ? 1 : 0),
    "Age per 10yr * current smoking": (i) => (i.age / 10) * (i.smoke ? 1 : 0),
    "Age per 10yr * BMI 30+ per 5 kg/m2": (i) => (i.age / 10) * Math.max(0, (((i.bmi ?? 30) - 30)) / 5),
    "Age per 10yr * eGFR <60, per -15 ml": (i) => (i.age / 10) * Math.max(0, (60 - i.egfr) / 15),

    "SDI decile categories 4-6 vs. 1-3": (i) => (i.sdiDecile != null && i.sdiDecile >= 4 && i.sdiDecile <= 6) ? 1 : 0,
    "SDI decile categories 7-10 vs. 1-3": (i) => (i.sdiDecile != null && i.sdiDecile >= 7 && i.sdiDecile <= 10) ? 1 : 0,
    "Missing SDI": (i) => (i.sdiDecile == null ? 1 : 0),

    "ln-ACR, mg/g, per 1 ln unit": (i) => (i.acr == null ? 0 : Math.log(i.acr)),
    "Missing ACR/PCR/Dipstick": (i) => (i.acr == null ? 1 : 0),

    "HbA1c in DM, per 1%": (i) => (i.hba1c == null ? 0 : (i.dm ? i.hba1c : 0)),
    "HbA1c no DM, per 1%": (i) => (i.hba1c == null ? 0 : (!i.dm ? i.hba1c : 0)),
    "Missing HbA1c": (i) => (i.hba1c == null ? 1 : 0),

    "Constant": () => 1
  };

  function buildInputs() {
    const nonHdl = Number(document.querySelector("#nonhdl").value);
    const hdl = Number(document.querySelector("#hdl").value);

    const nonHdl_unit = document.querySelector("#nonhdl_unit").value;
    const hdl_unit = document.querySelector("#hdl_unit").value;

    const nonHdl_mmol = nonHdl_unit === "mgdl" ? nonHdl * CHOL_MGDL_TO_MMOL : nonHdl;
    const hdl_mmol    = hdl_unit === "mgdl" ? hdl * CHOL_MGDL_TO_MMOL : hdl;

    const bmiVal = document.querySelector("#bmi").value.trim();
    const acrVal = document.querySelector("#acr").value.trim();
    const hbVal  = document.querySelector("#hba1c").value.trim();
    const sdiVal = document.querySelector("#sdi").value.trim();

    return {
      age: Number(document.querySelector("#age").value),
      sbp: Number(document.querySelector("#sbp").value),
      egfr: Number(document.querySelector("#egfr").value),

      nonHdl_mmol,
      hdl_mmol,

      bmi: bmiVal ? Number(bmiVal) : null,
      acr: acrVal ? Number(acrVal) : null,
      hba1c: hbVal ? Number(hbVal) : null,
      sdiDecile: sdiVal ? Number(sdiVal) : null,

      dm: document.querySelector("#dm").checked,
      smoke: document.querySelector("#smoke").checked,
      antiHTN: document.querySelector("#antihtn").checked,
      statin: document.querySelector("#statin").checked
    };
  }

  function calcPreventOne(models, horizon, sex, outcome, inputs) {
    const modelKey = `${sex}_${outcome}`;
    const block = models[`full_${horizon}yr`];
    const betas = block?.[modelKey];
    if (!betas) throw new Error(`Modelo não encontrado: ${modelKey} em full_${horizon}yr`);

    let score = 0;
    for (const [term, betaRaw] of Object.entries(betas)) {
      const beta = Number(betaRaw);
      if (!Number.isFinite(beta) || beta === 0) continue;

      const fn = TERM_VALUE[term];
      if (!fn) throw new Error(`Termo sem regra no JS: ${term}`);

      score += beta * fn(inputs);
    }
    return logistic(score);
  }

  async function calc() {
    const status = document.querySelector("#status");
    status.textContent = "Carregando modelo…";

    const sex = document.querySelector("#sex").value;
    const outcome = document.querySelector("#outcome").value;
    const inputs = buildInputs();

    // checagens mínimas
    if (!Number.isFinite(inputs.age) || !Number.isFinite(inputs.sbp) || !Number.isFinite(inputs.egfr)
        || !Number.isFinite(inputs.nonHdl_mmol) || !Number.isFinite(inputs.hdl_mmol)) {
      status.textContent = "Preencha idade, PAS, eGFR, non-HDL e HDL.";
      return;
    }

    try {
      const models = await loadPreventModels();
      const r10 = calcPreventOne(models, 10, sex, outcome, inputs);
      const r30 = calcPreventOne(models, 30, sex, outcome, inputs);

      document.querySelector("#res10").textContent = (r10 * 100).toFixed(1) + "%";
      document.querySelector("#res30").textContent = (r30 * 100).toFixed(1) + "%";
      status.textContent = "OK";
    } catch (e) {
      console.error(e);
      status.textContent = "Erro: " + e.message;
    }
  }

  document.querySelector("#btnCalc").addEventListener("click", calc);
</script>
</body>
</html>
