<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UsoJaleco | Prescrições</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Manrope:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Google Identity Services (Login Google) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg:#070a10;
      --bg2:#06070c;

      --text:#e7ecf6;
      --muted:#97a5bb;

      --line: rgba(170,195,235,.12);
      --line2: rgba(170,195,235,.08);

      --shadowBig: 0 28px 90px rgba(0,0,0,.65);
      --shadowMid: 0 16px 50px rgba(0,0,0,.55);

      --rBig:26px;
      --rMid:22px;
      --rSm:18px;
      --rBtn:14px;

      --t: .18s ease;

      --padX: clamp(16px, 3.4vw, 24px);
      --gap: 18px;
      --gap2: 26px;

      --topH: 44px;

      --paperPad: 20mm;

      --pillOrange: #ff7a18;

      --brandLogoSize: 44px;
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 18% 18%, rgba(185,195,214,.10), transparent 60%),
        radial-gradient(980px 560px at 86% 22%, rgba(142,154,178,.08), transparent 62%),
        radial-gradient(980px 680px at 52% 92%, rgba(120,180,255,.06), transparent 65%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      background-attachment: fixed, fixed, fixed, fixed;
      overflow-x:hidden;
    }

    a{ color:inherit; text-decoration:none }
    button, input, textarea, select{ font:inherit }
    ::selection{ background:rgba(185,195,214,.25) }

    .wrap{
      width:100%;
      max-width:none;
      margin:0;
      padding: 18px var(--padX) 30px;
    }

    /* ===== Topbar ===== */
    .topbarShell{
      position: sticky;
      top: 0;
      z-index: 40;
      width: 100%;
      padding: 12px var(--padX) 0;
      pointer-events:none;
    }
    .topbarInner{
      width: 100%;
      max-width: none;
      margin: 0;
      pointer-events:auto;
    }
    .topbar{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 14px;
      border:1px solid var(--line);
      border-radius: var(--rBig);
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      box-shadow: var(--shadowBig);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 0;
      flex: 1 1 auto;
    }

    /* ===== Badge/Medalha da Logo ===== */
    .logoBadge{
      flex: 0 0 auto;
      padding: 7px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow:
        0 12px 30px rgba(0,0,0,.38),
        0 0 0 1px rgba(255,255,255,.06) inset;
      position: relative;
    }
    .logoBadge::before{
      content:"";
      position:absolute;
      inset:-30%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), transparent 55%);
      filter: blur(10px);
      opacity:.45;
      pointer-events:none;
    }
    .logoBadgeInner{
      width: var(--brandLogoSize);
      height: var(--brandLogoSize);
      border-radius: 14px;
      background:
        radial-gradient(120px 80px at 35% 30%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(8,10,16,.85), rgba(6,7,12,.92));
      border: 1px solid rgba(170,195,235,.14);
      box-shadow:
        0 10px 22px rgba(0,0,0,.55),
        0 0 0 1px rgba(255,255,255,.04) inset;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position: relative;
    }
    .logoBadgeInner::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.10), transparent 55%);
      opacity:.6;
      pointer-events:none;
    }
    .markImg{
      width: calc(var(--brandLogoSize) - 10px);
      height: calc(var(--brandLogoSize) - 10px);
      object-fit: contain;
      display:block;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.45));
      position: relative;
      z-index: 1;
    }

    .brandTxt{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand h1{
      margin:0;
      font-family: "DM Serif Display", serif;
      font-weight: 700;
      letter-spacing: .2px;
      font-size: 20px;
      line-height: 1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin:0;
      color: var(--muted);
      font-size: 12.8px;
      line-height: 1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 60ch;
    }

    .actions{
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 0 0 auto;
      max-width: 100%;
    }

    .btn{
      cursor:pointer;
      border-radius: var(--rBtn);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 0 12px;
      height: var(--topH);
      font-weight: 800;
      font-size: 13.5px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform var(--t), background var(--t), border-color var(--t), box-shadow var(--t);
      white-space: nowrap;
      user-select:none;
      max-width: 100%;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.045); border-color: rgba(255,255,255,.14); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    .btnPrimary{
      border-color: rgba(185,195,214,.35);
      background:
        radial-gradient(180px 40px at 30% 50%, rgba(185,195,214,.12), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 0 60px rgba(255,255,255,.06);
    }
    .btnPrimary:hover{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 1px rgba(255,255,255,.10), 0 0 72px rgba(255,255,255,.08);
    }

    .btnGhost{ background: transparent; border-color: var(--line2); }

    .userPill{
      display:inline-flex; align-items:center; gap:10px;
      height: var(--topH);
      padding: 0 10px;
      border-radius: var(--rBtn);
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      max-width: min(520px, 70vw);
      overflow:hidden;
    }
    .userPill img{
      width:26px; height:26px; border-radius:999px; object-fit:cover;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
      flex: 0 0 auto;
    }
    .userPill b{
      font-size: 12.8px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 26ch;
      line-height: 1.1;
    }
    .userPill small{
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 26ch;
      line-height: 1.1;
    }

    .iconBtn{
      cursor:pointer;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.02);
      padding: 9px 10px;
      color: var(--text);
      font-weight: 900;
      transition: transform var(--t), background var(--t), border-color var(--t), opacity var(--t);
      user-select:none;
      height: calc(var(--topH) - 10px);
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .iconBtn:hover{  background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.12); }
    .iconBtnDanger:hover{ border-color: rgba(255,80,80,.25); }
    .iconBtnDim{ opacity:.75; }
    .iconBtnDim:hover{ opacity:1; }

    /* ===== Main layout ===== */
    .main{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1fr;
      gap: var(--gap2);
      align-items:start;
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--rBig);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadowMid);
      position: relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40% -30% auto auto;
      width:420px; height:420px;
      background: radial-gradient(circle at 30% 30%, rgba(185,195,214,.14), transparent 60%);
      pointer-events:none;
      opacity:.55;
      filter: blur(2px);
    }
    .cardHeader{
      position:relative;
      padding: 16px 16px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid var(--line2);
    }
    .cardHeader h2{
      margin:0;
      font-family: "DM Serif Display", serif;
      font-size: 18px;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .cardHeader .sub{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 12.8px;
      line-height:1.25;
      max-width: 70ch;
    }
    .cardBody{ position:relative; padding: 16px; }

    .label{
      display:block;
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 750;
      margin: 0 0 6px;
      letter-spacing: .2px;
    }
    .field, .select{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 11px 12px;
      outline:none;
      transition: border-color var(--t), background var(--t), box-shadow var(--t);
    }
    .field:focus, .select:focus{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 1px rgba(255,255,255,.10), 0 0 50px rgba(255,255,255,.06);
      background: rgba(255,255,255,.04);
    }
    textarea.field{ min-height: 92px; resize: vertical; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid3eq{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; align-items:end; }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .divider{ height:1px; background: var(--line2); margin: 14px 0; }
    .mini{ font-size: 12.5px; color: var(--muted); line-height:1.2; }

    /* ===== Collapsible sections ===== */
    details.sec{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      overflow:hidden;
      margin-bottom: 12px;
    }
    details.sec > summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      user-select:none;
    }
    details.sec > summary::-webkit-details-marker{ display:none; }
    .secTitle{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width: 0;
    }
    .secTitle b{
      font-size: 13px;
      letter-spacing:.2px;
    }
    .secTitle small{
      color: var(--muted);
      font-size: 12.3px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 72vw;
    }
    .chev{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      color: var(--text);
      flex: 0 0 auto;
      transition: transform var(--t);
    }
    details[open] .chev{ transform: rotate(180deg); }
    .secBody{ padding: 0 12px 12px; }

    /* ===== Toggle ===== */
    .toggleRow{ display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .toggle{
      display:inline-flex; align-items:center; gap:10px;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.02);
      user-select:none;
    }
    .toggle input{ width:18px; height:18px; }
    .toggle span{ font-size: 12.8px; font-weight: 800; color: var(--text); }

    /* ===== Medicine blocks ===== */
    .rxBlocks{ display:flex; flex-direction:column; gap: 12px; }
    .rxBlock{
      border: 1px solid var(--line);
      border-radius: var(--rMid);
      background: linear-gradient(180deg, rgba(255,255,255,.032), rgba(255,255,255,.02));
      padding: 12px;
      position:relative;
      transition: transform var(--t), border-color var(--t), background var(--t);
    }
    .rxBlock:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }

    .rxTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .rxTitle{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex: 1;
    }
    .rxNum{
      width:28px; height:28px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 10px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.02);
      font-weight: 900;
      color: var(--text);
      flex: 0 0 auto;
    }
    .rxTitle strong{
      font-size: 13px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 58vw;
    }
    .rxTools{ display:flex; gap:8px; align-items:center; flex: 0 0 auto; }

    /* >>> 2 colunas (Nome + Quantidade/Apresentação) */
    .rxGrid{
      display:grid;
      grid-template-columns: 1.35fr .90fr;
      gap: 12px;
      align-items:start;
    }
    .rxFull{ margin-top:12px; }

    .rxBlock.collapsed .rxExpandedBody{ display:none; }
    .rxBlock.collapsed .rxTop{ margin-bottom:0; }

    /* Icon selectors */
    .iconPick{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .iconTag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12.3px;
      transition: transform var(--t), background var(--t), border-color var(--t), opacity var(--t);
    }
    .iconTag:hover{ transform: translateY(-1px); background: rgba(255,255,255,.035); border-color: rgba(255,255,255,.12); }
    .iconTag.on{
      border-color: rgba(255,255,255,.22);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 0 60px rgba(255,255,255,.05);
    }

    /* ===== Autocomplete / Results ===== */
    .acWrap{ position:relative; }
    .acList{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      background: rgba(12,14,20,.92);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadowMid);
      backdrop-filter: blur(10px);
      z-index: 50;
      overflow:hidden;
      display:none;
      max-height: 340px;
      overflow:auto;
    }
    .medItem{
      padding: 10px 12px;
      cursor:pointer;
      border-bottom: 1px solid rgba(170,195,235,.08);
      display:flex;
      gap: 12px;
      align-items:flex-start;
      transition: background var(--t);
    }
    .medItem:last-child{ border-bottom:none; }
    .medItem:hover{ background: rgba(255,255,255,.03); }
    .medDot{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      margin-top: 4px;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 0 2px rgba(0,0,0,.22) inset, 0 0 24px rgba(255,255,255,.06);
      flex: 0 0 auto;
      background: var(--pillOrange);
    }
    .medMain{ flex: 1 1 auto; min-width: 0; }
    .medTopRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .medA{
      font-weight: 900;
      font-size: 13.2px;
      color: #fff;
      letter-spacing: .15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64ch;
    }
    .medB{
      margin-top: 2px;
      font-style: italic;
      font-size: 12.2px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64ch;
    }
    .medTag{
      flex: 0 0 auto;
      font-size: 11px;
      font-weight: 900;
      color: var(--text);
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.03);
      padding: 4px 8px;
      border-radius: 999px;
      white-space:nowrap;
      max-width: 30ch;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .acEmpty{
      padding: 12px;
      color: var(--muted);
      font-size: 12.6px;
      line-height: 1.25;
    }

    /* ===== Preview / Paper ===== */
    .paperShell{ padding: 16px; }
    .paperHead{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .paperHeadRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .paperHeadLeft{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .paperHeadRight{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-left:auto;
    }

    .paperWrap{ display:flex; justify-content:center; }
    .paper{
      width: 100%;
      max-width: 760px;
      border-radius: 18px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      overflow:hidden;
      position:relative;
    }
    .paperInner{ padding: var(--paperPad); background:#fff; }
    .paperA4{ aspect-ratio: 210 / 297; }
    .paperLetter{ aspect-ratio: 8.5 / 11; }
    .paperA5{ aspect-ratio: 148 / 210; }
    .paperLegal{ aspect-ratio: 8.5 / 14; }

    .rxPaper{
      color:#000;
      line-height: 1.32;
      --rxFont: 13.2px;
      --rxFamily: "Times New Roman", Times, serif;
      font-family: var(--rxFamily);
      font-size: var(--rxFont);
      background:#fff;
    }

    .rxPaper .headerArea{
      position:relative;
      height: 78px;
      margin-bottom: 6px;
    }
    .rxPaper .footerArea{
      position:relative;
      height: 62px;
      margin-top: 10px;
    }

    /* ===== NOVO: Transform box p/ arrastar/redimensionar (prévia) ===== */
    .instImgBox{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%) translate(var(--tx, 0px), var(--ty, 0px)) scale(var(--sc, 1));
      transform-origin: center;
      user-select: none;
      touch-action: none;
      cursor: grab;
      z-index: 4;
      border-radius: 8px;
    }
    .instImgBox:active{ cursor: grabbing; }
    .instImgBox:hover{ outline: 1px dashed rgba(0,0,0,.28); outline-offset: 2px; }
    .instImgBox.active{ outline: 1px dashed rgba(0,0,0,.38); outline-offset: 2px; }
    .instImgBox .instImg{
      display:block;
      object-fit: contain;
      pointer-events:none;
      max-width: 92%;
      max-height: 74px;
    }
    .instImgBox.footer .instImg{ max-height: 58px; }

    /* Handle simples (canto inferior direito) — resize uniforme */
    .instHandle{
      position:absolute;
      right: -7px;
      bottom: -7px;
      width: 14px;
      height: 14px;
      border-radius: 5px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.28);
      box-shadow: 0 6px 16px rgba(0,0,0,.22);
      cursor: nwse-resize;
      touch-action:none;
    }
    .instImgBox:hover .instHandle{ opacity: 1; }
    .instHandle{ opacity: .92; }

    /* ===== Título central "RECEITA MÉDICA" ===== */
    .rxTitleCenter{
      margin: 2px 0 10px;
      text-align:center;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 900;
      letter-spacing: .6px;
      text-transform: uppercase;
      font-size: 17px;
      color:#111;
    }

    .rxMeta{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
    }

    /* >>> ALTERADO: "Nome:" em negrito e nome sem negrito + alinhamento com data */
    .rxPatientLine{
      font-weight: 400;
      font-size: 12.8px;
      letter-spacing:.15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 68ch;
      margin-top: 3px; /* desce o texto para alinhar com a caixinha da data */
    }
    .rxNameLabel{ font-weight: 900; }
    .rxNameValue{ font-weight: 400; }

    .rxPatientLine .docInline{
      font-weight: 800;
      opacity:.9;
      margin-left: 10px;
      white-space:nowrap;
    }
    .rxDatePill{
      flex: 0 0 auto;
      border-radius: 999px;
      background: #f1f1f1;
      color: #111;
      padding: 4px 10px;
      font-weight: 900;
      font-size: 12.1px;
      line-height: 1.2;
      border: 1px solid rgba(0,0,0,.10);
      white-space:nowrap;
    }
    .rxDividerLine{
      height:1px;
      background: #cfcfcf;
      margin: 10px 0 14px;
    }

    .rxSymbol{
      font-weight: 900;
      font-size: 16px;
      margin: 0 0 10px;
      font-family: var(--rxFamily);
    }

    .rxList{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-bottom: 14px;
      font-size: var(--rxFont);
      line-height: 1.34;
    }

/* ===== Linha do medicamento: Nome  ————  Quantidade (leader elástico) ===== */
.rxLine{
  display: grid;
  /* nome = fit-content (encolhe e quebra), leader = 1fr (pega o máximo), qty = auto */
  grid-template-columns: auto fit-content(100%) 1fr auto;

  /* aqui nasce o “espaço” real entre Nome | Traços | Quantidade */
  column-gap: .9ch;

  /* alinhamento padrão */
  align-items: baseline;
}

/* Se o browser suportar, alinha leader/qty com a ÚLTIMA linha do nome quando quebrar */
@supports (align-items: last baseline){
  .rxLine{ align-items: last baseline; }
}

/* Nº do item (tira a margem porque agora o gap resolve) */
.rxNo{
  font-weight: 900;
  letter-spacing: .1px;
  width: 20px;
  margin-right: 0;
}

/* Nome do medicamento (pode quebrar linha para “salvar” os traços) */
.drugName{
  font-weight: 800;
  letter-spacing: .15px;
  min-width: 0;
  white-space: normal;
  overflow-wrap: anywhere;   /* mais agressivo e estável p/ nomes longos */
}

/* Leader (traços) */
.leaderText{
  justify-self: stretch;
  overflow: hidden;
  white-space: nowrap;

  /* mínimo de 5 traços visíveis (se fosse ficar menor que isso, o nome quebra) */
  min-width: 5ch;

  /* tira o padding porque agora o espaço vem do column-gap */
  padding: 0;

  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size: 12px;
  letter-spacing: 0;        /* deixa os traços “colados”, sem espaçar */
  transform: translateY(-1px);
  color:#000;
}

.leaderText::before{
  content: "--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------";
}

/* Quantidade */
.qty{
  font-weight: 800;
  color:#000;
  min-width: 0;
  white-space: normal;
  overflow-wrap: anywhere;
}

    .rxInstr{
      margin-top: 4px;
      padding-left: 30px;
      color:#000;
      font-size: var(--rxFont);
      line-height: 1.28;
      word-break: break-word;
    }

    .useIconsBelow{
      margin-top: 6px;
      padding-left: 30px;
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      color:#000;
      font-size: 13px;
      transform: translateY(-1px);
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .useIconsBelow span{
      border:1px solid rgba(0,0,0,.14);
      border-radius: 999px;
      padding: 2px 8px;
      line-height: 1.2;
      font-weight: 900;
      background: #fff;
    }

    .sigWrap{
      margin-top: 6px;
      padding-top: 6px;
    }
    .docSig{
      display:inline-block;
      max-width: 100%;
      text-align:center;
      margin: 0 auto;
    }
    .sigLine{
      width: 100%;
      border-bottom: 1px solid #000;
      height: 24px;
      margin: 0 auto 8px;
    }
    .docCenter{
      text-align:center;
      font-size: 12.2px;
      line-height: 1.25;
      color:#000;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .docCenter .docName{ font-weight: 900; }
    .docCenter .docLine{ margin-top: 2px; }

    .instFooterGray{
      margin-top: 10px;
      text-align:center;
      color:#666;
      font-size: 11.6px;
      line-height: 1.25;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .gearBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.02);
      transition: transform var(--t), background var(--t), border-color var(--t);
      font-weight: 900;
      font-size: 12.8px;
      color: var(--text);
      white-space: nowrap;
      height: var(--topH);
    }
    .gearBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.12); }
    .gearBtn .gico{
      width:32px;height:32px;
      display:inline-flex;align-items:center;justify-content:center;
      border-radius: 12px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      font-size: 16px;
    }

    /* ===== Mobile ===== */
    .mobileTabs{
      display:none;
      margin-top: 14px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      border-radius: 999px;
      padding: 6px;
      gap: 6px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .tab{
      flex:1;
      text-align:center;
      padding: 10px 10px;
      border-radius: 999px;
      font-weight: 900;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      transition: background var(--t), color var(--t), box-shadow var(--t), border-color var(--t);
      border:1px solid transparent;
    }
    .tab.on{
      color: var(--text);
      border-color: rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 0 60px rgba(255,255,255,.06);
    }

    @media (max-width: 980px){
      .main{ grid-template-columns: 1fr; }
      .mobileTabs{ display:flex; }
      .paper{ max-width: 620px; }
    }

    @media (max-width: 520px){
      .brand p{ display:none; }
      .grid2{ grid-template-columns: 1fr; }
      .grid3eq{ grid-template-columns: 1fr; }
      .rxGrid{ grid-template-columns: 1fr; }
      .paperInner{ padding: 16mm; }
      .userPill{ max-width: 92vw; }
      .userPill b, .userPill small{ max-width: 22ch; }
      .gearBtn{ width: 100%; justify-content:space-between; }
      .rxTitleCenter{ font-size: 16px; }
      .drugName{ min-width: 160px; }
    }

    /* ===== Modal ===== */
    .modalMask{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 90;
    }
    .modal{
      width: min(900px, 96vw);
      border-radius: 22px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,18,26,.92), rgba(10,12,18,.92));
      box-shadow: var(--shadowBig);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--line2);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .modalHead b{ font-size: 14px; letter-spacing:.2px; }
    .modalBody{ padding: 14px; }
    .modalFoot{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--line2);
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .modalCard{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 12px;
    }

    /* ===== PRINT ===== */
    .printAll{ display:none; }
    @media print{
      body{ background:#fff !important; color:#000 !important; }
      .topbarShell, .mobileTabs, #panelEditor, #panelPreview, .modalMask{ display:none !important; }
      .wrap{ max-width:none; padding:0; }
      .printAll{ display:block !important; }
      @page { margin: 20mm; }

      /* não imprimir handles/outline */
      .instHandle{ display:none !important; }
      .instImgBox{ outline: none !important; cursor: default !important; }
    }
    /* === FIX: quebra de linha dos medicamentos NÃO centralizar === */
#preview .meds,
#preview .meds * ,
#preview .medList,
#preview .medList * ,
#preview .rx-meds,
#preview .rx-meds * {
  text-align: left !important;
}

/* Cada item/linha do medicamento ocupa 100% e quebra como texto normal */
#preview .medItem,
#preview .medLine,
#preview .rxMedLine,
#preview .rx-med-line {
  display: block;
  width: 100%;
  text-align: left !important;
  white-space: normal;          /* quebra automática normal */
  overflow-wrap: anywhere;      /* evita “estourar” com palavras longas */
  word-break: break-word;
}

/* Se alguma linha estiver como flex e estiver centralizando, força início */
#preview .medItem,
#preview .medLine,
#preview .rxMedLine,
#preview .rx-med-line {
  justify-content: flex-start !important;
  align-items: flex-start !important;
}
  
  </style>
</head>

<body>
  <div class="topbarShell">
    <div class="topbarInner">
      <div class="topbar">
        <div class="brand">
          <div class="logoBadge" aria-label="Logo">
            <div class="logoBadgeInner">
              <img id="brandMark" class="markImg" alt="Logo UsoJaleco" />
            </div>
          </div>

          <div class="brandTxt">
            <h1>UsoJaleco</h1>
            <p>Um jeito mais fácil de prescrever.</p>
          </div>
        </div>

        <div class="actions">
          <span class="userPill" id="userPill" style="display:none;">
            <img id="userPic" alt="" />
            <div style="display:flex;flex-direction:column;gap:2px;min-width:0;">
              <b id="userName">—</b>
              <small id="userEmail">—</small>
            </div>
            <button class="iconBtn iconBtnDanger" id="btnLogout" type="button" title="Sair">⎋</button>
          </span>

          <button class="btn btnGhost" id="btnLogin" type="button">Login</button>
          <button class="btn btnGhost" id="btnAddMed" type="button">+ Adicionar remédio</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap" id="appWrap">
    <div class="mobileTabs" aria-label="Alternar entre editor e prévia">
      <div class="tab on" id="tabEditor">Editar</div>
      <div class="tab" id="tabPreview">Prévia</div>
    </div>

    <div class="main" id="mainApp">
      <!-- ===== Editor ===== -->
      <div class="card panel" id="panelEditor">
        <div class="cardHeader">
          <div>
            <h2>Editor</h2>
            <p class="sub">Ao abrir, tudo começa retraído. Você expande só o que for usar.</p>
          </div>
        </div>

        <div class="cardBody">
          <!-- 1) Médico -->
          <details class="sec" id="secMedico">
            <summary>
              <div class="secTitle">
                <b>1. Informações do médico</b>
                <small id="sumMedico">—</small>
              </div>
              <div class="chev">˅</div>
            </summary>
            <div class="secBody">
              <div class="grid2">
                <div>
                  <label class="label" for="docTitle">Título</label>
                  <select class="select" id="docTitle">
                    <option value="Dr." selected>Doutor (Dr.)</option>
                    <option value="Dra.">Doutora (Dra.)</option>
                  </select>
                </div>
                <div>
                  <label class="label" for="docName">Nome do médico</label>
                  <input class="field" id="docName" placeholder="Nome completo…" autocomplete="name" />
                </div>
              </div>

              <div class="divider"></div>

              <div class="grid2">
                <div>
                  <label class="label">CRM(s)</label>
                  <div id="crmList"></div>
                  <div style="margin-top:10px">
                    <button class="btn btnGhost" id="btnAddCRM" type="button">+ Adicionar outro CRM</button>
                  </div>
                </div>

                <div>
                  <label class="label">RQE(s) (opcional)</label>
                  <div id="rqeList"></div>
                  <div style="margin-top:10px">
                    <button class="btn btnGhost" id="btnAddRQE" type="button">+ Adicionar outro RQE</button>
                  </div>
                </div>
              </div>

              <div class="divider"></div>
              <div class="mini" id="persistHint">Faça login para salvar os dados do médico “para sempre” nessa conta (e recarregar automaticamente no futuro).</div>
            </div>
          </details>

          <!-- 2) Paciente -->
          <details class="sec" id="secPaciente">
            <summary>
              <div class="secTitle">
                <b>2. Informações do paciente</b>
                <small id="sumPaciente">—</small>
              </div>
              <div class="chev">˅</div>
            </summary>
            <div class="secBody">
              <div class="grid2">
                <div>
                  <label class="label" for="patientName">Nome do paciente</label>
                  <input class="field" id="patientName" placeholder="Digite o nome do paciente…" autocomplete="name" />
                </div>

                <div>
                  <label class="label">Documento (opcional)</label>
                  <div class="grid2" style="gap:10px;">
                    <select class="select" id="patientDocType">
                      <option value="CPF" selected>CPF</option>
                      <option value="RG">RG</option>
                      <option value="CNS">CNS</option>
                    </select>
                    <input class="field" id="patientDocValue" placeholder="Digite o número…" inputmode="text" />
                  </div>
                </div>
              </div>
            </div>
          </details>

          <!-- 3) Medicamentos -->
          <details class="sec" id="secMeds">
            <summary>
              <div class="secTitle">
                <b>3. Medicamentos</b>
                <small id="sumMeds">—</small>
              </div>
              <div class="chev">˅</div>
            </summary>
            <div class="secBody">
              <div class="mini" id="dbStatus">Carregando base de medicamentos…</div>
              <div style="height:10px"></div>

              <div class="rxBlocks" id="rxBlocks"></div>

              <div class="divider"></div>

              <div class="row">
                <button class="btn btnGhost" id="btnAddMed2" type="button">+ Adicionar remédio</button>
                <button class="btn btnGhost" id="btnClear" type="button">Limpar tudo</button>
              </div>
            </div>
          </details>
        </div>
      </div>

      <!-- ===== Preview ===== -->
      <div class="card panel" id="panelPreview">
        <div class="cardHeader">
          <div>
            <h2>Prévia</h2>
            <p class="sub">Receita branca, margens seguras, R// obrigatório e lista numerada.</p>
          </div>

          <div style="display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; justify-content:flex-end;">
            <button class="gearBtn" id="btnOpenConfig" type="button" title="Configurar prescrição">
              <span style="opacity:.95;">Configure sua prescrição</span>
              <span class="gico">⚙️</span>
            </button>
          </div>
        </div>

        <div class="cardBody paperShell">
          <div class="paperHead">
            <div class="paperHeadRow">
              <div class="paperHeadLeft">
                <button class="btn btnPrimary" id="btnPrintOnly" type="button">Imprimir / PDF</button>
              </div>

              <div class="paperHeadRight">
                <div class="mini" id="pageInfo">Página 1 de 1</div>

                <div class="row" style="gap:8px; justify-content:flex-end;">
                  <button class="btn btnGhost" id="btnPrevPage" type="button">◀</button>
                  <select class="select" id="pageSelect" style="width: 160px;">
                    <option value="1" selected>Página 1</option>
                  </select>
                  <button class="btn btnGhost" id="btnNextPage" type="button">▶</button>
                </div>
              </div>
            </div>
          </div>

          <div class="paperWrap">
            <div class="paper paperA4" id="paper">
              <div class="paperInner">
                <div class="rxPaper" id="rxPaper"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="printAll" id="printAll"></div>
  </div>

  <!-- ===== Modal Login ===== -->
  <div class="modalMask" id="loginMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Login">
      <div class="modalHead">
        <div>
          <b>Login com Google</b>
          <div class="mini" style="margin-top:6px;">Ao logar, os dados do médico ficam associados à sua conta neste dispositivo.</div>
        </div>
        <button class="iconBtn iconBtnDanger" id="btnCloseLogin" type="button">✕</button>
      </div>
      <div class="modalBody">
        <div id="googleBtnMount"></div>
        <div class="mini" id="loginWarn" style="margin-top:10px; display:none;"></div>
      </div>
      <div class="modalFoot">
        <button class="btn btnGhost" id="btnCloseLogin2" type="button">Fechar</button>
      </div>
    </div>
  </div>

  <!-- ===== Modal Config ===== -->
  <div class="modalMask" id="configMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Configurar prescrição">
      <div class="modalHead">
        <div>
          <b>Configure sua prescrição</b>
          <div class="mini" style="margin-top:6px;">Tamanho, fonte, data, cabeçalho e rodapé.</div>
        </div>
        <button class="iconBtn iconBtnDanger" id="btnCloseConfig" type="button">✕</button>
      </div>

      <div class="modalBody">
        <div class="modalCard">
          <div class="grid2">
            <div>
              <label class="label" for="paperSize">Tamanho da folha</label>
              <select class="select" id="paperSize">
                <option value="A4" selected>A4</option>
                <option value="LETTER">Carta (Letter)</option>
                <option value="A5">A5</option>
                <option value="LEGAL">Legal</option>
              </select>
            </div>

            <div>
              <label class="label" for="rxFontFamily">Fonte</label>
              <select class="select" id="rxFontFamily">
                <option value="TIMES" selected>Times New Roman</option>
                <option value="CALIBRI">Calibri</option>
                <option value="ARIAL">Arial</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="grid3eq">
            <div>
              <label class="label" for="rxFontSize">Tamanho da fonte da prescrição</label>
              <input class="field" id="rxFontSize" placeholder="Ex: 13.2" inputmode="decimal" />
            </div>

            <div>
              <label class="label">Data</label>
              <div class="toggleRow" style="justify-content:flex-start;">
                <label class="toggle" title="Mostrar/ocultar a data na receita">
                  <input type="checkbox" id="includeDate" checked />
                  <span>Incluir</span>
                </label>
              </div>
            </div>

            <div>
              <label class="label" for="dateValue">Data (se ativada)</label>
              <input class="field" id="dateValue" placeholder="dd/mm/aaaa" inputmode="numeric" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid2">
            <div>
              <label class="label" for="headerUrl">Imagem de cabeçalho (URL)</label>
              <input class="field" id="headerUrl" placeholder="Cole a URL do cabeçalho (opcional)..." />
            </div>
            <div>
              <label class="label" for="footerUrl">Imagem de rodapé (URL)</label>
              <input class="field" id="footerUrl" placeholder="Cole a URL do rodapé (opcional)..." />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="grid2">
            <div>
              <img id="headerThumb" alt="" style="width:100%;height:56px;border-radius:14px;border:1px solid var(--line2);background:rgba(255,255,255,.02);object-fit:contain;padding:6px;" />
            </div>
            <div>
              <img id="footerThumb" alt="" style="width:100%;height:56px;border-radius:14px;border:1px solid var(--line2);background:rgba(255,255,255,.02);object-fit:contain;padding:6px;" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid2">
            <div>
              <label class="label" for="instName">Instituição de Saúde</label>
              <input class="field" id="instName" placeholder="Nome da instituição…" />
            </div>
            <div>
              <label class="label" for="instAddress">Endereço da Instituição (rodapé)</label>
              <input class="field" id="instAddress" placeholder="Rua, nº, bairro, cidade/UF, CEP" />
            </div>
          </div>

          <div class="divider"></div>
          <div class="mini">Dica: na prévia, você pode <b>arrastar</b> e <b>redimensionar</b> (sem deformar) as imagens do cabeçalho/rodapé diretamente no papel.</div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn btnGhost" id="btnResetConfig" type="button">Voltar ao padrão</button>
        <button class="btn btnPrimary" id="btnSaveConfig" type="button">Salvar</button>
        <button class="btn btnGhost" id="btnCloseConfig2" type="button">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    /************************************************************
     * CONFIG (TOPO) — Logo Badge
     ************************************************************/
    const LOGO_URL = "https://i.imgur.com/7LJtEBk.jpeg"; // <-- troque aqui
    const GOOGLE_CLIENT_ID = "703476878000-7h4lq2cbpffp3qp7hdn1hksi9k43qqm1.apps.googleusercontent.com";

    /************************************************************
     * GOOGLE SHEETS — CSV multi-abas
     ************************************************************/
    const SHEET_ID = "1es05SmJavEvGAK99kejsgy986T4kRJKw64wozSLTDRQ";

    // Array de abas/categorias (GIDs) atualizado
    const SHEET_TABS = [
      { gid: "915261507",  name: "Agentes antirreumáticos específicos" },
      { gid: "478511829",  name: "Agentes imunizantes" },
      { gid: "1411845420", name: "Alcalinizantes" },
      { gid: "395560222",  name: "Analgésicos-Antipiréticos" },
      { gid: "862085121",  name: "Anestésicos locais" },
      { gid: "20003638",   name: "Anti-Histamínicos H1" },
      { gid: "1822197995", name: "Anti-hemorroidários" },
      { gid: "1061659817", name: "Anti-infecciosos do trato gastrintestinal" },
      { gid: "1661597209", name: "Anti-infecciosos tópicos e relacionados" },
      { gid: "1954155192", name: "Antialcoólicos" },
      { gid: "1265384594", name: "Antialérgicos" },
      { gid: "563048962",  name: "Antiastênicos-Energéticos" },
      { gid: "827175960",  name: "Antibióticos" },
      { gid: "1098787868", name: "Agentes anti-inflamatórios não esteróides" },
      { gid: "1418395467", name: "Anticoncepcionais" },
      { gid: "2118860551", name: "Antidiabéticos" },
      { gid: "1848961101", name: "Antidiarreicos" },
      { gid: "388566765",  name: "Antieméticos" },
      { gid: "803029356",  name: "Antifiséticos (Antiflatulentos)" },
      { gid: "839735687",  name: "Antifúngicos" },
      { gid: "1604110756", name: "Antifúngicos tópicos" },
      { gid: "138405399",  name: "Antilipêmicos" },
      { gid: "1785559041", name: "Antineuríticos" },
      { gid: "1333824946", name: "Antissépticos" },
      { gid: "551218037",  name: "Antitussígenos" },
      { gid: "132076127",  name: "Antivaricosos" },
      { gid: "368598785",  name: "Antiácidos" },
      { gid: "1057228386", name: "Antídotos, agentes quelantes e outros" },
      { gid: "1424426563", name: "Broncodilatadores" },
      { gid: "258241824",  name: "Corticosteróides" },
      { gid: "1184992018", name: "Dissuasores de álcool" },
      { gid: "142814384",  name: "Diuréticos" },
      { gid: "1554213437", name: "Emolientes, demulcentes e protetores" },
      { gid: "2005343620", name: "Espasmolíticos" },
      { gid: "1203728329", name: "Expectorantes" },
      { gid: "542940365",  name: "Fornecedores de água e sais minerais" },
      { gid: "1781539542", name: "Anti-hipertensivos" },
      { gid: "1393215463", name: "Anti-inflamatórios locais" },
      { gid: "1927396219", name: "Antianêmicos" },
      { gid: "1077847451", name: "Fármacos antiarrítmicos" },
      { gid: "834788399",  name: "Antiobesidade" },
      { gid: "579731426",  name: "Antiprotozoários para distúrbios gastrintestinais" },
      { gid: "46875283",   name: "Antivertiginosos" },
      { gid: "37066094",   name: "Fármacos com outros usos terapêuticos" },
      { gid: "17226000",   name: "Coagulação sanguínea e hemostípticos" },
      { gid: "1946266019", name: "Fármacos para hiperparatireoidismo" },
      { gid: "1138414149", name: "Fármacos para hipotireoidismo" },
      { gid: "293362851",  name: "Fármacos para insuficiência cardíaca congestiva" },
      { gid: "264388654",  name: "Fármacos para o resfriado/gripe" },
      { gid: "1275257911", name: "Ansiolíticos" },
      { gid: "1253291853", name: "Antidepressivos" },
      { gid: "1803919161", name: "Antiepilépticos" },
      { gid: "920573383",  name: "Antipsicóticos" },
      { gid: "725911",     name: "Antidemência" },
      { gid: "329680812",  name: "Psicoestimulantes" },
      { gid: "2138352132", name: "Sedativos ansiolíticos" },
      { gid: "1736193150", name: "Sedativos hipnóticos" },
      { gid: "983295901",  name: "Fármacos que atuam no metabolismo do ácido úrico" },
      { gid: "382171978",  name: "Fármacos usados no tratamento da gota" },
      { gid: "400958663",  name: "Hipnoanalgésicos" },
      { gid: "1238735812", name: "Inibidores específicos da reabsorção óssea" },
      { gid: "1840608601", name: "Laxantes de contato" },
      { gid: "175034763",  name: "Medicamento Antroposófico" },
      { gid: "981256256",  name: "Medicamentos nasofaríngeos" },
      { gid: "675507405",  name: "Medicamentos otológicos" },
      { gid: "1413136239", name: "Medicamentos para distúrbios gastrointestinais funcionais" },
      { gid: "310730728",  name: "Miorrelaxantes" },
      { gid: "588781851",  name: "Outros analgésicos" },
      { gid: "235558101",  name: "Outros fármacos para constipação" },
      { gid: "1270044698", name: "Probiótico" },
      { gid: "655464895",  name: "Quimioterápicos/Antissépticos para o trato urinário" },
      { gid: "2102197488", name: "Sangue e frações do sangue" },
      { gid: "1176403748", name: "Tranquilizantes" },
      { gid: "897302584",  name: "Tratamento de doenças degenerativas e traumáticas das articulações" },
      { gid: "1272484250", name: "Tratamento de perda de massa óssea" },
      { gid: "326771482",  name: "lostáticos e Hansenostáticos" },
      { gid: "1783656678", name: "Uso Sistêmico" },
      { gid: "552279527",  name: "Vasoconstritores" },
      { gid: "225561128",  name: "Vitaminas" },
      { gid: "1285273334", name: "Agentes antibacterianos" }
    ];

    // Base consolidada global (requisito)
    let db_medicamentos = [];
    let db_loaded = false;
    let db_loading = false;
    const DEFAULT_DOT_COLOR = getComputedStyle(document.documentElement).getPropertyValue("--pillOrange").trim() || "#ff7a18";

    /************************************************************
     * STATE
     ************************************************************/
    const state = {
      user: null, // {email,name,picture,sub}

      docTitle: "Dr.",
      docName: "",
      crms: [""],
      rqes: [""],

      patientName: "",
      patientDocType: "CPF",
      patientDocValue: "",

      paperSize: "A4",
      includeDate: true,
      dateValue: "",
      rxFontSize: 13.2,
      rxFontFamily: "TIMES",

      headerImgUrl: "",
      footerImgUrl: "",
      instName: "",
      instAddress: "",

      // NOVO: transformações (prévia/print) — posição (px) e escala (uniforme)
      headerTransform: { x: 0, y: 0, scale: 1 },
      footerTransform: { x: 0, y: 0, scale: 1 },

      // dose foi removida do editor (o usuário pode digitar no próprio nome, se quiser)
      blocks: [], // {id,name,qty,qtyOptions,use,showIcons,icons,collapsed}

      selectedPage: 1
    };

    /************************************************************
     * Utils
     ************************************************************/
    const $ = (id)=>document.getElementById(id);

    const PLACEHOLDER_PNG =
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABJ0lEQVR4nO3aMQ6CMBQF0U8m0dQmGQm0mQkYQm0mQkYQm0mQkYQm0mQkYQm0mQkYQm0mQkYQm0mQkYQm0mQkYQk0v2k6yqk7+XyQm5mYd8yqf9gQAAAAAAAAAA4Gm9oQm2b3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQAAAAA8D8m8i8b8kq8wQAAAABJRU5ErkJggg==";

    function safeText(s){ return (s||"").toString().replace(/\s+/g," ").trim(); }
    function norm(s){
      return (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
    }
    function keyify(s){ return norm(s).toLowerCase(); }
    function uid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function todayBR(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    function rxFontPx(){
      const v = parseFloat(String(state.rxFontSize).replace(",", "."));
      if(!isFinite(v) || v <= 6) return 13.2;
      return clamp(v, 7.5, 18);
    }
    function rxFamilyCSS(){
      if(state.rxFontFamily === "ARIAL") return "Arial, Helvetica, sans-serif";
      if(state.rxFontFamily === "CALIBRI") return "Calibri, Arial, sans-serif";
      return "\"Times New Roman\", Times, serif";
    }

    function debounce(fn, ms){
      let t = null;
      return (...args)=>{
        clearTimeout(t);
        t = setTimeout(()=> fn(...args), ms);
      };
    }

    function leaderHyphens(){ return "-".repeat(220); }

    function getDefaultPageConfig(){
      return {
        paperSize: "A4",
        includeDate: true,
        dateValue: todayBR(),
        rxFontSize: 13.2,
        rxFontFamily: "TIMES",
        headerImgUrl: "",
        footerImgUrl: "",
        instName: "",
        instAddress: "",
        headerTransform: { x: 0, y: 0, scale: 1 },
        footerTransform: { x: 0, y: 0, scale: 1 }
      };
    }

    /************************************************************
     * Logo apply
     ************************************************************/
    function applyLogo(){
      const img = $("brandMark");
      img.src = LOGO_URL || PLACEHOLDER_PNG;
      const size = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--brandLogoSize")) || 44;
      document.documentElement.style.setProperty("--brandLogoSize", `${clamp(size, 32, 72)}px`);
    }

    /************************************************************
     * Local Storage (por conta)
     ************************************************************/
    function sessionKey(){ return "uj_rx_session_v3"; }
    function profileKey(email){ return `uj_rx_profile_v3__${(email||"").toLowerCase()}`; }

    function saveSession(){
      try{
        if(!state.user){ localStorage.removeItem(sessionKey()); return; }
        localStorage.setItem(sessionKey(), JSON.stringify(state.user));
      }catch(e){}
    }
    function loadSession(){
      try{
        const raw = localStorage.getItem(sessionKey());
        if(!raw) return null;
        const u = JSON.parse(raw);
        if(u && u.email) return u;
      }catch(e){}
      return null;
    }
    function saveProfile(){
      if(!state.user || !state.user.email) return;
      const payload = {
        docTitle: state.docTitle,
        docName: state.docName,
        crms: state.crms,
        rqes: state.rqes
      };
      try{
        localStorage.setItem(profileKey(state.user.email), JSON.stringify(payload));
        $("persistHint").textContent = "Salvo automaticamente nesta conta (alterações ficam registradas).";
      }catch(e){}
    }
    const saveProfileDebounced = debounce(saveProfile, 180);

    function loadProfile(){
      if(!state.user || !state.user.email) return null;
      try{
        const raw = localStorage.getItem(profileKey(state.user.email));
        if(!raw) return null;
        return JSON.parse(raw) || null;
      }catch(e){ return null; }
    }

    /************************************************************
     * Google Login (GIS)
     ************************************************************/
    function b64urlDecode(str){
      str = (str||"").replace(/-/g, "+").replace(/_/g, "/");
      const pad = str.length % 4;
      if(pad) str += "=".repeat(4 - pad);
      try{ return decodeURIComponent(escape(atob(str))); }catch(e){
        try{ return atob(str); }catch(e2){ return ""; }
      }
    }
    function parseJwt(token){
      const parts = (token||"").split(".");
      if(parts.length < 2) return null;
      try{
        const json = b64urlDecode(parts[1]);
        return JSON.parse(json);
      }catch(e){ return null; }
    }

    function openLogin(){
      $("loginMask").style.display = "flex";
      $("loginMask").setAttribute("aria-hidden","false");

      const warn = $("loginWarn");
      warn.style.display = "none";
      warn.textContent = "";

      if(!GOOGLE_CLIENT_ID){
        warn.style.display = "block";
        warn.textContent = "⚠️ Falta configurar o GOOGLE_CLIENT_ID no código (no topo do <script>).";
        $("googleBtnMount").innerHTML = "";
        return;
      }

      $("googleBtnMount").innerHTML = "";
      if(window.google && google.accounts && google.accounts.id){
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: (resp)=>{
            const payload = parseJwt(resp.credential);
            if(!payload || !payload.email){
              warn.style.display = "block";
              warn.textContent = "Não foi possível ler os dados da conta. Tente novamente.";
              return;
            }
            onLogged({
              email: payload.email,
              name: payload.name || payload.given_name || payload.email,
              picture: payload.picture || "",
              sub: payload.sub || ""
            });
            closeLogin();
          }
        });

        google.accounts.id.renderButton(
          $("googleBtnMount"),
          { theme: "outline", size: "large", shape: "pill", width: 360 }
        );
      }else{
        warn.style.display = "block";
        warn.textContent = "Carregando Google… se não aparecer, recarregue a página.";
      }
    }

    function closeLogin(){
      $("loginMask").style.display = "none";
      $("loginMask").setAttribute("aria-hidden","true");
    }

    function onLogged(user){
      state.user = user;
      saveSession();
      applyUserUI();

      const p = loadProfile();
      if(p){
        state.docTitle = (p.docTitle === "Dra.") ? "Dra." : "Dr.";
        state.docName = safeText(p.docName);
        state.crms = Array.isArray(p.crms) && p.crms.length ? p.crms.map(safeText) : [""];
        state.rqes = Array.isArray(p.rqes) && p.rqes.length ? p.rqes.map(safeText) : [""];
      }

      $("docTitle").value = state.docTitle;
      $("docName").value = state.docName;
      renderCrmList();
      renderRqeList();

      $("persistHint").textContent = "Logado — suas alterações do médico serão salvas automaticamente nesta conta.";
      updateSummaries();
      renderPaperDebounced();
    }

    function logout(){
      state.user = null;
      saveSession();
      applyUserUI();
      $("persistHint").textContent = "Faça login para salvar os dados do médico “para sempre” nessa conta (e recarregar automaticamente no futuro).";
    }

    function applyUserUI(){
      const has = !!(state.user && state.user.email);
      $("btnLogin").style.display = has ? "none" : "inline-flex";
      $("userPill").style.display = has ? "inline-flex" : "none";

      if(has){
        $("userName").textContent = state.user.name || "Conta Google";
        $("userEmail").textContent = state.user.email;
        $("userPic").src = state.user.picture || PLACEHOLDER_PNG;
      }
    }

    /************************************************************
     * CSV Parser (robusto p/ Google CSV)
     ************************************************************/
    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      const s = (text || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");
      for(let i=0;i<s.length;i++){
        const ch = s[i];

        if(inQuotes){
          if(ch === '"'){
            const next = s[i+1];
            if(next === '"'){ cur += '"'; i++; }
            else{ inQuotes = false; }
          }else{
            cur += ch;
          }
        }else{
          if(ch === '"'){ inQuotes = true; }
          else if(ch === ","){
            row.push(cur);
            cur = "";
          }else if(ch === "\n"){
            row.push(cur);
            rows.push(row);
            row = [];
            cur = "";
          }else{
            cur += ch;
          }
        }
      }
      row.push(cur);
      rows.push(row);

      // remove linhas totalmente vazias
      return rows.filter(r => r.some(c => safeText(c)));
    }

    function splitQty(s){
      const raw = safeText(s);
      if(!raw) return [];
      const arr = raw.split(";").map(x=> safeText(x)).filter(Boolean);
      // dedupe preservando ordem
      const seen = new Set();
      const out = [];
      for(const it of arr){
        const k = keyify(it);
        if(!k || seen.has(k)) continue;
        seen.add(k);
        out.push(it);
      }
      return out;
    }

    async function fetchCsvByGid(gid){
      const urls = [
        `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SHEET_ID)}/gviz/tq?tqx=out:csv&gid=${encodeURIComponent(gid)}`,
        `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SHEET_ID)}/export?format=csv&gid=${encodeURIComponent(gid)}`
      ];
      let lastErr = null;
      for(const url of urls){
        try{
          const res = await fetch(url, { cache:"no-store" });
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const txt = await res.text();
          if(!txt || txt.length < 3) throw new Error("CSV vazio");
          return txt;
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("Falha ao buscar CSV");
    }

    async function loadMedicamentosDB(){
      if(db_loading) return;
      db_loading = true;
      db_loaded = false;
      db_medicamentos = [];
      $("dbStatus").textContent = "Carregando base de medicamentos…";

      try{
        const allItems = [];
        for(const tab of SHEET_TABS){
          let csvText = "";
          try{
            csvText = await fetchCsvByGid(tab.gid);
          }catch(e){
            continue;
          }
          const rows = parseCSV(csvText);

          // heurística: pula cabeçalho se detectar
          let start = 0;
          if(rows.length){
            const h0 = keyify(rows[0]?.[0] || "");
            const h3 = keyify(rows[0]?.[3] || "");
            if(h0.includes("nome") || h0.includes("comercial") || h3.includes("generico")) start = 1;
          }

          for(let i=start;i<rows.length;i++){
            const r = rows[i] || [];
            const A = safeText(r[0] || "");
            const B = safeText(r[1] || "");
            const C = safeText(r[2] || "");
            const D = safeText(r[3] || "");
            const E = safeText(r[4] || "");

            // Sanitização: ignorar linhas onde A e D estão vazias
            if(!A && !D) continue;

            if(A){
              allItems.push({
                type: "A",
                main: A,            // Nome Comercial 1
                sub: B,             // Nome Genérico 1
                qty: splitQty(C),   // Quantidade 1
                categoria: tab.name || `Aba ${tab.gid}`
              });
            }
            if(D){
              allItems.push({
                type: "B",
                main: D,            // Nome Genérico 2
                sub: "",
                qty: splitQty(E),   // Quantidade 2
                categoria: tab.name || `Aba ${tab.gid}`
              });
            }
          }
        }

        // Deduplicação + normalização + índices de busca
        const map = new Map();
        for(const it of allItems){
          const k = `${it.type}|${keyify(it.main)}|${keyify(it.sub || "")}`;
          if(!map.has(k)){
            map.set(k, {
              type: it.type,
              main: it.main,
              sub: it.sub || "",
              qty: Array.isArray(it.qty) ? it.qty.slice() : [],
              categorias: it.categoria ? [it.categoria] : [],
              color: DEFAULT_DOT_COLOR
            });
          }else{
            const cur = map.get(k);
            if(it.categoria && !cur.categorias.includes(it.categoria)) cur.categorias.push(it.categoria);
            if(Array.isArray(it.qty)){
              const seen = new Set(cur.qty.map(x=> keyify(x)));
              for(const q of it.qty){
                const kk = keyify(q);
                if(!kk || seen.has(kk)) continue;
                seen.add(kk);
                cur.qty.push(q);
              }
            }
          }
        }

        db_medicamentos = Array.from(map.values()).map(x=>{
          const catLabel = x.categorias?.length ? x.categorias[0] : "—";
          return {
            type: x.type,
            main: x.main,
            sub: x.sub,
            qty: x.qty || [],
            categorias: x.categorias || [],
            catLabel,
            color: x.color || DEFAULT_DOT_COLOR,
            // busca universal contra (Col A, Col B, Col D) => aqui já normalizado por item
            search: keyify([x.main, x.sub, (x.categorias||[]).join(" ")].join(" ")),
            mainKey: keyify(x.main),
            subKey: keyify(x.sub || "")
          };
        });

        // Ordenação base (alfabética)
        db_medicamentos.sort((p,q)=> (p.main||"").localeCompare((q.main||""), "pt-BR", { sensitivity:"base" }));

        db_loaded = true;
        $("dbStatus").textContent = `Base carregada: ${db_medicamentos.length} itens.`;
      }catch(e){
        db_loaded = false;
        db_medicamentos = [];
        $("dbStatus").textContent = "Falha ao carregar base. Você ainda pode digitar manualmente.";
      }finally{
        db_loading = false;
      }
    }

    /************************************************************
     * CRM/RQE lists
     ************************************************************/
    function buildLineRow(type, idx){
      const row = document.createElement("div");
      row.className = "row";
      row.style.alignItems = "center";
      row.style.justifyContent = "stretch";
      row.style.gap = "8px";
      row.style.marginBottom = "8px";

      const input = document.createElement("input");
      input.className = "field";
      input.placeholder = type === "crm"
        ? (idx===0 ? "CRM (ex: CRM-BA 12345)" : `CRM ${idx+1}`)
        : (idx===0 ? "RQE (ex: RQE 9876)" : `RQE ${idx+1}`);
      input.inputMode = "text";
      input.autocomplete = "off";
      input.spellcheck = false;

      input.value = (type==="crm" ? state.crms[idx] : state.rqes[idx]) || "";

      input.addEventListener("input", ()=>{
        const v = safeText(input.value);
        if(type==="crm") state.crms[idx] = v;
        else state.rqes[idx] = v;

        updateSummaries();
        renderPaperDebounced();
        saveProfileDebounced();
      });

      const del = document.createElement("button");
      del.className = "iconBtn iconBtnDanger";
      del.type = "button";
      del.textContent = "✕";
      del.title = "Remover";
      const arr = (type==="crm") ? state.crms : state.rqes;
      del.disabled = arr.length === 1;
      del.style.opacity = (arr.length === 1) ? .45 : 1;

      del.addEventListener("click", ()=>{
        const arr2 = (type==="crm") ? state.crms : state.rqes;
        if(arr2.length === 1) return;
        arr2.splice(idx, 1);
        if(type==="crm") renderCrmList(); else renderRqeList();
        updateSummaries();
        renderPaperDebounced();
        saveProfileDebounced();
      });

      row.appendChild(input);
      row.appendChild(del);
      return row;
    }

    function renderCrmList(){
      const box = $("crmList");
      box.innerHTML = "";
      state.crms.forEach((_, idx)=> box.appendChild(buildLineRow("crm", idx)));
    }
    function renderRqeList(){
      const box = $("rqeList");
      box.innerHTML = "";
      state.rqes.forEach((_, idx)=> box.appendChild(buildLineRow("rqe", idx)));
    }

    /************************************************************
     * Med blocks + Autocomplete
     ************************************************************/
    const ICON_LIBRARY = [
      { key:"MANHA", label:"Manhã", ico:"☀️" },
      { key:"TARDE", label:"Tarde", ico:"🌤️" },
      { key:"NOITE", label:"Noite", ico:"🌙" },
      { key:"JEJUM", label:"Jejum", ico:"☕" },
      { key:"ANTES", label:"Antes refeição", ico:"🍽️" },
      { key:"APOS", label:"Após refeição", ico:"✅" },
      { key:"8H", label:"8/8h", ico:"⏱️" },
      { key:"12H", label:"12/12h", ico:"⏱️" }
    ];

    function addBlock({focusName=true} = {}){
      state.blocks.forEach(b=> b.collapsed = true);

      const b = {
        id: uid(),
        name:"",
        qty:"",
        qtyOptions: [],
        use:"",
        collapsed:false,
        showIcons:true,
        icons:[]
      };
      state.blocks.push(b);

      appendBlockDOM(b, state.blocks.length-1);
      updateSummaries();
      renderPaperDebounced();

      if(focusName){
        setTimeout(()=>{
          const el = document.querySelector(`[data-block="${b.id}"] input[data-field="name"]`);
          if(el) el.focus({ preventScroll:true });
        }, 0);
      }
    }

    function removeBlock(id){
      const idx = state.blocks.findIndex(x=> x.id === id);
      if(idx < 0) return;
      state.blocks.splice(idx,1);

      const el = document.querySelector(`[data-block="${id}"]`);
      if(el) el.remove();

      renumberBlocks();

      if(state.blocks.length && !state.blocks.some(b=> !b.collapsed)){
        state.blocks[state.blocks.length-1].collapsed = false;
        const lastEl = document.querySelector(`[data-block="${state.blocks[state.blocks.length-1].id}"]`);
        if(lastEl) lastEl.classList.remove("collapsed");
      }

      updateSummaries();
      renderPaperDebounced();
    }

    function toggleBlock(id){
      const b = state.blocks.find(x=> x.id === id);
      const el = document.querySelector(`[data-block="${id}"]`);
      if(!b || !el) return;
      b.collapsed = !b.collapsed;
      el.classList.toggle("collapsed", !!b.collapsed);
    }

    function renumberBlocks(){
      const nodes = document.querySelectorAll(".rxBlock");
      nodes.forEach((node, i)=>{
        const num = node.querySelector(".rxNum");
        if(num) num.textContent = String(i+1);

        const bid = node.getAttribute("data-block");
        const b = state.blocks.find(x=> x.id === bid);
        const title = node.querySelector(".rxTitle strong");
        if(title){
          const nm = (b && safeText(b.name)) ? safeText(b.name) : `Remédio ${i+1}`;
          title.textContent = nm;
        }
      });
    }

    function renderBlocksInitial(){
      const root = $("rxBlocks");
      root.innerHTML = "";
      state.blocks.forEach((b, idx)=> appendBlockDOM(b, idx));
      renumberBlocks();
    }

    function computeHits(q){
      const hits = [];
      if(!db_loaded) return hits;

      const query = keyify(q);
      const max = query ? 18 : 12;

      const candidates = [];
      for(const it of db_medicamentos){
        if(!query){
          candidates.push({ it, score: 999 });
          continue;
        }
        if(it.search && it.search.includes(query)){
          const s = scoreItem(it, query);
          candidates.push({ it, score: s });
        }
      }

      if(!query){
        for(let i=0;i<db_medicamentos.length && hits.length<max;i++){
          hits.push(db_medicamentos[i]);
        }
        return hits;
      }

      candidates.sort((a,b)=>{
        if(a.score !== b.score) return a.score - b.score;
        return (a.it.main||"").localeCompare((b.it.main||""), "pt-BR", { sensitivity:"base" });
      });

      for(const c of candidates){
        hits.push(c.it);
        if(hits.length >= max) break;
      }
      return hits;
    }

    function scoreItem(it, q){
      const main = it.mainKey || "";
      const sub = it.subKey || "";
      if(main.startsWith(q)) return 0;
      if(it.type === "A" && sub && sub.startsWith(q)) return 1;

      const im = main.indexOf(q);
      let best = im >= 0 ? 2 + (im/100) : 999;

      if(it.type === "A"){
        const is = sub.indexOf(q);
        if(is >= 0) best = Math.min(best, 3 + (is/100));
      }
      return best;
    }

    function renderHits(acList, hits, q){
      acList.innerHTML = "";

      if(!hits.length){
        const d = document.createElement("div");
        d.className = "acEmpty";
        d.textContent = q
          ? "Nenhum resultado. Continue digitando ou insira manualmente."
          : (db_loading ? "Carregando planilha…" : "Digite para buscar em toda a base (todas as abas).");
        acList.appendChild(d);
        acList.style.display = "block";
        return;
      }

      for(const it of hits){
        const item = document.createElement("div");
        item.className = "medItem";

        const dot = document.createElement("div");
        dot.className = "medDot";
        dot.style.background = it.color || DEFAULT_DOT_COLOR;

        const main = document.createElement("div");
        main.className = "medMain";

        const topRow = document.createElement("div");
        topRow.className = "medTopRow";

        const txtBox = document.createElement("div");
        txtBox.style.minWidth = "0";

        const lineA = document.createElement("div");
        lineA.className = "medA";

        const lineB = document.createElement("div");
        lineB.className = "medB";

        if(it.type === "A"){
          lineA.textContent = it.main || "—";
          lineB.textContent = it.sub ? it.sub : "—";
          lineB.style.display = "block";
        }else{
          lineA.textContent = it.main || "—";
          lineB.textContent = "";
          lineB.style.display = "none";
        }

        txtBox.appendChild(lineA);
        txtBox.appendChild(lineB);

        const tag = document.createElement("div");
        tag.className = "medTag";
        tag.textContent = it.catLabel || "—";

        topRow.appendChild(txtBox);
        topRow.appendChild(tag);

        main.appendChild(topRow);

        item.appendChild(dot);
        item.appendChild(main);

        acList.appendChild(item);
      }

      acList.style.display = "block";
    }

    function appendBlockDOM(b, idx){
      const root = $("rxBlocks");

      const wrap = document.createElement("div");
      wrap.className = "rxBlock" + (b.collapsed ? " collapsed" : "");
      wrap.setAttribute("data-block", b.id);

      const top = document.createElement("div");
      top.className = "rxTop";

      const title = document.createElement("div");
      title.className = "rxTitle";

      const num = document.createElement("div");
      num.className = "rxNum";
      num.textContent = String(idx+1);

      const tcol = document.createElement("div");
      tcol.style.display = "flex";
      tcol.style.flexDirection = "column";
      tcol.style.gap = "2px";

      const strong = document.createElement("strong");
      strong.textContent = b.name ? b.name : `Remédio ${idx+1}`;

      const small = document.createElement("div");
      small.className = "mini";
      small.style.marginTop = "0";
      small.style.color = "var(--muted)";
      small.textContent = b.collapsed ? "Clique para expandir e editar" : "Edite nome, quantidade e ícones";

      tcol.appendChild(strong);
      tcol.appendChild(small);

      title.appendChild(num);
      title.appendChild(tcol);

      const tools = document.createElement("div");
      tools.className = "rxTools";

      const btnMin = document.createElement("button");
      btnMin.className = "iconBtn iconBtnDim";
      btnMin.type = "button";
      btnMin.title = b.collapsed ? "Expandir" : "Minimizar";
      btnMin.textContent = b.collapsed ? "▾" : "▴";
      btnMin.addEventListener("click", ()=>{
        toggleBlock(b.id);
        btnMin.textContent = (b.collapsed ? "▾" : "▴");
        btnMin.title = (b.collapsed ? "Expandir" : "Minimizar");
      });

      const btnDel = document.createElement("button");
      btnDel.className = "iconBtn iconBtnDanger";
      btnDel.type = "button";
      btnDel.title = "Remover";
      btnDel.textContent = "✕";
      btnDel.addEventListener("click", ()=> removeBlock(b.id));

      tools.appendChild(btnMin);
      tools.appendChild(btnDel);

      top.appendChild(title);
      top.appendChild(tools);

      const body = document.createElement("div");
      body.className = "rxExpandedBody";

      const grid = document.createElement("div");
      grid.className = "rxGrid";

      // ===== Nome + autocomplete universal
      const col1 = document.createElement("div");
      const lab1 = document.createElement("label");
      lab1.className = "label";
      lab1.textContent = "Nome do medicamento (busca universal)";
      col1.appendChild(lab1);

      const acWrap = document.createElement("div");
      acWrap.className = "acWrap";

      const inpName = document.createElement("input");
      inpName.className = "field";
      inpName.placeholder = "Digite para buscar (Comercial/Genérico)…";
      inpName.value = b.name || "";
      inpName.setAttribute("data-field","name");
      inpName.autocomplete = "off";
      inpName.spellcheck = false;
      inpName.inputMode = "text";

      const acList = document.createElement("div");
      acList.className = "acList";

      let lastHits = [];

      function closeList(){
        acList.style.display = "none";
        acList.innerHTML = "";
      }
      function openList(){ acList.style.display = "block"; }

      // ===== Quantidade/Apresentação (input com sugestões da planilha)
      const colQty = document.createElement("div");
      const labQty = document.createElement("label");
      labQty.className = "label";
      labQty.textContent = "Quantidade / Apresentação";
      colQty.appendChild(labQty);

      const inpQty = document.createElement("input");
      inpQty.className = "field";
      inpQty.placeholder = "Digite (ou selecione uma opção)…";
      inpQty.value = b.qty || "";
      inpQty.setAttribute("data-field","qty");
      inpQty.autocomplete = "off";
      inpQty.spellcheck = false;
      inpQty.inputMode = "text";

      const dl = document.createElement("datalist");
      dl.id = `dlQty_${b.id}`;
      dl.setAttribute("data-field","qtyList");
      inpQty.setAttribute("list", dl.id);

      inpQty.addEventListener("input", ()=>{
        b.qty = safeText(inpQty.value);
        renderPaperDebounced();
      });

      colQty.appendChild(inpQty);
      colQty.appendChild(dl);

      function syncQtyUI(){
        const listEl = wrap.querySelector(`datalist[data-field="qtyList"]`);
        if(!listEl) return;

        const opts = Array.isArray(b.qtyOptions) ? b.qtyOptions : [];
        listEl.innerHTML = "";
        for(const q of opts){
          const o = document.createElement("option");
          o.value = q;
          listEl.appendChild(o);
        }
      }

      function applyChoice(it){
        const txt = safeText(it.main);
        b.name = txt;
        inpName.value = txt;

        // opções de Quantidade / Apresentação vindas da planilha (coluna à direita)
        b.qtyOptions = Array.isArray(it.qty) ? it.qty.slice() : [];
        syncQtyUI();

        const nm = txt ? txt : `Remédio ${idx+1}`;
        strong.textContent = nm;

        closeList();
        renderPaperDebounced();
        updateSummaries();
      }

      // clique por item
      acList.addEventListener("mousedown", (ev)=>{
        const itemEl = ev.target.closest(".medItem");
        if(!itemEl) return;
        ev.preventDefault();
        const idxHit = Array.prototype.indexOf.call(acList.children, itemEl);
        const it = lastHits[idxHit];
        if(it) applyChoice(it);
      });

      inpName.addEventListener("input", ()=>{
        b.name = safeText(inpName.value);

        const nm = b.name ? b.name : `Remédio ${idx+1}`;
        strong.textContent = nm;

        renderPaperDebounced();
        updateSummaries();

        const q = safeText(inpName.value);

        if(db_loading){
          acList.innerHTML = `<div class="acEmpty">Carregando planilha…</div>`;
          openList();
          return;
        }
        if(!db_loaded){
          closeList();
          return;
        }

        const hits = computeHits(q);
        lastHits = hits;
        renderHits(acList, hits, q);
      });

      inpName.addEventListener("focus", ()=>{
        if(db_loading){
          acList.innerHTML = `<div class="acEmpty">Carregando planilha…</div>`;
          openList();
          return;
        }
        if(db_loaded){
          const q = safeText(inpName.value);
          const hits = computeHits(q);
          lastHits = hits;
          renderHits(acList, hits, q);
        }
      });

      inpName.addEventListener("blur", ()=> setTimeout(closeList, 160));

      acWrap.appendChild(inpName);
      acWrap.appendChild(acList);
      col1.appendChild(acWrap);

      grid.appendChild(col1);
      grid.appendChild(colQty);

      body.appendChild(grid);

      // Posologia
      const full = document.createElement("div");
      full.className = "rxFull";
      const lab3 = document.createElement("label");
      lab3.className = "label";
      lab3.textContent = "Posologia / Orientações";

      const ta = document.createElement("textarea");
      ta.className = "field";
      ta.placeholder = "Ex: Tomar 1 comprimido pela manhã por 30 dias.";
      ta.value = b.use || "";
      ta.autocomplete = "off";
      ta.spellcheck = true;
      ta.addEventListener("input", ()=>{
        b.use = safeText(ta.value);
        renderPaperDebounced();
      });

      full.appendChild(lab3);
      full.appendChild(ta);
      body.appendChild(full);

      // Ícones
      const iconTools = document.createElement("div");
      iconTools.className = "rxFull";

      const iconRow = document.createElement("div");
      iconRow.className = "row";
      iconRow.style.justifyContent = "space-between";
      iconRow.style.gap = "10px";

      const labIcons = document.createElement("label");
      labIcons.className = "label";
      labIcons.textContent = "Ícones (horário/rotina) — para facilitar a compreensão";
      labIcons.style.margin = "0";

      const togIcons = document.createElement("label");
      togIcons.className = "toggle";
      togIcons.title = "Mostrar/ocultar ícones na receita";
      togIcons.innerHTML = `<input type="checkbox"><span>Mostrar ícones</span>`;
      const iconsCheck = togIcons.querySelector("input");
      iconsCheck.checked = (b.showIcons !== false);
      iconsCheck.addEventListener("change", ()=>{
        b.showIcons = !!iconsCheck.checked;
        renderPaperDebounced();
      });

      iconRow.appendChild(labIcons);
      iconRow.appendChild(togIcons);

      const iconPick = document.createElement("div");
      iconPick.className = "iconPick";

      function isOn(k){ return Array.isArray(b.icons) && b.icons.includes(k); }
      function toggleIcon(k){
        b.icons = Array.isArray(b.icons) ? b.icons : [];
        if(b.icons.includes(k)) b.icons = b.icons.filter(x=> x !== k);
        else b.icons.push(k);
        renderIconButtons();
        renderPaperDebounced();
      }

      function renderIconButtons(){
        iconPick.innerHTML = "";
        for(const it of ICON_LIBRARY){
          const pill = document.createElement("div");
          pill.className = "iconTag" + (isOn(it.key) ? " on" : "");
          pill.innerHTML = `<span style="font-size:14px">${it.ico}</span><span>${it.label}</span>`;
          pill.addEventListener("click", ()=> toggleIcon(it.key));
          iconPick.appendChild(pill);
        }
      }
      renderIconButtons();

      iconTools.appendChild(iconRow);
      iconTools.appendChild(iconPick);
      body.appendChild(iconTools);

      wrap.appendChild(top);
      wrap.appendChild(body);
      root.appendChild(wrap);

      // inicializa datalist (se já houver opções)
      b.qtyOptions = Array.isArray(b.qtyOptions) ? b.qtyOptions : [];
      syncQtyUI();
    }

    /************************************************************
     * Summaries
     ************************************************************/
    function updateSummaries(){
      // médico
      const docNm = safeText(state.docName);
      const crm = state.crms.map(safeText).filter(Boolean).slice(0,2);
      const rqe = state.rqes.map(safeText).filter(Boolean).slice(0,2);
      const parts = [];
      if(docNm) parts.push(`${state.docTitle} ${docNm}`);
      if(crm.length) parts.push(`CRM: ${crm.join(" · ")}`);
      if(rqe.length) parts.push(`RQE: ${rqe.join(" · ")}`);
      $("sumMedico").textContent = parts.length ? parts.join("  |  ") : "—";

      // paciente
      const pn = safeText(state.patientName);
      const dt = safeText(state.patientDocType);
      const dv = safeText(state.patientDocValue);
      const p2 = [];
      if(pn) p2.push(pn);
      if(dv) p2.push(`${dt}: ${dv}`);
      $("sumPaciente").textContent = p2.length ? p2.join("  |  ") : "—";

      // meds
      const count = state.blocks.length;
      const named = state.blocks.filter(b => safeText(b.name)).length;
      $("sumMeds").textContent = count ? `${count} item(ns) · ${named} preenchido(s)` : "—";
    }

    /************************************************************
     * Pagination
     ************************************************************/
    function medsPerPage(){
      const px = rxFontPx();
      if(px <= 9.1) return 12;
      if(px <= 9.7) return 11;
      if(px <= 10.3) return 10;
      if(px <= 10.9) return 9;
      if(px <= 11.5) return 9;
      if(px <= 12.4) return 8;
      if(px <= 13.0) return 7;
      return 6;
    }
    function paginateBlocks(){
      const per = medsPerPage();
      const pages = [];
      let cur = [];
      state.blocks.forEach(b=>{
        cur.push(b);
        if(cur.length >= per){
          pages.push(cur);
          cur = [];
        }
      });
      if(cur.length || pages.length===0) pages.push(cur);
      return pages;
    }

    function syncPageUI(pages){
      const total = pages.length;
      state.selectedPage = clamp(state.selectedPage, 1, total);

      $("pageInfo").textContent = `Página ${state.selectedPage} de ${total}`;

      const sel = $("pageSelect");
      sel.innerHTML = "";
      for(let i=1;i<=total;i++){
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `Página ${i}`;
        if(i === state.selectedPage) opt.selected = true;
        sel.appendChild(opt);
      }

      const paper = $("paper");
      paper.classList.remove("paperA4","paperLetter","paperA5","paperLegal");
      if(state.paperSize === "LETTER") paper.classList.add("paperLetter");
      else if(state.paperSize === "A5") paper.classList.add("paperA5");
      else if(state.paperSize === "LEGAL") paper.classList.add("paperLegal");
      else paper.classList.add("paperA4");
    }

    /************************************************************
     * Header/Footer Transform Controls (drag + resize uniforme)
     ************************************************************/
    let instDragCtx = null;

    function getTransform(role){
      const t = (role==="footer") ? state.footerTransform : state.headerTransform;
      return {
        x: isFinite(+t?.x) ? +t.x : 0,
        y: isFinite(+t?.y) ? +t.y : 0,
        scale: isFinite(+t?.scale) ? +t.scale : 1
      };
    }
    function setTransform(role, t){
      const next = { x: +t.x || 0, y: +t.y || 0, scale: +t.scale || 1 };
      if(role==="footer") state.footerTransform = next;
      else state.headerTransform = next;
    }
    function applyBoxTransformVars(box, t){
      box.style.setProperty("--tx", `${t.x}px`);
      box.style.setProperty("--ty", `${t.y}px`);
      box.style.setProperty("--sc", `${t.scale}`);
    }

    function bindInstTransformControls(){
      const boxes = document.querySelectorAll("#rxPaper .instImgBox");
      boxes.forEach(box=>{
        const role = box.getAttribute("data-role") || "header";
        const t = getTransform(role);
        applyBoxTransformVars(box, t);

        // Move (arrastar)
        box.addEventListener("pointerdown", (ev)=>{
          if(ev.button !== 0) return;
          if(ev.target && ev.target.classList && ev.target.classList.contains("instHandle")) return;
          ev.preventDefault();

          const tt = getTransform(role);
          instDragCtx = {
            mode: "move",
            role,
            box,
            pid: ev.pointerId,
            sx: ev.clientX,
            sy: ev.clientY,
            ox: tt.x,
            oy: tt.y
          };

          box.classList.add("active");
          try{ box.setPointerCapture(ev.pointerId); }catch(e){}
        });

        // Resize (handle)
        const handle = box.querySelector(".instHandle");
        if(handle){
          handle.addEventListener("pointerdown", (ev)=>{
            if(ev.button !== 0) return;
            ev.preventDefault();

            const rect = box.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;

            const tt = getTransform(role);
            const startDist = Math.max(1, Math.hypot(ev.clientX - cx, ev.clientY - cy));

            instDragCtx = {
              mode: "resize",
              role,
              box,
              pid: ev.pointerId,
              cx, cy,
              startDist,
              os: tt.scale
            };

            box.classList.add("active");
            try{ handle.setPointerCapture(ev.pointerId); }catch(e){}
          });
        }
      });
    }

    function ensureGlobalPointerHandlers(){
      if(ensureGlobalPointerHandlers._done) return;
      ensureGlobalPointerHandlers._done = true;

      window.addEventListener("pointermove", (ev)=>{
        if(!instDragCtx) return;
        if(ev.pointerId !== instDragCtx.pid) return;

        const role = instDragCtx.role;
        const cur = getTransform(role);

        if(instDragCtx.mode === "move"){
          const dx = ev.clientX - instDragCtx.sx;
          const dy = ev.clientY - instDragCtx.sy;

          const nx = clamp(instDragCtx.ox + dx, -600, 600);
          const ny = clamp(instDragCtx.oy + dy, -600, 600);

          const next = { x: nx, y: ny, scale: cur.scale };
          setTransform(role, next);
          applyBoxTransformVars(instDragCtx.box, next);
          return;
        }

        if(instDragCtx.mode === "resize"){
          const dist = Math.max(1, Math.hypot(ev.clientX - instDragCtx.cx, ev.clientY - instDragCtx.cy));
          const ratio = dist / instDragCtx.startDist;
          const ns = clamp(instDragCtx.os * ratio, 0.2, 5);

          const next = { x: cur.x, y: cur.y, scale: ns };
          setTransform(role, next);
          applyBoxTransformVars(instDragCtx.box, next);
          return;
        }
      });

      function endPointer(ev){
        if(!instDragCtx) return;
        if(ev.pointerId !== instDragCtx.pid) return;
        try{ instDragCtx.box.classList.remove("active"); }catch(e){}
        instDragCtx = null;
        // não re-renderiza aqui para não “piscar”; o estado já está atualizado
      }
      window.addEventListener("pointerup", endPointer);
      window.addEventListener("pointercancel", endPointer);

      // Clique fora remove destaque (visual)
      document.addEventListener("mousedown", (ev)=>{
        const active = document.querySelector("#rxPaper .instImgBox.active");
        if(!active) return;
        if(ev.target && ev.target.closest && ev.target.closest(".instImgBox")) return;
        active.classList.remove("active");
      });
    }

    /************************************************************
     * Render Paper
     ************************************************************/
    function renderPaper(){
      const pages = paginateBlocks();
      syncPageUI(pages);

      const pageIdx = state.selectedPage - 1;
      const pageBlocks = pages[pageIdx] || [];

      const rx = $("rxPaper");
      rx.style.setProperty("--rxFont", rxFontPx()+"px");
      rx.style.setProperty("--rxFamily", rxFamilyCSS());

      const headerSrc = safeText(state.headerImgUrl);
      const footerSrc = safeText(state.footerImgUrl);

      const patientName = safeText(state.patientName);
      const docType = safeText(state.patientDocType);
      const docValue = safeText(state.patientDocValue);
      const patientDoc = docValue ? ` · ${docType}: ${docValue}` : "";

      const dateText = safeText(state.dateValue) || todayBR();
      const showDate = !!state.includeDate;

      const docTitle = safeText(state.docTitle);
      const docName = safeText(state.docName);
      const crms = state.crms.map(safeText).filter(Boolean);
      const rqes = state.rqes.map(safeText).filter(Boolean);

      const docLines = [];
      if(crms.length) docLines.push(crms.join(" · "));
      if(rqes.length) docLines.push(rqes.join(" · "));

      const instName = safeText(state.instName);
      const instAddress = safeText(state.instAddress);

      const ht = getTransform("header");
      const ft = getTransform("footer");

      let html = "";

      // Header image area (draggable/resizable)
      html += `<div class="headerArea">`;
      if(headerSrc){
        html += `
          <div class="instImgBox" data-role="header" style="--tx:${ht.x}px;--ty:${ht.y}px;--sc:${ht.scale};">
            <img class="instImg" alt="" src="${escapeAttr(headerSrc)}">
            <div class="instHandle" aria-hidden="true"></div>
          </div>
        `;
      }
      html += `</div>`;

      // REQUIRED center title
      html += `<div class="rxTitleCenter">RECEITA MÉDICA</div>`;

      // Patient + date line
      html += `<div class="rxMeta">`;
      html += `<div class="rxPatientLine"><span class="rxNameLabel">Nome: </span><span class="rxNameValue">${escapeHtml(patientName || "Paciente")}</span><span class="docInline">${escapeHtml(patientDoc)}</span></div>`;
      html += showDate ? `<div class="rxDatePill">${escapeHtml(dateText)}</div>` : `<div></div>`;
      html += `</div>`;

      html += `<div class="rxDividerLine"></div>`;

      // R//
      html += `<div class="rxSymbol">R//</div>`;

      // List
      html += `<div class="rxList">`;
      pageBlocks.forEach((b, i)=>{
        const idxGlobal = (pageIdx * medsPerPage()) + i + 1;

        const name = safeText(b.name);
        const qty = safeText(b.qty);

        if(!name && !qty && !safeText(b.use)) return;

        const fullName = (name || "—").trim();
        const qtyText = qty || "";

        html += `<div class="rxItem">`;
        html += `<div class="rxLine">`;
        html += `<div class="rxNo">${idxGlobal}.</div>`;
        html += `<div class="drugName">${escapeHtml(fullName)}</div>`;
        html += `<div class="leaderText" aria-hidden="true"></div>`;
        html += `<div class="qty">${escapeHtml(qtyText)}</div>`;
        html += `</div>`;

        const use = safeText(b.use);
        if(use){
          html += `<div class="rxInstr">${escapeHtml(use)}</div>`;
        }

        if(b.showIcons !== false && Array.isArray(b.icons) && b.icons.length){
          const pills = b.icons.map(k=>{
            const it = ICON_LIBRARY.find(x=>x.key===k);
            return it ? `<span>${escapeHtml(it.ico)} ${escapeHtml(it.label)}</span>` : "";
          }).filter(Boolean).join("");
          if(pills){
            html += `<div class="useIconsBelow">${pills}</div>`;
          }
        }

        html += `</div>`;
      });
      html += `</div>`;

      // Signature
      html += `<div class="sigWrap">`;
      html += `<div class="docSig">`;
      html += `<div class="sigLine"></div>`;
      html += `<div class="docCenter">`;
      html += `<div class="docName">${escapeHtml([docTitle, docName].filter(Boolean).join(" ").trim() || "Médico")}</div>`;
      if(docLines.length){
        docLines.forEach(line=>{
          html += `<div class="docLine">${escapeHtml(line)}</div>`;
        });
      }
      html += `</div>`;
      html += `</div>`;
      html += `</div>`;

      // Footer image area (draggable/resizable)
      html += `<div class="footerArea">`;
      if(footerSrc){
        html += `
          <div class="instImgBox footer" data-role="footer" style="--tx:${ft.x}px;--ty:${ft.y}px;--sc:${ft.scale};">
            <img class="instImg" alt="" src="${escapeAttr(footerSrc)}">
            <div class="instHandle" aria-hidden="true"></div>
          </div>
        `;
      }
      html += `</div>`;

      // Institution footer gray (optional)
      const instFooter = [instName, instAddress].filter(Boolean).join(" · ");
      if(instFooter){
        html += `<div class="instFooterGray">${escapeHtml(instFooter)}</div>`;
      }

      rx.innerHTML = html;

      // (re)bind drag/resize controls after render
      bindInstTransformControls();
    }

    const renderPaperDebounced = debounce(renderPaper, 120);

    function escapeHtml(s){
      return (s||"").toString()
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }
    function escapeAttr(s){ return escapeHtml(s); }

    /************************************************************
     * Print (todas as páginas)
     ************************************************************/
    function buildPrintAll(){
      const pages = paginateBlocks();

      const headerSrc = safeText(state.headerImgUrl);
      const footerSrc = safeText(state.footerImgUrl);

      const patientName = safeText(state.patientName);
      const docType = safeText(state.patientDocType);
      const docValue = safeText(state.patientDocValue);
      const patientDoc = docValue ? ` · ${docType}: ${docValue}` : "";

      const dateText = safeText(state.dateValue) || todayBR();
      const showDate = !!state.includeDate;

      const docTitle = safeText(state.docTitle);
      const docName = safeText(state.docName);
      const crms = state.crms.map(safeText).filter(Boolean);
      const rqes = state.rqes.map(safeText).filter(Boolean);

      const docLines = [];
      if(crms.length) docLines.push(crms.join(" · "));
      if(rqes.length) docLines.push(rqes.join(" · "));

      const instName = safeText(state.instName);
      const instAddress = safeText(state.instAddress);
      const instFooter = [instName, instAddress].filter(Boolean).join(" · ");

      const per = medsPerPage();

      const ht = getTransform("header");
      const ft = getTransform("footer");

      let out = "";
      pages.forEach((pageBlocks, pIdx)=>{
        out += `<div class="printPage">`;
        out += `<div class="rxPaper" style="--rxFont:${rxFontPx()}px; --rxFamily:${rxFamilyCSS()}; font-family:${rxFamilyCSS()}; font-size:${rxFontPx()}px; padding:${getComputedStyle(document.documentElement).getPropertyValue("--paperPad") || "20mm"};">`;

        out += `<div class="headerArea" style="height:78px; position:relative; margin-bottom:6px;">`;
        if(headerSrc){
          out += `
            <div class="instImgBox" data-role="header" style="--tx:${ht.x}px;--ty:${ht.y}px;--sc:${ht.scale};">
              <img class="instImg" alt="" src="${escapeAttr(headerSrc)}">
              <div class="instHandle" aria-hidden="true"></div>
            </div>
          `;
        }
        out += `</div>`;

        out += `<div class="rxTitleCenter">RECEITA MÉDICA</div>`;

        out += `<div class="rxMeta">`;
        out += `<div class="rxPatientLine"><span class="rxNameLabel">Nome: </span><span class="rxNameValue">${escapeHtml(patientName || "Paciente")}</span><span class="docInline">${escapeHtml(patientDoc)}</span></div>`;
        out += showDate ? `<div class="rxDatePill">${escapeHtml(dateText)}</div>` : `<div></div>`;
        out += `</div>`;

        out += `<div class="rxDividerLine"></div>`;
        out += `<div class="rxSymbol">R//</div>`;

        out += `<div class="rxList">`;
        pageBlocks.forEach((b, i)=>{
          const idxGlobal = (pIdx * per) + i + 1;
          const name = safeText(b.name);
          const qty = safeText(b.qty);
          const use = safeText(b.use);

          if(!name && !qty && !use) return;

          out += `<div class="rxItem">`;
          out += `<div class="rxLine">`;
          out += `<div class="rxNo">${idxGlobal}.</div>`;
          out += `<div class="drugName">${escapeHtml((name || "—").trim())}</div>`;
          out += `<div class="leaderText" aria-hidden="true"></div>`;
          out += `<div class="qty">${escapeHtml(qty || "")}</div>`;
          out += `</div>`;
          if(use) out += `<div class="rxInstr">${escapeHtml(use)}</div>`;

          if(b.showIcons !== false && Array.isArray(b.icons) && b.icons.length){
            const pills = b.icons.map(k=>{
              const it = ICON_LIBRARY.find(x=>x.key===k);
              return it ? `<span>${escapeHtml(it.ico)} ${escapeHtml(it.label)}</span>` : "";
            }).filter(Boolean).join("");
            if(pills) out += `<div class="useIconsBelow">${pills}</div>`;
          }

          out += `</div>`;
        });
        out += `</div>`;

        out += `<div class="sigWrap">`;
        out += `<div class="docSig">`;
        out += `<div class="sigLine"></div>`;
        out += `<div class="docCenter">`;
        out += `<div class="docName">${escapeHtml([docTitle, docName].filter(Boolean).join(" ").trim() || "Médico")}</div>`;
        if(docLines.length){
          docLines.forEach(line=>{
            out += `<div class="docLine">${escapeHtml(line)}</div>`;
          });
        }
        out += `</div>`;
        out += `</div>`;
        out += `</div>`;

        out += `<div class="footerArea" style="height:62px; position:relative; margin-top:10px;">`;
        if(footerSrc){
          out += `
            <div class="instImgBox footer" data-role="footer" style="--tx:${ft.x}px;--ty:${ft.y}px;--sc:${ft.scale};">
              <img class="instImg" alt="" src="${escapeAttr(footerSrc)}">
              <div class="instHandle" aria-hidden="true"></div>
            </div>
          `;
        }
        out += `</div>`;

        if(instFooter){
          out += `<div class="instFooterGray">${escapeHtml(instFooter)}</div>`;
        }

        out += `</div>`;
        out += `</div>`;
      });

      $("printAll").innerHTML = out;
    }

    /************************************************************
     * Config modal
     ************************************************************/
    function openConfig(){
      $("configMask").style.display = "flex";
      $("configMask").setAttribute("aria-hidden","false");
      syncConfigFieldsFromState();
      syncThumbs();
    }
    function closeConfig(){
      // mantém o comportamento de "salvar ao fechar"
      readConfigFieldsToState();
      syncThumbs();
      renderPaperDebounced();

      $("configMask").style.display = "none";
      $("configMask").setAttribute("aria-hidden","true");
    }
    function syncThumbs(){
      $("headerThumb").src = safeText(state.headerImgUrl) || PLACEHOLDER_PNG;
      $("footerThumb").src = safeText(state.footerImgUrl) || PLACEHOLDER_PNG;
    }
    function syncConfigFieldsFromState(){
      $("paperSize").value = state.paperSize;
      $("rxFontFamily").value = state.rxFontFamily;
      $("rxFontSize").value = String(rxFontPx());
      $("includeDate").checked = !!state.includeDate;
      $("dateValue").value = safeText(state.dateValue);
      $("headerUrl").value = safeText(state.headerImgUrl);
      $("footerUrl").value = safeText(state.footerImgUrl);
      $("instName").value = safeText(state.instName);
      $("instAddress").value = safeText(state.instAddress);
    }
    function readConfigFieldsToState(){
      const ps = $("paperSize").value;
      state.paperSize = (ps==="LETTER"||ps==="A5"||ps==="LEGAL") ? ps : "A4";

      const fam = $("rxFontFamily").value;
      state.rxFontFamily = (fam==="ARIAL"||fam==="CALIBRI") ? fam : "TIMES";

      const fz = safeText($("rxFontSize").value).replace(",", ".");
      state.rxFontSize = parseFloat(fz) || state.rxFontSize;

      state.includeDate = !!$("includeDate").checked;
      state.dateValue = safeText($("dateValue").value);

      state.headerImgUrl = safeText($("headerUrl").value);
      state.footerImgUrl = safeText($("footerUrl").value);

      state.instName = safeText($("instName").value);
      state.instAddress = safeText($("instAddress").value);
    }

    function saveConfigExplicit(){
      readConfigFieldsToState();
      syncThumbs();
      renderPaperDebounced();
    }

    function resetConfigToDefault(){
      const d = getDefaultPageConfig();

      state.paperSize = d.paperSize;
      state.includeDate = d.includeDate;
      state.dateValue = d.dateValue;
      state.rxFontSize = d.rxFontSize;
      state.rxFontFamily = d.rxFontFamily;

      state.headerImgUrl = d.headerImgUrl;
      state.footerImgUrl = d.footerImgUrl;
      state.instName = d.instName;
      state.instAddress = d.instAddress;

      state.headerTransform = { ...d.headerTransform };
      state.footerTransform = { ...d.footerTransform };

      state.selectedPage = 1;

      syncConfigFieldsFromState();
      syncThumbs();
      renderPaperDebounced();
    }

    /************************************************************
     * UI Events
     ************************************************************/
    function bindUI(){
      $("btnLogin").addEventListener("click", openLogin);
      $("btnCloseLogin").addEventListener("click", closeLogin);
      $("btnCloseLogin2").addEventListener("click", closeLogin);
      $("loginMask").addEventListener("click", (e)=>{ if(e.target === $("loginMask")) closeLogin(); });

      $("btnLogout").addEventListener("click", logout);

      $("btnAddMed").addEventListener("click", ()=> addBlock({focusName:true}));
      $("btnAddMed2").addEventListener("click", ()=> addBlock({focusName:true}));

      $("btnClear").addEventListener("click", ()=>{
        if(!confirm("Limpar todos os medicamentos e campos desta prescrição?")) return;
        state.blocks = [];
        renderBlocksInitial();
        updateSummaries();
        renderPaperDebounced();
      });

      $("docTitle").addEventListener("change", ()=>{
        state.docTitle = $("docTitle").value === "Dra." ? "Dra." : "Dr.";
        updateSummaries();
        renderPaperDebounced();
        saveProfileDebounced();
      });
      $("docName").addEventListener("input", ()=>{
        state.docName = safeText($("docName").value);
        updateSummaries();
        renderPaperDebounced();
        saveProfileDebounced();
      });

      $("patientName").addEventListener("input", ()=>{
        state.patientName = safeText($("patientName").value);
        updateSummaries();
        renderPaperDebounced();
      });
      $("patientDocType").addEventListener("change", ()=>{
        state.patientDocType = safeText($("patientDocType").value);
        updateSummaries();
        renderPaperDebounced();
      });
      $("patientDocValue").addEventListener("input", ()=>{
        state.patientDocValue = safeText($("patientDocValue").value);
        updateSummaries();
        renderPaperDebounced();
      });

      $("btnAddCRM").addEventListener("click", ()=>{
        state.crms.push("");
        renderCrmList();
        updateSummaries();
        renderPaperDebounced();
        saveProfileDebounced();
      });
      $("btnAddRQE").addEventListener("click", ()=>{
        state.rqes.push("");
        renderRqeList();
        updateSummaries();
        renderPaperDebounced();
        saveProfileDebounced();
      });

      $("btnOpenConfig").addEventListener("click", openConfig);
      $("btnCloseConfig").addEventListener("click", closeConfig);
      $("btnCloseConfig2").addEventListener("click", closeConfig);
      $("configMask").addEventListener("click", (e)=>{ if(e.target === $("configMask")) closeConfig(); });

      $("btnSaveConfig").addEventListener("click", saveConfigExplicit);
      $("btnResetConfig").addEventListener("click", ()=>{
        if(!confirm("Voltar ao padrão original das configurações da página? (inclui imagens e posição/escala)")) return;
        resetConfigToDefault();
      });

      ["paperSize","rxFontFamily","rxFontSize","includeDate","dateValue","headerUrl","footerUrl","instName","instAddress"].forEach(id=>{
        $(id).addEventListener("input", ()=>{
          readConfigFieldsToState();
          syncThumbs();
          renderPaperDebounced();
        });
        $(id).addEventListener("change", ()=>{
          readConfigFieldsToState();
          syncThumbs();
          renderPaperDebounced();
        });
      });

      $("pageSelect").addEventListener("change", ()=>{
        state.selectedPage = parseInt($("pageSelect").value, 10) || 1;
        renderPaperDebounced();
      });
      $("btnPrevPage").addEventListener("click", ()=>{
        state.selectedPage = Math.max(1, state.selectedPage - 1);
        renderPaperDebounced();
      });
      $("btnNextPage").addEventListener("click", ()=>{
        const total = paginateBlocks().length;
        state.selectedPage = Math.min(total, state.selectedPage + 1);
        renderPaperDebounced();
      });

      $("btnPrintOnly").addEventListener("click", ()=>{
        buildPrintAll();
        window.print();
      });

      // mobile tabs (leve)
      const tabEditor = $("tabEditor");
      const tabPreview = $("tabPreview");
      tabEditor.addEventListener("click", ()=>{
        tabEditor.classList.add("on");
        tabPreview.classList.remove("on");
        $("panelEditor").scrollIntoView({ behavior:"smooth", block:"start" });
      });
      tabPreview.addEventListener("click", ()=>{
        tabPreview.classList.add("on");
        tabEditor.classList.remove("on");
        $("panelPreview").scrollIntoView({ behavior:"smooth", block:"start" });
      });
    }

    /************************************************************
     * Init
     ************************************************************/
    async function init(){
      window.scrollTo(0,0);

      applyLogo();
      bindUI();
      ensureGlobalPointerHandlers();

      // session
      const u = loadSession();
      if(u){
        state.user = u;
        applyUserUI();
        const p = loadProfile();
        if(p){
          state.docTitle = (p.docTitle === "Dra.") ? "Dra." : "Dr.";
          state.docName = safeText(p.docName);
          state.crms = Array.isArray(p.crms) && p.crms.length ? p.crms.map(safeText) : [""];
          state.rqes = Array.isArray(p.rqes) && p.rqes.length ? p.rqes.map(safeText) : [""];
          $("persistHint").textContent = "Logado — suas alterações do médico serão salvas automaticamente nesta conta.";
        }
      }

      $("docTitle").value = state.docTitle;
      $("docName").value = state.docName;
      renderCrmList();
      renderRqeList();

      // Config defaults
      $("rxFontSize").value = String(rxFontPx());
      $("dateValue").value = state.dateValue || todayBR();
      state.dateValue = $("dateValue").value;
      syncThumbs();

      // Start with one block
      if(!state.blocks.length) addBlock({focusName:false});
      renderBlocksInitial();
      updateSummaries();

      // Load DB
      loadMedicamentosDB();

      renderPaper();
    }

    init();
  </script>
</body>
</html>
