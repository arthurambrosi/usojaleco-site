<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receituário | Prescrições Médicas</title>

  <!-- Tipografia UJ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#070a10;
      --bg2:#06070c;

      --card: rgba(255,255,255,.035);
      --card2: rgba(255,255,255,.05);

      --line: rgba(170,195,235,.12);
      --line2: rgba(170,195,235,.08);

      --text:#e7ecf6;
      --muted:#97a5bb;

      --orange1:#ff7a18;
      --orange2:#ffb703;

      --shadow: 0 28px 90px rgba(0,0,0,.65);
      --shadow2: 0 16px 50px rgba(0,0,0,.55);

      --rBig: 26px;
      --rMid: 22px;
      --rSm: 16px;

      --padX: clamp(16px, 4.8vw, 24px);
      --maxW: 1180px;

      --paper: #f7f7fb;
      --paperText:#14161d;
      --paperMuted:#4b5260;
      --paperLine:#1f2430;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      background-attachment: fixed;
      overflow-x:hidden;
    }

    /* overlays fixos (2~3 radiais) */
    body::before{
      content:"";
      position:fixed; inset:-20vh -20vw;
      pointer-events:none;
      background:
        radial-gradient(55rem 55rem at 15% 10%, rgba(255,122,24,.18), transparent 55%),
        radial-gradient(48rem 48rem at 88% 22%, rgba(255,183,3,.10), transparent 60%),
        radial-gradient(60rem 60rem at 75% 92%, rgba(90,140,255,.08), transparent 60%);
      filter: blur(.2px);
      opacity:.95;
      z-index:0;
    }

    a{color:inherit}
    .wrap{position:relative; z-index:1}

    /* NAVBAR */
    .nav{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: rgba(7,10,16,.56);
      border-bottom:1px solid var(--line2);
    }
    .navInner{
      max-width: var(--maxW);
      margin:0 auto;
      padding: 14px var(--padX);
      display:flex;
      align-items:center;
      gap:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 210px;
    }
    .logoBox{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, var(--orange1), var(--orange2));
      box-shadow: 0 0 0 1px rgba(255,122,24,.35), 0 14px 35px rgba(255,122,24,.18);
      position:relative;
      flex:0 0 auto;
    }
    .logoBox::after{
      content:"";
      position:absolute; inset:-10px;
      border-radius:14px;
      background: radial-gradient(circle at 40% 35%, rgba(255,183,3,.25), transparent 60%);
      filter: blur(10px);
      opacity:.8;
      z-index:-1;
    }
    .brandTitle{
      display:flex; flex-direction:column; line-height:1.05;
    }
    .brandTitle strong{
      font-family:"DM Serif Display", serif;
      font-weight:400;
      letter-spacing:.2px;
      font-size:18px;
    }
    .brandTitle span{
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
    }

    .navCenter{
      display:flex; gap:8px;
      align-items:center;
      flex:1;
      justify-content:center;
    }
    .navLink{
      position:relative;
      padding:10px 12px;
      border-radius: 14px;
      color:var(--muted);
      text-decoration:none;
      font-weight:600;
      font-size:13px;
    }
    .navLink:hover{
      background: rgba(255,255,255,.03);
      color:var(--text);
    }
    .navLink::after{
      content:"";
      position:absolute;
      left:12px; right:12px; bottom:6px;
      height:2px;
      border-radius:999px;
      background: linear-gradient(90deg, transparent, rgba(255,122,24,.75), rgba(255,183,3,.75), transparent);
      opacity:0;
      transform: translateY(2px);
      transition: .2s ease;
    }
    .navLink:hover::after{opacity:1; transform: translateY(0)}
    .navRight{display:flex; gap:10px; align-items:center; justify-content:flex-end; min-width: 260px;}
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
    }
    .pill:hover{border-color: rgba(255,122,24,.35)}
    .pillPrimary{
      border:1px solid rgba(255,122,24,.38);
      background: linear-gradient(135deg, rgba(255,122,24,.95), rgba(255,183,3,.95));
      color:#1a1410;
      box-shadow: 0 0 0 1px rgba(255,122,24,.25), 0 18px 50px rgba(255,122,24,.16);
    }
    .pillPrimary:hover{
      box-shadow: 0 0 0 1px rgba(255,122,24,.35), 0 24px 70px rgba(255,122,24,.22);
    }

    /* HERO */
    .container{
      max-width: var(--maxW);
      margin:0 auto;
      padding: 18px var(--padX) 28px;
    }
    .heroCard{
      border-radius: var(--rBig);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .heroCard::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(60rem 25rem at 12% 18%, rgba(255,122,24,.16), transparent 55%),
        radial-gradient(40rem 20rem at 85% 12%, rgba(255,183,3,.10), transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .heroInner{
      position:relative;
      padding: 20px clamp(18px, 3vw, 28px);
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 16px;
      align-items:stretch;
    }
    .kicker{
      display:flex; align-items:center; gap:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.14em;
      font-size:11px;
      font-weight:800;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--orange1);
      box-shadow: 0 0 0 6px rgba(255,122,24,.12), 0 0 22px rgba(255,122,24,.22);
    }
    .h1{
      margin:10px 0 0;
      font-family:"DM Serif Display", serif;
      font-weight:400;
      font-size: clamp(28px, 3.2vw, 44px);
      line-height:1.08;
      letter-spacing:.2px;
    }
    .accent{color:var(--orange1)}
    .sub{
      margin: 12px 0 0;
      color: var(--muted);
      line-height:1.65;
      max-width: 58ch;
      font-size: 15px;
    }
    .heroActions{
      margin-top: 14px;
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }

    /* heroArt (mantém no HTML; pode desativar só no mobile se quiser) */
    .heroArt{
      border-radius: var(--rBig);
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      position:relative;
      overflow:hidden;
      box-shadow: var(--shadow2);
      display:flex; align-items:center; justify-content:center;
      min-height: 190px;
    }
    .heroArt::before{
      content:"";
      position:absolute; inset:-20%;
      background:
        radial-gradient(circle at 30% 35%, rgba(255,122,24,.22), transparent 55%),
        radial-gradient(circle at 70% 60%, rgba(255,183,3,.14), transparent 55%),
        radial-gradient(circle at 55% 40%, rgba(120,170,255,.10), transparent 60%);
      filter: blur(2px);
      opacity:.95;
    }
    .heroArt .ring{
      position:absolute;
      width:min(260px, 70%);
      aspect-ratio:1/1;
      border-radius:999px;
      border:1px solid rgba(170,195,235,.18);
      box-shadow: 0 0 0 10px rgba(255,255,255,.02), 0 18px 70px rgba(0,0,0,.45);
    }
    .heroArt .ring.r2{width:min(340px, 88%); opacity:.75}
    .heroArt .centerMark{
      position:relative;
      width:78px; height:78px; border-radius:22px;
      background: linear-gradient(135deg, rgba(255,122,24,.92), rgba(255,183,3,.92));
      box-shadow: 0 0 0 1px rgba(255,122,24,.32), 0 20px 60px rgba(255,122,24,.20);
      display:flex; align-items:center; justify-content:center;
      color:#1a1410;
      font-weight:900;
      letter-spacing:.08em;
    }
    .heroArt .centerMark small{font-size:12px; opacity:.9}

    /* LAYOUT principal (editor + preview) */
    .main{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
      align-items:start;
    }
    .card{
      border-radius: var(--rBig);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(40rem 24rem at 10% 10%, rgba(255,122,24,.09), transparent 60%);
      pointer-events:none;
      opacity:.85;
    }
    .cardHead{
      position:relative;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--line2);
      background: rgba(0,0,0,.14);
    }
    .cardHead h3{
      margin:0;
      font-size:14px;
      letter-spacing:.02em;
      font-weight:900;
      color:var(--text);
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }
    .bar{
      height:2px;
      width: 42px;
      border-radius:999px;
      background: linear-gradient(90deg, var(--orange1), var(--orange2));
      box-shadow: 0 0 22px rgba(255,122,24,.18);
    }

    .cardBody{position:relative; padding: 14px 16px 16px;}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .grid3{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
    @media (max-width: 820px){
      .grid2, .grid3{grid-template-columns:1fr}
    }

    .field{
      width:100%;
      padding: 11px 12px;
      border-radius: 16px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size: 14px;
      line-height:1.2;
    }
    .field:focus{border-color: rgba(255,122,24,.45)}
    .label{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin: 6px 2px 6px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      letter-spacing:.02em;
      text-transform: uppercase;
    }
    .hint{color: var(--muted); font-weight:700; text-transform:none; letter-spacing:0; font-size:12px; opacity:.9}

    .row{
      display:flex; gap:10px; align-items:center;
    }
    .row > *{flex:1}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-weight:900;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{border-color: rgba(255,122,24,.35)}
    .btnPrimary{
      border:1px solid rgba(255,122,24,.38);
      background: linear-gradient(135deg, rgba(255,122,24,.96), rgba(255,183,3,.96));
      color:#1a1410;
      box-shadow: 0 0 0 1px rgba(255,122,24,.22), 0 18px 50px rgba(255,122,24,.16);
    }
    .btnPrimary:hover{box-shadow: 0 0 0 1px rgba(255,122,24,.34), 0 24px 70px rgba(255,122,24,.22)}
    .btnSm{padding:9px 10px; border-radius: 14px; font-size:12px; font-weight:900}

    .divider{
      height:1px;
      background: var(--line2);
      margin: 12px 0;
    }

    /* medication blocks */
    .medBlock{
      border:1px solid var(--line2);
      border-radius: var(--rMid);
      background: rgba(255,255,255,.02);
      overflow:hidden;
      position:relative;
    }
    .medTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-bottom:1px solid var(--line2);
      background: rgba(0,0,0,.12);
    }
    .medTop strong{
      font-size: 13px;
      font-weight: 1000;
      letter-spacing:.02em;
    }
    .medActions{display:flex; gap:8px; align-items:center;}
    .iconBtn{
      width:34px; height:34px;
      border-radius: 14px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .iconBtn:hover{border-color: rgba(255,122,24,.35)}
    .medInner{padding: 12px;}

    .switchRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .switch{
      display:flex; gap:10px; align-items:center;
      padding: 9px 10px;
      border-radius: 999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size: 12px;
      color: var(--muted);
    }
    .switch input{display:none}
    .switch .knob{
      width: 30px; height: 18px; border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.04);
      position:relative;
      flex:0 0 auto;
    }
    .switch .knob::after{
      content:"";
      position:absolute; top:2px; left:2px;
      width: 12px; height: 12px; border-radius:999px;
      background: rgba(231,236,246,.75);
      transition: .18s ease;
    }
    .switch input:checked + .knob{
      border-color: rgba(255,122,24,.45);
      background: rgba(255,122,24,.16);
      box-shadow: 0 0 0 1px rgba(255,122,24,.18);
    }
    .switch input:checked + .knob::after{
      left: 16px;
      background: linear-gradient(135deg, var(--orange1), var(--orange2));
    }
    .switch input:checked ~ span{color: var(--text)}

    .chips{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top: 10px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 9px 10px;
      border-radius: 999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-weight:900;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{border-color: rgba(255,122,24,.35)}
    .chip.on{
      color: var(--text);
      border-color: rgba(255,122,24,.45);
      background: rgba(255,122,24,.10);
      box-shadow: 0 0 0 1px rgba(255,122,24,.12);
    }
    .chip svg{width:16px; height:16px; opacity:.9}

    .thumbs{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top: 10px;
    }
    .thumb{
      width: 74px; height: 74px;
      border-radius: 18px;
      border:1px solid var(--line2);
      overflow:hidden;
      background: rgba(255,255,255,.03);
      cursor:pointer;
      position:relative;
    }
    .thumb img{
      width:100%; height:100%;
      object-fit: cover;
      filter: saturate(1.1) contrast(1.05);
      opacity:.98;
      display:block;
    }
    .thumb.on{
      border-color: rgba(255,122,24,.55);
      box-shadow: 0 0 0 1px rgba(255,122,24,.12), 0 18px 40px rgba(0,0,0,.35);
    }
    .thumb.on::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(circle at 40% 25%, rgba(255,122,24,.18), transparent 55%);
      pointer-events:none;
    }

    /* AUTOCOMPLETE */
    .acWrap{position:relative}
    .acList{
      position:absolute;
      left:0; right:0; top: calc(100% + 8px);
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(7,10,16,.92);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
      max-height: 240px;
      display:none;
      z-index: 40;
    }
    .acItem{
      padding: 10px 12px;
      border-bottom:1px solid rgba(170,195,235,.08);
      cursor:pointer;
      font-weight:800;
      font-size: 13px;
      color: var(--text);
      display:flex; justify-content:space-between; gap:10px;
    }
    .acItem small{color:var(--muted); font-weight:800}
    .acItem:hover{background: rgba(255,255,255,.03)}
    .acItem:last-child{border-bottom:none}

    /* PREVIEW PAPER */
    .paperShell{
      padding: 16px;
    }
    .paperTools{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      margin-bottom: 12px;
    }
    .select{
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-weight:900;
      cursor:pointer;
      outline:none;
    }
    .paperWrap{
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .paper{
      width: min(100%, 560px);
      aspect-ratio: 210 / 297; /* A4 */
      background: var(--paper);
      color: var(--paperText);
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(30,36,48,.12);
      overflow:hidden;
      position:relative;
    }

    /* Páginas: usamos blocos internos com page-break para impressão */
    .paperInner{
      padding: 20mm 18mm; /* margem interna do “A4” no preview */
      font-family: "Manrope", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 12.5px;
      line-height: 1.55;
    }
    .rxTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:16px;
      margin-bottom: 10px;
    }
    .rxLogo{
      width: 58px; height: 58px;
      border-radius: 18px;
      border: 1px dashed rgba(31,36,48,.28);
      display:flex; align-items:center; justify-content:center;
      color: rgba(31,36,48,.55);
      font-weight: 900;
      font-size: 10px;
      text-align:center;
      padding: 6px;
    }
    .rxMeta{
      flex:1;
      text-align:right;
      color: var(--paperMuted);
      font-weight: 800;
      font-size: 11px;
    }

    .rxPatient{
      margin-top: 8px;
      font-weight: 900;
      font-size: 13px;
      display:flex; gap:8px; align-items:flex-end;
      flex-wrap:wrap;
    }
    .rxPatient .line{
      flex: 1 1 200px;
      border-bottom: 1px solid rgba(31,36,48,.55);
      min-width: 240px;
      transform: translateY(-2px);
    }

    .rxR{
      margin: 14px 0 10px;
      display:flex; align-items:center; gap:10px;
      color: var(--paperLine);
      font-weight: 1000;
    }
    .rxMark{
      font-family: "DM Serif Display", serif;
      font-size: 18px;
      font-weight: 400;
    }
    .rxR .barLine{
      height:1px;
      flex:1;
      background: linear-gradient(90deg, rgba(31,36,48,.55), rgba(31,36,48,.15));
    }

    .rxItem{margin: 10px 0 12px}
    .rxLine1{
      display:flex; align-items:flex-end; gap:10px;
      font-weight: 900;
      color: var(--paperText);
    }
    .rxDash{
      flex:1;
      border-bottom: 1px dashed rgba(31,36,48,.55);
      transform: translateY(-4px);
      min-width: 40px;
    }
    .rxQty{
      font-weight: 900;
      color: var(--paperText);
      white-space:nowrap;
    }
    .rxUse{
      margin-top: 6px;
      display:flex; gap:8px; align-items:flex-start;
      color: var(--paperText);
    }
    .rxUse b{min-width: 44px}
    .rxUse span{
      flex:1;
      border-bottom: 1px dotted rgba(31,36,48,.45);
      padding-bottom: 2px;
      min-height: 18px;
      color: var(--paperText);
    }

    .rxIcons{
      margin-top: 8px;
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .rxIcon{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(31,36,48,.25);
      background: rgba(255,255,255,.70);
      font-weight: 900;
      font-size: 11px;
      color: var(--paperText);
    }
    .rxIcon svg{width:14px; height:14px}

    .rxMedImg{
      margin-top: 10px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .rxMedImg img{
      width: 94px; height: 70px;
      border-radius: 14px;
      border: 1px solid rgba(31,36,48,.18);
      object-fit: cover;
      filter: saturate(1.05) contrast(1.03);
      background: #fff;
    }
    .rxFooter{
      position:absolute;
      left:18mm; right:18mm; bottom: 14mm;
      display:flex; justify-content:space-between; gap:14px;
      color: rgba(31,36,48,.75);
      font-weight:800;
      font-size: 10.5px;
    }
    .rxSign{
      width: 52%;
      border-top: 1px solid rgba(31,36,48,.55);
      padding-top: 6px;
      text-align:center;
    }
    .rxDate{white-space:nowrap}

    /* Mobile: não estourar lateral; virar tabs */
    .tabs{
      display:none;
      gap:10px;
      margin-top: 10px;
    }
    .tabBtn{
      flex:1;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-weight: 1000;
      cursor:pointer;
    }
    .tabBtn.on{
      color: var(--text);
      border-color: rgba(255,122,24,.45);
      background: rgba(255,122,24,.10);
      box-shadow: 0 0 0 1px rgba(255,122,24,.12);
    }

    @media (max-width: 980px){
      .navCenter{display:none}
      .navRight{min-width:auto}
      .heroInner{grid-template-columns:1fr}
      .main{grid-template-columns:1fr}
      .tabs{display:flex}
      .hideMobile{display:none}
    }

    /* PRINT */
    @media print{
      body{background:#fff !important}
      body::before{display:none !important}
      .nav, .heroCard, .tabs, .editorCard, .paperTools, .disclaimer{display:none !important}
      .container{max-width:none; padding: 0 !important}
      .previewCard{border:none !important; background:transparent !important; box-shadow:none !important}
      .paperShell{padding:0 !important}
      .paperWrap{justify-content:flex-start !important}
      .paper{
        width:auto !important;
        aspect-ratio:auto !important;
        border:none !important;
        border-radius:0 !important;
        box-shadow:none !important;
      }
      .paperInner{padding: 20mm 18mm !important}
      .rxFooter{position:fixed !important; bottom: 14mm !important}
    }

    /* Page size (controlado via JS por style injetado) */
  </style>
</head>

<body class="">
  <div class="wrap">

    <!-- NAV -->
    <header class="nav">
      <div class="navInner">
        <div class="brand">
          <div class="logoBox" title="Logo (placeholder)"></div>
          <div class="brandTitle">
            <strong>Receituário</strong>
            <span>Prescrições • prévia A4 • impressão</span>
          </div>
        </div>

        <nav class="navCenter">
          <a class="navLink" href="#editor">Editor</a>
          <a class="navLink" href="#preview">Prévia</a>
          <a class="navLink" href="#ajuda">Ajuda</a>
        </nav>

        <div class="navRight">
          <button class="pill" id="btnSync" type="button" title="Recarregar lista de medicamentos da planilha">
            <span>Atualizar lista</span>
          </button>
          <button class="pill pillPrimary" id="btnPrint" type="button">
            <span>Imprimir / PDF</span>
          </button>
        </div>
      </div>
    </header>

    <!-- HERO -->
    <section class="container">
      <div class="heroCard">
        <div class="heroInner">
          <div>
            <div class="kicker"><span class="dot"></span> ferramenta básica • rápida • organizada</div>
            <h1 class="h1">
              Seu <span class="accent">hub de soluções</span> para<br>
              ganhar tempo e qualidade
            </h1>
            <p class="sub">
              Monte a receita com autocomplete (planilha), ícones de posologia e imagens do medicamento — com uma prévia em papel (A4/Letter) pronta para imprimir.
            </p>

            <div class="heroActions">
              <button class="btn btnPrimary" type="button" id="btnAddMedTop">+ Adicionar remédio</button>
              <button class="btn" type="button" id="btnReset">Limpar</button>
            </div>

            <div class="disclaimer" id="ajuda" style="margin-top:12px;color:var(--muted);font-size:12px;line-height:1.55;font-weight:700">
              <span style="display:inline-block;border:1px solid var(--line2);border-radius:999px;padding:8px 10px;background:rgba(255,255,255,.02)">
                Observação: isto é um <b>editor de receita</b> (formatação/organização). Não gera orientação clínica, dose ou conduta.
              </span>
            </div>
          </div>

          <div class="heroArt hideMobile" aria-hidden="true">
            <div class="ring"></div>
            <div class="ring r2"></div>
            <div class="centerMark"><small>RX</small></div>
          </div>
        </div>
      </div>

      <!-- Tabs mobile -->
      <div class="tabs">
        <button class="tabBtn on" type="button" id="tabEditor">Editor</button>
        <button class="tabBtn" type="button" id="tabPreview">Prévia</button>
      </div>

      <!-- MAIN -->
      <div class="main">

        <!-- EDITOR -->
        <section class="card editorCard" id="editor">
          <div class="cardHead">
            <div style="display:flex;align-items:center;gap:10px">
              <div class="bar"></div>
              <h3>Editor</h3>
              <span class="badge" id="badgeMeds">Carregando planilha…</span>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn btnSm" type="button" id="btnAddMed">+ Remédio</button>
            </div>
          </div>

          <div class="cardBody">
            <div class="grid2">
              <div>
                <div class="label">Paciente <span class="hint">nome completo</span></div>
                <input class="field" id="patientName" placeholder="Digite o nome do paciente…" autocomplete="off">
              </div>

              <div>
                <div class="label">Tamanho do papel <span class="hint">afeta a prévia e impressão</span></div>
                <select class="select" id="pageSize">
                  <option value="A4" selected>A4 (210 × 297mm)</option>
                  <option value="Letter">Letter (8.5 × 11")</option>
                </select>
              </div>
            </div>

            <div class="divider"></div>

            <div class="label">Receita <span class="hint">adicione quantos remédios precisar</span></div>
            <div id="medList" style="display:flex;flex-direction:column;gap:10px"></div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
              <button class="btn btnPrimary" type="button" id="btnAddPage">+ Página (quebra manual)</button>
              <button class="btn" type="button" id="btnCopyNewMeds">Ver “novos remédios”</button>
            </div>

            <div id="newMedsPanel" style="display:none;margin-top:12px;border:1px solid var(--line2);border-radius:22px;background:rgba(255,255,255,.02);padding:12px">
              <div class="label" style="margin-top:0">Novos remédios digitados (fora da planilha) <span class="hint">armazenado localmente</span></div>
              <div id="newMedsList" style="color:var(--text);font-weight:800;font-size:13px;line-height:1.6"></div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
                <button class="btn btnSm" type="button" id="btnCopyNewMedsText">Copiar lista</button>
                <button class="btn btnSm" type="button" id="btnClearNewMeds">Limpar lista</button>
              </div>

              <div style="margin-top:10px;color:var(--muted);font-size:12px;line-height:1.55;font-weight:700">
                Automação direta para “escrever de volta” na planilha exige um endpoint (ex.: Apps Script Web App).  
                Deixei um <b>campo no JS</b> para você plugar depois (sem mudar o layout do site).
              </div>
            </div>

          </div>
        </section>

        <!-- PREVIEW -->
        <section class="card previewCard" id="preview">
          <div class="cardHead">
            <div style="display:flex;align-items:center;gap:10px">
              <div class="bar"></div>
              <h3>Prévia</h3>
              <span class="badge" id="badgePreview">A4</span>
            </div>

            <div style="display:flex;gap:8px;align-items:center">
              <span class="badge" id="badgeStatus">Autosave ativo</span>
            </div>
          </div>

          <div class="paperShell">
            <div class="paperTools">
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                <span class="badge">Visualização em papel</span>
                <span class="badge" id="badgeCount">0 itens</span>
              </div>

              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                <button class="btn btnSm" type="button" id="btnZoomMinus">–</button>
                <button class="btn btnSm" type="button" id="btnZoomPlus">+</button>
              </div>
            </div>

            <div class="paperWrap">
              <div class="paper" id="paper">
                <div class="paperInner" id="paperInner">
                  <!-- render -->
                </div>

                <div class="rxFooter">
                  <div class="rxSign">Assinatura e carimbo</div>
                  <div class="rxDate" id="rxDate">Data: ___/___/_____</div>
                </div>
              </div>
            </div>

          </div>
        </section>

      </div>
    </section>

  </div>

  <script>
    /******************************************************************
     *  CONFIG — GOOGLE SHEETS
     ******************************************************************/
    const SHEET_ID = "1es05SmJavEvGAK99kejsgy986T4kRJKw64wozSLTDRQ";
    const GID = "0";

    // (Opcional) endpoint para escrever “novos remédios” na planilha (Apps Script Web App).
    // Ex.: const APP_SCRIPT_WEBAPP_URL = "https://script.google.com/macros/s/XXXX/exec";
    const APP_SCRIPT_WEBAPP_URL = "";

    /******************************************************************
     *  STATE
     ******************************************************************/
    const LS_KEY = "rx_builder_state_v1";
    const LS_NEW_MEDS = "rx_builder_new_meds_v1";

    const state = {
      patientName: "",
      pageSize: "A4",
      zoom: 1,
      meds: [] // {id, name, qty, usage, iconsOn, imagesOn, iconKeys:Set, imgUrls:[], imgSelected, pageBreakAfter}
    };

    let sheetMeds = []; // [{name, images:[u1,u2,u3,u4]}]
    let sheetNameSet = new Set(); // uppercased names

    const ICON_LIBRARY = [
      { key:"manha", label:"Manhã", svg: sunSVG() },
      { key:"tarde", label:"Tarde", svg: afternoonSVG() },
      { key:"noite", label:"Noite", svg: moonSVG() },
      { key:"antesCafe", label:"Antes do café", svg: coffeeSVG("before") },
      { key:"depoisCafe", label:"Depois do café", svg: coffeeSVG("after") },
      { key:"antesAlmoco", label:"Antes do almoço", svg: mealSVG("before") },
      { key:"depoisAlmoco", label:"Depois do almoço", svg: mealSVG("after") },
      { key:"antesJantar", label:"Antes do jantar", svg: dinnerSVG("before") },
      { key:"depoisJantar", label:"Depois do jantar", svg: dinnerSVG("after") },
    ];

    /******************************************************************
     *  DOM
     ******************************************************************/
    const el = {
      badgeMeds: document.getElementById("badgeMeds"),
      badgePreview: document.getElementById("badgePreview"),
      badgeCount: document.getElementById("badgeCount"),

      patientName: document.getElementById("patientName"),
      pageSize: document.getElementById("pageSize"),

      medList: document.getElementById("medList"),

      paper: document.getElementById("paper"),
      paperInner: document.getElementById("paperInner"),
      rxDate: document.getElementById("rxDate"),

      btnAddMed: document.getElementById("btnAddMed"),
      btnAddMedTop: document.getElementById("btnAddMedTop"),
      btnAddPage: document.getElementById("btnAddPage"),
      btnPrint: document.getElementById("btnPrint"),
      btnSync: document.getElementById("btnSync"),
      btnReset: document.getElementById("btnReset"),

      btnZoomMinus: document.getElementById("btnZoomMinus"),
      btnZoomPlus: document.getElementById("btnZoomPlus"),

      btnCopyNewMeds: document.getElementById("btnCopyNewMeds"),
      newMedsPanel: document.getElementById("newMedsPanel"),
      newMedsList: document.getElementById("newMedsList"),
      btnCopyNewMedsText: document.getElementById("btnCopyNewMedsText"),
      btnClearNewMeds: document.getElementById("btnClearNewMeds"),

      tabEditor: document.getElementById("tabEditor"),
      tabPreview: document.getElementById("tabPreview"),
      editorCard: document.querySelector(".editorCard"),
      previewCard: document.querySelector(".previewCard"),
    };

    /******************************************************************
     *  INIT
     ******************************************************************/
    loadState();
    bindUI();
    ensureAtLeastOneMed();
    renderEditor();
    renderPreview();
    applyPageSizeCSS(state.pageSize);
    applyZoom();

    // carregamento da planilha
    fetchSheetMeds().then(() => {
      el.badgeMeds.textContent = `${sheetMeds.length} medicamentos`;
      renderEditor(); // atualiza autocomplete
    }).catch(err => {
      console.warn(err);
      el.badgeMeds.textContent = `Falha ao carregar planilha`;
    });

    /******************************************************************
     *  UI BINDINGS
     ******************************************************************/
    function bindUI(){
      el.patientName.addEventListener("input", () => {
        state.patientName = el.patientName.value.trim();
        saveState();
        renderPreview();
      });

      el.pageSize.addEventListener("change", () => {
        state.pageSize = el.pageSize.value;
        el.badgePreview.textContent = state.pageSize;
        applyPageSizeCSS(state.pageSize);
        saveState();
        renderPreview();
      });

      el.btnAddMed.addEventListener("click", () => { addMed(); });
      el.btnAddMedTop.addEventListener("click", () => { addMed(); });

      el.btnAddPage.addEventListener("click", () => {
        // adiciona uma quebra após o último item (simples e previsível)
        if(state.meds.length === 0) return;
        state.meds[state.meds.length - 1].pageBreakAfter = true;
        saveState();
        renderEditor();
        renderPreview();
      });

      el.btnPrint.addEventListener("click", async () => {
        // antes de imprimir, registra “novos remédios” localmente e tenta enviar (se houver endpoint)
        await syncNewMedsOptional();
        window.print();
      });

      el.btnSync.addEventListener("click", async () => {
        el.badgeMeds.textContent = "Atualizando…";
        try{
          await fetchSheetMeds(true);
          el.badgeMeds.textContent = `${sheetMeds.length} medicamentos`;
          renderEditor();
        }catch(e){
          el.badgeMeds.textContent = "Falha ao atualizar";
        }
      });

      el.btnReset.addEventListener("click", () => {
        const ok = confirm("Limpar a receita atual? (a lista de novos remédios continua salva)");
        if(!ok) return;
        state.patientName = "";
        state.pageSize = "A4";
        state.zoom = 1;
        state.meds = [];
        el.patientName.value = "";
        el.pageSize.value = "A4";
        ensureAtLeastOneMed();
        saveState();
        applyPageSizeCSS(state.pageSize);
        applyZoom();
        renderEditor();
        renderPreview();
      });

      el.btnZoomMinus.addEventListener("click", () => {
        state.zoom = clamp(state.zoom - 0.05, 0.75, 1.25);
        applyZoom();
        saveState();
      });
      el.btnZoomPlus.addEventListener("click", () => {
        state.zoom = clamp(state.zoom + 0.05, 0.75, 1.25);
        applyZoom();
        saveState();
      });

      el.btnCopyNewMeds.addEventListener("click", () => {
        const isOpen = el.newMedsPanel.style.display === "block";
        el.newMedsPanel.style.display = isOpen ? "none" : "block";
        renderNewMedsPanel();
      });

      el.btnCopyNewMedsText.addEventListener("click", async () => {
        const list = getNewMeds();
        if(list.length === 0) return alert("Nenhum novo remédio registrado.");
        const text = list.slice().sort(localeSortPT).join("\n");
        await navigator.clipboard.writeText(text);
        alert("Lista copiada.");
      });

      el.btnClearNewMeds.addEventListener("click", () => {
        const ok = confirm("Limpar a lista de novos remédios?");
        if(!ok) return;
        localStorage.removeItem(LS_NEW_MEDS);
        renderNewMedsPanel();
      });

      // tabs mobile
      el.tabEditor.addEventListener("click", () => setTab("editor"));
      el.tabPreview.addEventListener("click", () => setTab("preview"));

      // hydrate inputs from state
      el.patientName.value = state.patientName || "";
      el.pageSize.value = state.pageSize || "A4";
      el.badgePreview.textContent = state.pageSize || "A4";
    }

    function setTab(which){
      if(which === "editor"){
        el.tabEditor.classList.add("on");
        el.tabPreview.classList.remove("on");
        el.editorCard.classList.remove("hideMobile");
        el.previewCard.classList.add("hideMobile");
      }else{
        el.tabPreview.classList.add("on");
        el.tabEditor.classList.remove("on");
        el.previewCard.classList.remove("hideMobile");
        el.editorCard.classList.add("hideMobile");
      }
    }

    function applyZoom(){
      el.paper.style.transform = `scale(${state.zoom})`;
      el.paper.style.transformOrigin = "top center";
    }

    /******************************************************************
     *  RENDER — EDITOR
     ******************************************************************/
    function renderEditor(){
      el.medList.innerHTML = "";
      state.meds.forEach((m, idx) => {
        el.medList.appendChild(renderMedBlock(m, idx));
      });

      el.badgeCount.textContent = `${countRxItems()} itens`;
      renderNewMedsPanel();
    }

    function renderMedBlock(m, idx){
      const block = document.createElement("div");
      block.className = "medBlock";

      // top
      const top = document.createElement("div");
      top.className = "medTop";

      const title = document.createElement("strong");
      title.textContent = `Remédio ${idx+1}`;

      const actions = document.createElement("div");
      actions.className = "medActions";

      const btnUp = iconButton("↑", "Mover para cima");
      btnUp.onclick = () => moveMed(idx, -1);

      const btnDown = iconButton("↓", "Mover para baixo");
      btnDown.onclick = () => moveMed(idx, +1);

      const btnBreak = iconButton("⎵", "Alternar quebra de página após este remédio");
      btnBreak.onclick = () => {
        m.pageBreakAfter = !m.pageBreakAfter;
        saveState(); renderEditor(); renderPreview();
      };
      if(m.pageBreakAfter) btnBreak.style.borderColor = "rgba(255,122,24,.55)";

      const btnDel = iconButton("✕", "Remover este remédio");
      btnDel.onclick = () => removeMed(idx);

      actions.append(btnUp, btnDown, btnBreak, btnDel);
      top.append(title, actions);

      const inner = document.createElement("div");
      inner.className = "medInner";

      // Name + autocomplete
      const nameWrap = document.createElement("div");
      nameWrap.className = "acWrap";

      const nameLabel = document.createElement("div");
      nameLabel.className = "label";
      nameLabel.innerHTML = `Nome do remédio <span class="hint">pesquisa na planilha enquanto digita</span>`;

      const nameInput = document.createElement("input");
      nameInput.className = "field";
      nameInput.placeholder = "Ex.: ABACAVIR, ACARBOSE, ... (ou digite livre)";
      nameInput.value = m.name || "";
      nameInput.autocomplete = "off";

      const acList = document.createElement("div");
      acList.className = "acList";

      nameInput.addEventListener("input", () => {
        m.name = nameInput.value;
        // se for um nome que não está na planilha, registrar como “novo”
        trackIfNewMed(m.name);
        // atualizar imagens (se encontrar match)
        attachImagesFromSheet(m);
        saveState();
        renderPreview();

        // suggestions
        const q = (nameInput.value || "").trim().toUpperCase();
        if(!q || sheetMeds.length === 0){
          acList.style.display = "none";
          return;
        }
        const hits = sheetMeds
          .filter(x => x.nameUpper.includes(q))
          .slice(0, 10);

        acList.innerHTML = "";
        if(hits.length === 0){
          acList.style.display = "none";
          return;
        }
        hits.forEach(h => {
          const item = document.createElement("div");
          item.className = "acItem";
          item.innerHTML = `<span>${escapeHtml(h.name)}</span><small>${countImgs(h.images)} img</small>`;
          item.onclick = () => {
            m.name = h.name;
            nameInput.value = h.name;
            attachImagesFromSheet(m);
            saveState();
            renderEditor();
            renderPreview();
          };
          acList.appendChild(item);
        });
        acList.style.display = "block";
      });

      nameInput.addEventListener("focus", () => {
        // re-dispara para mostrar lista se já tem texto
        nameInput.dispatchEvent(new Event("input"));
      });

      document.addEventListener("click", (ev) => {
        if(!nameWrap.contains(ev.target)) acList.style.display = "none";
      });

      nameWrap.append(nameLabel, nameInput, acList);

      // Qty + usage (modo de tomar / quantidade)
      const grid = document.createElement("div");
      grid.className = "grid2";

      const qtyCol = document.createElement("div");
      qtyCol.innerHTML = `
        <div class="label">Quantidade <span class="hint">ex.: 01 caixa / 02 ampolas</span></div>
      `;
      const qtyInput = document.createElement("input");
      qtyInput.className = "field";
      qtyInput.placeholder = "Ex.: 01 caixa";
      qtyInput.value = m.qty || "";
      qtyInput.addEventListener("input", () => {
        m.qty = qtyInput.value;
        saveState();
        renderPreview();
      });
      qtyCol.appendChild(qtyInput);

      const usageCol = document.createElement("div");
      usageCol.innerHTML = `
        <div class="label">Uso <span class="hint">posologia / orientações</span></div>
      `;
      const usageInput = document.createElement("input");
      usageInput.className = "field";
      usageInput.placeholder = "Ex.: 01 comprimido 12/12h por 10 dias";
      usageInput.value = m.usage || "";
      usageInput.addEventListener("input", () => {
        m.usage = usageInput.value;
        saveState();
        renderPreview();
      });
      usageCol.appendChild(usageInput);

      grid.append(qtyCol, usageCol);

      // switches: icons/images
      const swRow = document.createElement("div");
      swRow.className = "switchRow";
      swRow.style.marginTop = "10px";

      const swIcons = makeSwitch("Inserir ícones", m.iconsOn, (val) => {
        m.iconsOn = val;
        saveState();
        renderEditor();
        renderPreview();
      });

      const swImages = makeSwitch("Inserir imagens", m.imagesOn, (val) => {
        m.imagesOn = val;
        saveState();
        renderEditor();
        renderPreview();
      });

      swRow.append(swIcons, swImages);

      inner.appendChild(nameWrap);
      inner.appendChild(grid);
      inner.appendChild(swRow);

      // icons chips
      if(m.iconsOn){
        const chipsWrap = document.createElement("div");
        chipsWrap.style.marginTop = "10px";
        const lbl = document.createElement("div");
        lbl.className = "label";
        lbl.innerHTML = `Ícones de posologia <span class="hint">clique para marcar</span>`;
        chipsWrap.appendChild(lbl);

        const chips = document.createElement("div");
        chips.className = "chips";

        ICON_LIBRARY.forEach(icon => {
          const chip = document.createElement("div");
          chip.className = "chip" + (m.iconKeys.has(icon.key) ? " on" : "");
          chip.innerHTML = `${icon.svg}<span>${icon.label}</span>`;
          chip.onclick = () => {
            if(m.iconKeys.has(icon.key)) m.iconKeys.delete(icon.key);
            else m.iconKeys.add(icon.key);
            saveState();
            renderEditor();
            renderPreview();
          };
          chips.appendChild(chip);
        });

        chipsWrap.appendChild(chips);
        inner.appendChild(chipsWrap);
      }

      // images thumbs
      if(m.imagesOn){
        const imgWrap = document.createElement("div");
        imgWrap.style.marginTop = "10px";

        const lbl = document.createElement("div");
        lbl.className = "label";
        lbl.innerHTML = `Imagens do medicamento <span class="hint">seleciona 1 para exibir</span>`;
        imgWrap.appendChild(lbl);

        if(!m.imgUrls || m.imgUrls.length === 0){
          const msg = document.createElement("div");
          msg.style.color = "var(--muted)";
          msg.style.fontWeight = "800";
          msg.style.fontSize = "12px";
          msg.style.lineHeight = "1.55";
          msg.textContent = "Nenhuma imagem encontrada para este nome (ou ainda não carregou da planilha).";
          imgWrap.appendChild(msg);
        }else{
          const thumbs = document.createElement("div");
          thumbs.className = "thumbs";

          m.imgUrls.forEach((u) => {
            const t = document.createElement("div");
            t.className = "thumb" + (m.imgSelected === u ? " on" : "");
            const im = document.createElement("img");
            im.src = u;
            im.alt = "Imagem do medicamento";
            t.appendChild(im);
            t.onclick = () => {
              m.imgSelected = u;
              saveState();
              renderEditor();
              renderPreview();
            };
            thumbs.appendChild(t);
          });
          imgWrap.appendChild(thumbs);
        }

        inner.appendChild(imgWrap);
      }

      block.append(top, inner);
      return block;
    }

    function iconButton(txt, title){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "iconBtn";
      b.title = title;
      b.textContent = txt;
      return b;
    }

    function makeSwitch(label, checked, onChange){
      const wrap = document.createElement("label");
      wrap.className = "switch";
      const id = "sw_" + Math.random().toString(16).slice(2);
      wrap.innerHTML = `
        <input id="${id}" type="checkbox" ${checked ? "checked":""}>
        <span class="knob"></span>
        <span>${label}</span>
      `;
      const input = wrap.querySelector("input");
      input.addEventListener("change", () => onChange(!!input.checked));
      return wrap;
    }

    /******************************************************************
     *  RENDER — PREVIEW
     ******************************************************************/
    function renderPreview(){
      el.badgeCount.textContent = `${countRxItems()} itens`;

      const today = new Date();
      el.rxDate.textContent = `Data: ${pad2(today.getDate())}/${pad2(today.getMonth()+1)}/${today.getFullYear()}`;

      // build paper content
      const patient = (state.patientName || "").trim();

      const pages = splitIntoPages(state.meds);
      // render as multiple “páginas” dentro do preview (para impressão)
      el.paperInner.innerHTML = pages.map((page, pi) => {
        const itemsHtml = page.map(m => renderRxItemHTML(m)).join("");
        const pageBreak = (pi < pages.length-1) ? `<div style="page-break-after:always;height:0;"></div>` : "";
        return `
          <div class="rxPage">
            <div class="rxTop">
              <div class="rxLogo">LOGO<br><span style="font-weight:800;opacity:.75">placeholder</span></div>
              <div class="rxMeta">
                <div style="font-weight:1000;color:#1f2430">Receita</div>
                <div>Modelo simples • alinhado • legível</div>
              </div>
            </div>

            <div class="rxPatient">
              <span>Paciente:</span>
              <span style="font-weight:900">${escapeHtml(patient || "")}</span>
              <span class="line"></span>
            </div>

            <div class="rxR">
              <span class="rxMark">R</span>
              <span style="font-weight:1000">/</span>
              <span class="barLine"></span>
            </div>

            ${itemsHtml || `<div style="color:rgba(31,36,48,.65);font-weight:800">Adicione um remédio no editor.</div>`}

          </div>
          ${pageBreak}
        `;
      }).join("");

      el.badgePreview.textContent = state.pageSize;
      document.getElementById("badgePreview").textContent = state.pageSize;
    }

    function renderRxItemHTML(m){
      const name = (m.name || "").trim();
      const qty  = (m.qty || "").trim();
      const use  = (m.usage || "").trim();

      const iconsHtml = (m.iconsOn && m.iconKeys.size > 0)
        ? `<div class="rxIcons">${
            ICON_LIBRARY
              .filter(i => m.iconKeys.has(i.key))
              .map(i => `<span class="rxIcon">${i.svg}<span>${escapeHtml(i.label)}</span></span>`)
              .join("")
          }</div>`
        : "";

      const imgHtml = (m.imagesOn && m.imgSelected)
        ? `<div class="rxMedImg"><img src="${escapeAttr(m.imgSelected)}" alt="Imagem do medicamento"></div>`
        : "";

      return `
        <div class="rxItem">
          <div class="rxLine1">
            <span>- ${escapeHtml(name || "")}</span>
            <span class="rxDash"></span>
            <span class="rxQty">${escapeHtml(qty || "")}</span>
          </div>

          <div class="rxUse">
            <b>Uso:</b>
            <span>${escapeHtml(use || "")}</span>
          </div>

          ${iconsHtml}
          ${imgHtml}
        </div>
      `;
    }

    function splitIntoPages(meds){
      // Quebra manual: quando pageBreakAfter = true, cria nova página.
      const pages = [];
      let cur = [];
      meds.forEach(m => {
        cur.push(m);
        if(m.pageBreakAfter){
          pages.push(cur);
          cur = [];
        }
      });
      pages.push(cur);
      // se tudo vazio, ainda retorna 1 página
      return pages.length ? pages : [[]];
    }

    /******************************************************************
     *  MED CRUD
     ******************************************************************/
    function ensureAtLeastOneMed(){
      if(state.meds.length === 0) addMed(false);
    }

    function addMed(focus=true){
      const m = {
        id: cryptoRandomId(),
        name: "",
        qty: "",
        usage: "",
        iconsOn: false,
        imagesOn: false,
        iconKeys: new Set(),
        imgUrls: [],
        imgSelected: "",
        pageBreakAfter: false
      };
      state.meds.push(m);
      saveState();
      renderEditor();
      renderPreview();

      if(focus){
        // tenta focar no último input de nome
        setTimeout(() => {
          const last = el.medList.querySelector(".medBlock:last-child .field");
          if(last) last.focus();
        }, 60);
      }
    }

    function removeMed(idx){
      const ok = confirm("Remover este remédio?");
      if(!ok) return;
      state.meds.splice(idx, 1);
      if(state.meds.length === 0) addMed(false);
      saveState();
      renderEditor();
      renderPreview();
    }

    function moveMed(idx, delta){
      const j = idx + delta;
      if(j < 0 || j >= state.meds.length) return;
      const temp = state.meds[idx];
      state.meds[idx] = state.meds[j];
      state.meds[j] = temp;
      saveState();
      renderEditor();
      renderPreview();
    }

    function countRxItems(){
      return state.meds.filter(m => (m.name||"").trim().length > 0).length;
    }

    /******************************************************************
     *  GOOGLE SHEETS FETCH — preferir ID + gviz; fallback pubhtml
     ******************************************************************/
    async function fetchSheetMeds(force=false){
      // cache simples por sessão
      if(!force && sheetMeds.length > 0) return sheetMeds;

      // 1) gviz
      try{
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) throw new Error("GVIZ request failed");
        const text = await res.text();
        const json = parseGViz(text);
        const rows = json.table?.rows || [];

        const meds = [];
        rows.forEach(r => {
          const c = r.c || [];
          const name = (c[0] && (c[0].v ?? "")) ? String(c[0].v).trim() : "";
          if(!name) return;

          const imgs = [1,2,3,4].map(i => {
            const v = c[i] && (c[i].v ?? "");
            const s = v ? String(v).trim() : "";
            return s;
          }).filter(Boolean);

          meds.push({
            name,
            nameUpper: name.toUpperCase(),
            images: imgs
          });
        });

        sheetMeds = meds;
        sheetNameSet = new Set(meds.map(m => m.nameUpper));
        // ao carregar, tentar preencher imagens dos meds já existentes no editor
        state.meds.forEach(m => attachImagesFromSheet(m));
        saveState();
        renderEditor();
        renderPreview();
        return meds;
      }catch(e){
        console.warn("GVIZ failed, trying pubhtml parse…", e);
      }

      // 2) fallback: parse pubhtml (menos robusto, mas quebra galho)
      // você forneceu: https://docs.google.com/spreadsheets/d/e/.../pubhtml
      try{
        const pubUrl = `https://docs.google.com/spreadsheets/d/e/2PACX-1vTKJy_VfH9AYY2DDkvtQiKbz9yPR6vJt7_LNECEHsCB4-pAPByzAyJjnQcyON4YODvdtJnQeKiVJt-x/pubhtml`;
        const res = await fetch(pubUrl, {cache:"no-store"});
        if(!res.ok) throw new Error("pubhtml request failed");
        const html = await res.text();

        const doc = new DOMParser().parseFromString(html, "text/html");
        const table = doc.querySelector("table");
        if(!table) throw new Error("no table found in pubhtml");

        const rows = Array.from(table.querySelectorAll("tr"));
        const meds = [];
        rows.slice(1).forEach(tr => {
          const tds = Array.from(tr.querySelectorAll("td"));
          if(tds.length < 1) return;
          const name = (tds[0]?.textContent || "").trim();
          if(!name) return;
          const imgs = tds.slice(1,5).map(td => (td.textContent||"").trim()).filter(Boolean);
          meds.push({name, nameUpper:name.toUpperCase(), images: imgs});
        });

        sheetMeds = meds;
        sheetNameSet = new Set(meds.map(m => m.nameUpper));
        state.meds.forEach(m => attachImagesFromSheet(m));
        saveState();
        renderEditor();
        renderPreview();
        return meds;
      }catch(e){
        console.error("pubhtml parse failed", e);
        throw e;
      }
    }

    function parseGViz(text){
      // Formato: /*O_o*/\ngoogle.visualization.Query.setResponse({...});
      const start = text.indexOf("{");
      const end = text.lastIndexOf("}");
      if(start === -1 || end === -1) throw new Error("Invalid gviz response");
      const jsonStr = text.slice(start, end+1);
      return JSON.parse(jsonStr);
    }

    function attachImagesFromSheet(m){
      const name = (m.name || "").trim();
      if(!name) { m.imgUrls = []; m.imgSelected = ""; return; }

      const key = name.toUpperCase();
      const hit = sheetMeds.find(x => x.nameUpper === key);
      if(!hit){
        // não achou exato: tenta “startsWith” ou contém (opcional)
        const fallback = sheetMeds.find(x => x.nameUpper.includes(key));
        if(fallback){
          m.imgUrls = fallback.images || [];
        }else{
          m.imgUrls = [];
        }
      }else{
        m.imgUrls = hit.images || [];
      }

      // manter seleção se ainda existir
      if(m.imgSelected && m.imgUrls.includes(m.imgSelected)) return;
      m.imgSelected = m.imgUrls[0] || "";
    }

    function countImgs(arr){
      return (arr || []).filter(Boolean).length;
    }

    /******************************************************************
     *  NEW MED TRACKING (fora da planilha)
     ******************************************************************/
    function trackIfNewMed(name){
      const n = (name || "").trim();
      if(!n) return;
      const up = n.toUpperCase();
      if(sheetNameSet.has(up)) return; // existe na planilha

      // registra localmente (sem duplicar)
      const list = getNewMeds();
      if(!list.map(x => x.toUpperCase()).includes(up)){
        list.push(n);
        setNewMeds(list);
      }
    }

    function getNewMeds(){
      try{
        const raw = localStorage.getItem(LS_NEW_MEDS);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr.filter(Boolean) : [];
      }catch(_){ return []; }
    }
    function setNewMeds(arr){
      localStorage.setItem(LS_NEW_MEDS, JSON.stringify(arr));
      renderNewMedsPanel();
    }
    function renderNewMedsPanel(){
      const list = getNewMeds().slice().sort(localeSortPT);
      el.newMedsList.innerHTML = list.length
        ? list.map(x => `• ${escapeHtml(x)}`).join("<br>")
        : `<span style="color:var(--muted);font-weight:800">Nenhum por enquanto.</span>`;
    }

    async function syncNewMedsOptional(){
      // se tiver endpoint, tenta enviar (sem travar impressão se falhar)
      const list = getNewMeds();
      if(list.length === 0) return;

      if(!APP_SCRIPT_WEBAPP_URL){
        // sem endpoint: só mantém local (o médico pode copiar e colar depois)
        return;
      }

      try{
        // POST simples; do outro lado (Apps Script) você decide:
        // - inserir em ordem alfabética
        // - evitar duplicados
        // - etc.
        await fetch(APP_SCRIPT_WEBAPP_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ newMeds: list })
        });
        // se deu certo, pode limpar
        // (deixo comentado para segurança; você decide)
        // localStorage.removeItem(LS_NEW_MEDS);
      }catch(e){
        console.warn("Falha ao enviar novos remédios para endpoint:", e);
      }
    }

    /******************************************************************
     *  PAGE SIZE (A4/Letter) — injeta @page
     ******************************************************************/
    function applyPageSizeCSS(size){
      // Badge
      el.badgePreview.textContent = size;
      document.getElementById("badgePreview").textContent = size;
      document.getElementById("badgePreview").textContent = size;
      document.getElementById("badgePreview").textContent = size;
      document.getElementById("badgePreview").textContent = size;

      document.getElementById("badgePreview").textContent = size;
      document.getElementById("badgePreview").textContent = size;
      document.getElementById("badgePreview").textContent = size;

      document.getElementById("badgePreview").textContent = size;
      document.getElementById("badgePreview").textContent = size;

      // preview aspect ratio
      if(size === "A4"){
        el.paper.style.aspectRatio = "210 / 297";
        document.getElementById("badgePreview").textContent = "A4";
      }else{
        el.paper.style.aspectRatio = "8.5 / 11";
        document.getElementById("badgePreview").textContent = "Letter";
      }
      document.getElementById("badgePreview").textContent = size;

      // @page for print
      let styleTag = document.getElementById("pageSizeStyle");
      if(!styleTag){
        styleTag = document.createElement("style");
        styleTag.id = "pageSizeStyle";
        document.head.appendChild(styleTag);
      }
      styleTag.textContent = `
        @page { size: ${size}; margin: 0; }
      `;
    }

    /******************************************************************
     *  SAVE/LOAD
     ******************************************************************/
    function saveState(){
      // serializa Sets
      const serial = {
        patientName: state.patientName,
        pageSize: state.pageSize,
        zoom: state.zoom,
        meds: state.meds.map(m => ({
          id: m.id,
          name: m.name,
          qty: m.qty,
          usage: m.usage,
          iconsOn: m.iconsOn,
          imagesOn: m.imagesOn,
          iconKeys: Array.from(m.iconKeys || []),
          imgUrls: m.imgUrls || [],
          imgSelected: m.imgSelected || "",
          pageBreakAfter: !!m.pageBreakAfter
        }))
      };
      localStorage.setItem(LS_KEY, JSON.stringify(serial));
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        if(!data) return;

        state.patientName = data.patientName || "";
        state.pageSize = data.pageSize || "A4";
        state.zoom = typeof data.zoom === "number" ? data.zoom : 1;

        state.meds = Array.isArray(data.meds) ? data.meds.map(x => ({
          id: x.id || cryptoRandomId(),
          name: x.name || "",
          qty: x.qty || "",
          usage: x.usage || "",
          iconsOn: !!x.iconsOn,
          imagesOn: !!x.imagesOn,
          iconKeys: new Set(Array.isArray(x.iconKeys) ? x.iconKeys : []),
          imgUrls: Array.isArray(x.imgUrls) ? x.imgUrls : [],
          imgSelected: x.imgSelected || "",
          pageBreakAfter: !!x.pageBreakAfter
        })) : [];
      }catch(e){
        console.warn("Falha ao carregar estado:", e);
      }
    }

    /******************************************************************
     *  UTILS
     ******************************************************************/
    function cryptoRandomId(){
      return "m_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function localeSortPT(a,b){ return a.localeCompare(b, "pt-BR", {sensitivity:"base"}); }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("`","&#096;"); }

    /******************************************************************
     *  ICON SVGs (inline, leve, legível em papel)
     ******************************************************************/
    function sunSVG(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 18v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M4 12h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M18 12h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M6.3 6.3l1.4 1.4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M16.3 16.3l1.4 1.4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M17.7 6.3l-1.4 1.4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M7.7 16.3l-1.4 1.4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="12" cy="12" r="4.2" stroke="currentColor" stroke-width="2"/>
        </svg>`;
    }
    function afternoonSVG(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 15c2.2-2.4 4.9-3.6 8-3.6s5.8 1.2 8 3.6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M6 18c1.7-1.4 3.8-2.1 6-2.1s4.3.7 6 2.1" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".9"/>
          <path d="M12 4v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="12" cy="9" r="2" stroke="currentColor" stroke-width="2"/>
        </svg>`;
    }
    function moonSVG(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M21 14.4A7.8 7.8 0 1 1 9.6 3a6.2 6.2 0 0 0 11.4 11.4Z"
                stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M16.5 3.8l.4 1.2 1.2.4-1.2.4-.4 1.2-.4-1.2-1.2-.4 1.2-.4.4-1.2Z"
                fill="currentColor" opacity=".9"/>
        </svg>`;
    }

    function coffeeSVG(mode){
      const arrow = mode === "before"
        ? `<path d="M6 3v4h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
           <path d="M10 3L6 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>`
        : `<path d="M6 7V3h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
           <path d="M10 7L6 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>`;
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          ${arrow}
          <path d="M7 10h10v4a5 5 0 0 1-5 5H9a2 2 0 0 1-2-2v-7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M17 11h1.4a2.1 2.1 0 0 1 0 4.2H17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M10 10c0-1 1-1 1-2s-1-1-1-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".7"/>
          <path d="M13 10c0-1 1-1 1-2s-1-1-1-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".7"/>
        </svg>`;
    }

    function mealSVG(mode){
      const arrow = mode === "before"
        ? `<path d="M5 4v4h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
           <path d="M9 4L5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>`
        : `<path d="M5 8V4h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
           <path d="M9 8L5 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>`;
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          ${arrow}
          <path d="M7 11h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 11c0 5 2 9 4 9s4-4 4-9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 11c0-2 8-2 8 0" stroke="current
