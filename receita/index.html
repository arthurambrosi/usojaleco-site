import React, { useState, useEffect } from 'react';
import { Plus, Printer, Image, Clock, Sun, Moon, Utensils, X } from 'lucide-react';

const PrescriptionSystem = () => {
  const [medications, setMedications] = useState([{ 
    id: 1, 
    name: '', 
    quantity: '', 
    usage: '', 
    showIcons: false,
    showImages: false,
    selectedTimes: [],
    selectedImage: null
  }]);
  const [patientName, setPatientName] = useState('');
  const [medicationDatabase, setMedicationDatabase] = useState([]);
  const [paperSize, setPaperSize] = useState('A4');
  const [showSuggestions, setShowSuggestions] = useState({});
  const [newMedications, setNewMedications] = useState([]);

  // Carregar dados da planilha
  useEffect(() => {
    const loadSpreadsheet = async () => {
      try {
        const SHEET_ID = '1es05SmJavEvGAK99kejsgy986T4kRJKw64wozSLTDRQ';
        const response = await fetch(
          `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`
        );
        const text = await response.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        
        const rows = json.table.rows;
        const meds = rows.slice(1).map(row => ({
          name: row.c[0]?.v || '',
          image1: row.c[1]?.v || '',
          image2: row.c[2]?.v || '',
          image3: row.c[3]?.v || '',
          image4: row.c[4]?.v || ''
        })).filter(med => med.name);
        
        setMedicationDatabase(meds.sort((a, b) => a.name.localeCompare(b.name)));
      } catch (error) {
        console.error('Erro ao carregar planilha:', error);
      }
    };
    loadSpreadsheet();
  }, []);

  const addMedication = () => {
    setMedications([...medications, { 
      id: Date.now(), 
      name: '', 
      quantity: '', 
      usage: '', 
      showIcons: false,
      showImages: false,
      selectedTimes: [],
      selectedImage: null
    }]);
  };

  const updateMedication = (id, field, value) => {
    setMedications(medications.map(med => 
      med.id === id ? { ...med, [field]: value } : med
    ));
    
    if (field === 'name') {
      setShowSuggestions({ ...showSuggestions, [id]: value.length > 0 });
    }
  };

  const getSuggestions = (id, searchTerm) => {
    if (!searchTerm) return [];
    return medicationDatabase.filter(med => 
      med.name.toLowerCase().includes(searchTerm.toLowerCase())
    ).slice(0, 5);
  };

  const selectMedication = (id, medName) => {
    updateMedication(id, 'name', medName);
    setShowSuggestions({ ...showSuggestions, [id]: false });
  };

  const getMedicationImages = (medName) => {
    const med = medicationDatabase.find(m => m.name === medName);
    if (!med) return [];
    return [med.image1, med.image2, med.image3, med.image4].filter(img => img);
  };

  const toggleTime = (id, time) => {
    const med = medications.find(m => m.id === id);
    const times = med.selectedTimes.includes(time)
      ? med.selectedTimes.filter(t => t !== time)
      : [...med.selectedTimes, time];
    updateMedication(id, 'selectedTimes', times);
  };

  const timeIcons = {
    'manha': { icon: Sun, label: 'Manhã' },
    'tarde': { icon: Sun, label: 'Tarde' },
    'noite': { icon: Moon, label: 'Noite' },
    'cafe': { icon: Utensils, label: 'Café (antes)' },
    'cafe-depois': { icon: Utensils, label: 'Café (depois)' },
    'almoco': { icon: Utensils, label: 'Almoço (antes)' },
    'almoco-depois': { icon: Utensils, label: 'Almoço (depois)' },
    'jantar': { icon: Utensils, label: 'Jantar (antes)' },
    'jantar-depois': { icon: Utensils, label: 'Jantar (depois)' }
  };

  const generatePDF = () => {
    // Registrar novos medicamentos
    const newMeds = medications
      .filter(med => med.name && !medicationDatabase.find(m => m.name === med.name))
      .map(med => med.name);
    
    if (newMeds.length > 0) {
      setNewMedications([...newMedications, ...newMeds]);
      console.log('Novos medicamentos para adicionar:', newMeds);
    }
    
    window.print();
  };

  return (
    <div style={{
      minHeight: '100vh',
      background: 'linear-gradient(180deg, #070a10 0%, #06070c 100%)',
      position: 'relative',
      overflow: 'hidden'
    }}>
      {/* Overlay effects */}
      <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: `
          radial-gradient(circle at 20% 20%, rgba(255,122,24,0.03) 0%, transparent 50%),
          radial-gradient(circle at 80% 60%, rgba(255,183,3,0.02) 0%, transparent 50%),
          radial-gradient(circle at 40% 80%, rgba(100,150,255,0.015) 0%, transparent 50%)
        `,
        pointerEvents: 'none'
      }} />

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Manrope:wght@400;500;600;700;800;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
          font-family: 'Manrope', sans-serif;
          color: #e7ecf6;
          overflow-x: hidden;
        }
        
        @media print {
          body * { visibility: hidden; }
          #prescription-preview, #prescription-preview * { visibility: visible; }
          #prescription-preview {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            background: white !important;
            padding: 40px !important;
          }
        }

        .glass-card {
          background: linear-gradient(135deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.02) 100%);
          border: 1px solid rgba(170,195,235,0.12);
          border-radius: 22px;
          position: relative;
          overflow: hidden;
        }

        .glass-card::before {
          content: '';
          position: absolute;
          top: 0;
          right: 0;
          width: 200px;
          height: 200px;
          background: radial-gradient(circle, rgba(255,122,24,0.08) 0%, transparent 70%);
          border-radius: 50%;
          pointer-events: none;
        }

        .btn-primary {
          background: linear-gradient(135deg, rgba(255,122,24,0.15) 0%, rgba(255,122,24,0.08) 100%);
          border: 1px solid rgba(255,122,24,0.3);
          color: #ff7a18;
          font-weight: 700;
          padding: 12px 24px;
          border-radius: 14px;
          cursor: pointer;
          transition: all 0.18s ease;
          box-shadow: 
            0 0 0 1px rgba(255,122,24,0.12),
            0 0 60px rgba(255,122,24,0.1);
        }

        .btn-primary:hover {
          transform: translateY(-1px);
          background: linear-gradient(135deg, rgba(255,122,24,0.2) 0%, rgba(255,122,24,0.12) 100%);
          box-shadow: 
            0 0 0 1px rgba(255,122,24,0.2),
            0 0 80px rgba(255,122,24,0.15);
        }

        .btn-secondary {
          background: rgba(255,255,255,0.03);
          border: 1px solid rgba(255,255,255,0.1);
          color: #e7ecf6;
          font-weight: 600;
          padding: 10px 20px;
          border-radius: 14px;
          cursor: pointer;
          transition: all 0.18s ease;
        }

        .btn-secondary:hover {
          transform: translateY(-1px);
          background: rgba(255,255,255,0.05);
        }

        input, textarea {
          background: rgba(255,255,255,0.03);
          border: 1px solid rgba(170,195,235,0.12);
          color: #e7ecf6;
          padding: 12px 16px;
          border-radius: 14px;
          font-family: 'Manrope', sans-serif;
          transition: all 0.18s ease;
          width: 100%;
        }

        input:focus, textarea:focus {
          outline: none;
          border-color: rgba(255,122,24,0.3);
          background: rgba(255,255,255,0.05);
        }

        .suggestion-item {
          padding: 10px 14px;
          cursor: pointer;
          transition: all 0.18s ease;
          border-radius: 10px;
        }

        .suggestion-item:hover {
          background: rgba(255,122,24,0.1);
          color: #ff7a18;
        }
      `}</style>

      <div style={{
        maxWidth: '1180px',
        margin: '0 auto',
        padding: 'clamp(16px, 3vw, 24px)',
        position: 'relative',
        zIndex: 1
      }}>
        {/* Header */}
        <div style={{ marginBottom: '48px', textAlign: 'center' }}>
          <h1 style={{
            fontFamily: "'DM Serif Display', serif",
            fontSize: 'clamp(32px, 5vw, 48px)',
            fontWeight: 700,
            lineHeight: 1.2,
            marginBottom: '12px',
            background: 'linear-gradient(135deg, #e7ecf6 0%, #97a5bb 100%)',
            WebkitBackgroundClip: 'text',
            WebkitTextFillColor: 'transparent'
          }}>
            Sistema de Prescrições
          </h1>
          <p style={{ color: '#97a5bb', fontSize: '16px' }}>
            Prescrições médicas profissionais e organizadas
          </p>
        </div>

        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '26px' }}>
          {/* Editor */}
          <div className="glass-card" style={{ padding: '32px', boxShadow: '0 28px 90px rgba(0,0,0,0.65)' }}>
            <div style={{ marginBottom: '24px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <h2 style={{
                fontFamily: "'DM Serif Display', serif",
                fontSize: '24px',
                fontWeight: 700
              }}>
                Editor
              </h2>
              <select 
                value={paperSize}
                onChange={(e) => setPaperSize(e.target.value)}
                style={{
                  background: 'rgba(255,255,255,0.03)',
                  border: '1px solid rgba(170,195,235,0.12)',
                  color: '#e7ecf6',
                  padding: '8px 12px',
                  borderRadius: '14px',
                  fontSize: '14px'
                }}
              >
                <option value="A4">A4</option>
                <option value="Letter">Letter</option>
                <option value="Legal">Legal</option>
              </select>
            </div>

            {/* Nome do Paciente */}
            <div style={{ marginBottom: '32px' }}>
              <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', color: '#97a5bb', fontWeight: 600 }}>
                Nome do Paciente
              </label>
              <input
                type="text"
                value={patientName}
                onChange={(e) => setPatientName(e.target.value)}
                placeholder="Digite o nome do paciente"
              />
            </div>

            {/* Medicamentos */}
            {medications.map((med, index) => (
              <div key={med.id} style={{ marginBottom: '32px' }}>
                <div style={{ 
                  background: 'rgba(255,255,255,0.02)', 
                  border: '1px solid rgba(170,195,235,0.08)',
                  borderRadius: '18px',
                  padding: '24px'
                }}>
                  <div style={{ marginBottom: '16px', position: 'relative' }}>
                    <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', color: '#97a5bb', fontWeight: 600 }}>
                      Medicamento {index + 1}
                    </label>
                    <input
                      type="text"
                      value={med.name}
                      onChange={(e) => updateMedication(med.id, 'name', e.target.value)}
                      placeholder="Digite o nome do medicamento"
                    />
                    {showSuggestions[med.id] && getSuggestions(med.id, med.name).length > 0 && (
                      <div style={{
                        position: 'absolute',
                        top: '100%',
                        left: 0,
                        right: 0,
                        background: 'rgba(20,25,35,0.98)',
                        border: '1px solid rgba(170,195,235,0.12)',
                        borderRadius: '14px',
                        marginTop: '4px',
                        padding: '8px',
                        zIndex: 10,
                        boxShadow: '0 16px 50px rgba(0,0,0,0.55)'
                      }}>
                        {getSuggestions(med.id, med.name).map((suggestion, i) => (
                          <div
                            key={i}
                            className="suggestion-item"
                            onClick={() => selectMedication(med.id, suggestion.name)}
                          >
                            {suggestion.name}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  <div style={{ marginBottom: '16px' }}>
                    <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', color: '#97a5bb', fontWeight: 600 }}>
                      Quantidade (caixas, ampolas, etc.)
                    </label>
                    <input
                      type="text"
                      value={med.quantity}
                      onChange={(e) => updateMedication(med.id, 'quantity', e.target.value)}
                      placeholder="Ex: 1 caixa, 2 ampolas"
                    />
                  </div>

                  <div style={{ marginBottom: '16px' }}>
                    <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', color: '#97a5bb', fontWeight: 600 }}>
                      Uso
                    </label>
                    <textarea
                      value={med.usage}
                      onChange={(e) => updateMedication(med.id, 'usage', e.target.value)}
                      placeholder="Instruções de uso"
                      rows={3}
                    />
                  </div>

                  {/* Ícones de horário */}
                  <div style={{ marginBottom: '16px' }}>
                    <label style={{ 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '8px',
                      cursor: 'pointer',
                      fontSize: '14px',
                      fontWeight: 600
                    }}>
                      <input
                        type="checkbox"
                        checked={med.showIcons}
                        onChange={(e) => updateMedication(med.id, 'showIcons', e.target.checked)}
                      />
                      Adicionar ícones de horário
                    </label>
                    {med.showIcons && (
                      <div style={{ 
                        marginTop: '12px',
                        display: 'grid',
                        gridTemplateColumns: 'repeat(3, 1fr)',
                        gap: '8px'
                      }}>
                        {Object.entries(timeIcons).map(([key, { icon: Icon, label }]) => (
                          <button
                            key={key}
                            onClick={() => toggleTime(med.id, key)}
                            style={{
                              background: med.selectedTimes.includes(key) 
                                ? 'rgba(255,122,24,0.15)' 
                                : 'rgba(255,255,255,0.03)',
                              border: med.selectedTimes.includes(key)
                                ? '1px solid rgba(255,122,24,0.3)'
                                : '1px solid rgba(170,195,235,0.08)',
                              color: med.selectedTimes.includes(key) ? '#ff7a18' : '#97a5bb',
                              padding: '8px',
                              borderRadius: '10px',
                              cursor: 'pointer',
                              fontSize: '11px',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '4px',
                              justifyContent: 'center',
                              transition: 'all 0.18s ease'
                            }}
                          >
                            <Icon size={14} />
                            <span>{label}</span>
                          </button>
                        ))}
                      </div>
                    )}
                  </div>

                  {/* Imagens do medicamento */}
                  {med.name && medicationDatabase.find(m => m.name === med.name) && (
                    <div>
                      <label style={{ 
                        display: 'flex', 
                        alignItems: 'center', 
                        gap: '8px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: 600,
                        marginBottom: '12px'
                      }}>
                        <input
                          type="checkbox"
                          checked={med.showImages}
                          onChange={(e) => updateMedication(med.id, 'showImages', e.target.checked)}
                        />
                        Adicionar imagem do medicamento
                      </label>
                      {med.showImages && getMedicationImages(med.name).length > 0 && (
                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                          {getMedicationImages(med.name).map((img, i) => (
                            <img
                              key={i}
                              src={img}
                              alt={`${med.name} ${i + 1}`}
                              onClick={() => updateMedication(med.id, 'selectedImage', img)}
                              style={{
                                width: '80px',
                                height: '80px',
                                objectFit: 'cover',
                                borderRadius: '10px',
                                cursor: 'pointer',
                                border: med.selectedImage === img 
                                  ? '2px solid #ff7a18' 
                                  : '1px solid rgba(170,195,235,0.12)',
                                transition: 'all 0.18s ease'
                              }}
                            />
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            ))}

            <button onClick={addMedication} className="btn-secondary" style={{ width: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
              <Plus size={18} />
              Adicionar Medicamento
            </button>

            <button onClick={generatePDF} className="btn-primary" style={{ width: '100%', marginTop: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
              <Printer size={18} />
              Gerar Receita
            </button>
          </div>

          {/* Preview */}
          <div className="glass-card" style={{ padding: '32px', boxShadow: '0 28px 90px rgba(0,0,0,0.65)', maxHeight: '90vh', overflow: 'auto' }}>
            <h2 style={{
              fontFamily: "'DM Serif Display', serif",
              fontSize: '24px',
              fontWeight: 700,
              marginBottom: '24px'
            }}>
              Pré-visualização
            </h2>
            
            <div id="prescription-preview" style={{
              background: 'white',
              color: '#000',
              padding: '40px',
              borderRadius: '8px',
              minHeight: paperSize === 'A4' ? '297mm' : paperSize === 'Letter' ? '279mm' : '356mm',
              fontFamily: 'Arial, sans-serif'
            }}>
              <div style={{ marginBottom: '30px', textAlign: 'left' }}>
                <div style={{ fontSize: '14px', marginBottom: '20px' }}>
                  Para: <strong>{patientName || '___________________________'}</strong>
                </div>
                <div style={{ fontSize: '16px', fontWeight: 'bold', marginBottom: '10px' }}>
                  ℞
                </div>
              </div>

              {medications.map((med, index) => (
                <div key={med.id} style={{ marginBottom: '30px', pageBreakInside: 'avoid' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                    <span style={{ fontWeight: 'bold' }}>
                      {med.name || '________________________________'}
                    </span>
                    {med.quantity && (
                      <>
                        <span>{'─'.repeat(5)}</span>
                        <span>{med.quantity}</span>
                      </>
                    )}
                  </div>
                  
                  {med.usage && (
                    <div style={{ marginLeft: '20px', marginTop: '8px' }}>
                      <div><strong>Uso:</strong> {med.usage}</div>
                    </div>
                  )}

                  {med.showIcons && med.selectedTimes.length > 0 && (
                    <div style={{ marginLeft: '20px', marginTop: '8px', display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                      {med.selectedTimes.map(time => {
                        const { label } = timeIcons[time];
                        return (
                          <span key={time} style={{ 
                            fontSize: '12px',
                            padding: '4px 8px',
                            background: '#f0f0f0',
                            borderRadius: '4px'
                          }}>
                            {label}
                          </span>
                        );
                      })}
                    </div>
                  )}

                  {med.showImages && med.selectedImage && (
                    <div style={{ marginLeft: '20px', marginTop: '12px' }}>
                      <img 
                        src={med.selectedImage} 
                        alt={med.name}
                        style={{ 
                          maxWidth: '150px',
                          maxHeight: '150px',
                          border: '1px solid #ddd',
                          borderRadius: '4px'
                        }}
                      />
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default PrescriptionSystem;
