<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UsoJaleco | Prescrições</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Manrope:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Google Identity Services (Login Google) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg:#070a10;
      --bg2:#06070c;

      --text:#e7ecf6;
      --muted:#97a5bb;

      --line: rgba(170,195,235,.12);
      --line2: rgba(170,195,235,.08);

      --accent1:#b9c3d6;
      --accent2:#8e9ab2;

      --shadowBig: 0 28px 90px rgba(0,0,0,.65);
      --shadowMid: 0 16px 50px rgba(0,0,0,.55);

      --rBig:26px;
      --rMid:22px;
      --rSm:18px;
      --rBtn:14px;

      --t: .18s ease;

      --container: 1180px;
      --padX: clamp(16px, 3.4vw, 24px);
      --gap: 18px;
      --gap2: 26px;

      --topH: 44px;

      /* margem segura ~2cm para a área imprimível/preview */
      --paperPad: 20mm;

      /* laranja default para círculo (coluna C vazia/inválida) */
      --pillOrange: #ff7a18;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 18% 18%, rgba(185,195,214,.10), transparent 60%),
        radial-gradient(980px 560px at 86% 22%, rgba(142,154,178,.08), transparent 62%),
        radial-gradient(980px 680px at 52% 92%, rgba(120,180,255,.06), transparent 65%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      background-attachment: fixed, fixed, fixed, fixed;
      overflow-x:hidden;
    }

    a{color:inherit; text-decoration:none}
    button, input, textarea, select{font:inherit}
    ::selection{background:rgba(185,195,214,.25)}

    .wrap{
      max-width: var(--container);
      margin:0 auto;
      padding: 18px var(--padX) 30px;
    }

    /* ===== Topbar (full width shell + inner max-width) ===== */
    .topbarShell{
      position: sticky;
      top: 0;
      z-index: 40;
      width: 100%;
      padding: 12px var(--padX) 0;
      pointer-events:none; /* evita “pegar” clique fora do card */
    }
    .topbarInner{
      max-width: var(--container);
      margin:0 auto;
      pointer-events:auto;
    }
    .topbar{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 14px;
      border:1px solid var(--line);
      border-radius: var(--rBig);
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      box-shadow: var(--shadowBig);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 0;
      flex: 1 1 auto;
    }
    .markImg{
      width:40px; height:40px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.02);
      box-shadow: 0 0 0 1px rgba(255,255,255,.06), 0 0 50px rgba(255,255,255,.06);
      object-fit: contain;
      padding: 6px;
      flex: 0 0 auto;
    }
    .brandTxt{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand h1{
      margin:0;
      font-family: "DM Serif Display", serif;
      font-weight: 700;
      letter-spacing: .2px;
      font-size: 20px;
      line-height: 1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin:0;
      color: var(--muted);
      font-size: 12.8px;
      line-height: 1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 60ch;
    }

    .actions{
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 0 0 auto;
      max-width: 100%;
    }

    .btn{
      cursor:pointer;
      border-radius: var(--rBtn);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 0 12px;
      height: var(--topH);
      font-weight: 800;
      font-size: 13.5px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform var(--t), background var(--t), border-color var(--t), box-shadow var(--t);
      white-space: nowrap;
      user-select:none;
      max-width: 100%;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.045); border-color: rgba(255,255,255,.14); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    .btnPrimary{
      border-color: rgba(185,195,214,.35);
      background:
        radial-gradient(180px 40px at 30% 50%, rgba(185,195,214,.12), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 0 60px rgba(255,255,255,.06);
    }
    .btnPrimary:hover{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 1px rgba(255,255,255,.10), 0 0 72px rgba(255,255,255,.08);
    }

    .btnGhost{
      background: transparent;
      border-color: var(--line2);
    }

    /* User pill “do mesmo tamanho visual” */
    .userPill{
      display:inline-flex; align-items:center; gap:10px;
      height: var(--topH);
      padding: 0 10px;
      border-radius: var(--rBtn);
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      max-width: min(520px, 70vw);
      overflow:hidden;
    }
    .userPill img{
      width:26px; height:26px; border-radius:999px; object-fit:cover;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
      flex: 0 0 auto;
    }
    .userPill b{
      font-size: 12.8px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 26ch;
      line-height: 1.1;
    }
    .userPill small{
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 26ch;
      line-height: 1.1;
    }

    .iconBtn{
      cursor:pointer;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.02);
      padding: 9px 10px;
      color: var(--text);
      font-weight: 900;
      transition: transform var(--t), background var(--t), border-color var(--t), opacity var(--t);
      user-select:none;
      height: calc(var(--topH) - 10px);
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .iconBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.12); }
    .iconBtnDanger:hover{ border-color: rgba(255,80,80,.25); }
    .iconBtnDim{ opacity:.75; }
    .iconBtnDim:hover{ opacity:1; }

    /* ===== Main layout ===== */
    .main{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: var(--gap2);
      align-items:start;
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--rBig);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadowMid);
      position: relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40% -30% auto auto;
      width:420px; height:420px;
      background: radial-gradient(circle at 30% 30%, rgba(185,195,214,.14), transparent 60%);
      pointer-events:none;
      opacity:.55;
      filter: blur(2px);
    }
    .cardHeader{
      position:relative;
      padding: 16px 16px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid var(--line2);
    }
    .cardHeader h2{
      margin:0;
      font-family: "DM Serif Display", serif;
      font-size: 18px;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .cardHeader .sub{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 12.8px;
      line-height:1.25;
      max-width: 62ch;
    }
    .cardBody{ position:relative; padding: 16px; }

    .label{
      display:block;
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 750;
      margin: 0 0 6px;
      letter-spacing: .2px;
    }
    .field, .select{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 11px 12px;
      outline:none;
      transition: border-color var(--t), background var(--t), box-shadow var(--t);
    }
    .field:focus, .select:focus{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 1px rgba(255,255,255,.10), 0 0 50px rgba(255,255,255,.06);
      background: rgba(255,255,255,.04);
    }
    textarea.field{ min-height: 92px; resize: vertical; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid3eq{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; align-items:end; }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .divider{ height:1px; background: var(--line2); margin: 14px 0; }
    .mini{ font-size: 12.5px; color: var(--muted); line-height:1.2; }

    /* ===== Collapsible sections ===== */
    details.sec{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      overflow:hidden;
      margin-bottom: 12px;
    }
    details.sec > summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      user-select:none;
    }
    details.sec > summary::-webkit-details-marker{ display:none; }
    .secTitle{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width: 0;
    }
    .secTitle b{
      font-size: 13px;
      letter-spacing:.2px;
    }
    .secTitle small{
      color: var(--muted);
      font-size: 12.3px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 72vw;
    }
    .chev{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      color: var(--text);
      flex: 0 0 auto;
      transition: transform var(--t);
    }
    details[open] .chev{ transform: rotate(180deg); }
    .secBody{ padding: 0 12px 12px; }

    /* ===== Toggle ===== */
    .toggleRow{ display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .toggle{
      display:inline-flex; align-items:center; gap:10px;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.02);
      user-select:none;
    }
    .toggle input{ width:18px; height:18px; }
    .toggle span{ font-size: 12.8px; font-weight: 800; color: var(--text); }

    /* ===== Medicine blocks ===== */
    .rxBlocks{ display:flex; flex-direction:column; gap: 12px; }
    .rxBlock{
      border: 1px solid var(--line);
      border-radius: var(--rMid);
      background: linear-gradient(180deg, rgba(255,255,255,.032), rgba(255,255,255,.02));
      padding: 12px;
      position:relative;
      transition: transform var(--t), border-color var(--t), background var(--t);
    }
    .rxBlock:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }

    .rxTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .rxTitle{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex: 1;
    }
    .rxNum{
      width:28px; height:28px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 10px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.02);
      font-weight: 900;
      color: var(--text);
      flex: 0 0 auto;
    }
    .rxTitle strong{
      font-size: 13px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 58vw;
    }
    .rxTools{ display:flex; gap:8px; align-items:center; flex: 0 0 auto; }

    .rxGrid{
      display:grid;
      grid-template-columns: 1.15fr .55fr .80fr;
      gap: 12px;
      align-items:start;
    }
    .rxFull{ margin-top:12px; }

    .rxBlock.collapsed .rxExpandedBody{ display:none; }
    .rxBlock.collapsed .rxTop{ margin-bottom:0; }

    /* Icon selectors */
    .iconPick{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .iconTag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12.3px;
      transition: transform var(--t), background var(--t), border-color var(--t), opacity var(--t);
    }
    .iconTag:hover{ transform: translateY(-1px); background: rgba(255,255,255,.035); border-color: rgba(255,255,255,.12); }
    .iconTag.on{
      border-color: rgba(255,255,255,.22);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 0 60px rgba(255,255,255,.05);
    }

    /* ===== Autocomplete / Results (novo layout) ===== */
    .acWrap{ position:relative; }
    .acList{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      background: rgba(12,14,20,.92);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadowMid);
      backdrop-filter: blur(10px);
      z-index: 50;
      overflow:hidden;
      display:none;
      max-height: 320px;
      overflow:auto;
    }

    .medItem{
      padding: 10px 12px;
      cursor:pointer;
      border-bottom: 1px solid rgba(170,195,235,.08);
      display:flex;
      gap: 12px;
      align-items:flex-start;
      transition: background var(--t);
    }
    .medItem:last-child{ border-bottom:none; }
    .medItem:hover{ background: rgba(255,255,255,.03); }
    .medDot{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      margin-top: 4px;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 0 2px rgba(0,0,0,.22) inset, 0 0 24px rgba(255,255,255,.06);
      flex: 0 0 auto;
      background: var(--pillOrange);
    }
    .medMain{
      flex: 1 1 auto;
      min-width: 0;
    }
    .medTopRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .medA{
      font-weight: 900;
      font-size: 13.2px;
      color: #fff;
      letter-spacing: .15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64ch;
    }
    .medB{
      margin-top: 2px;
      font-style: italic;
      font-size: 12.2px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64ch;
    }
    .medTag{
      flex: 0 0 auto;
      font-size: 11px;
      font-weight: 900;
      color: var(--text);
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.03);
      padding: 4px 8px;
      border-radius: 999px;
      white-space:nowrap;
      max-width: 26ch;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .medSubs{
      display:none;
      gap: 8px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .medItem.open .medSubs{ display:flex; }

    .subBtn{
      cursor:pointer;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 7px 10px;
      font-weight: 900;
      font-size: 12.1px;
      transition: transform var(--t), background var(--t), border-color var(--t);
      user-select:none;
      line-height: 1.1;
    }
    .subBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.045); border-color: rgba(255,255,255,.18); }
    .subBtn:active{ transform: translateY(0px) scale(.99); }

    .acEmpty{
      padding: 12px;
      color: var(--muted);
      font-size: 12.6px;
      line-height: 1.25;
    }

    /* ===== Preview / Paper ===== */
    .paperShell{ padding: 16px; }
    .paperControls{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .paperWrap{ display:flex; justify-content:center; }
    .paper{
      width: 100%;
      max-width: 520px;
      border-radius: 18px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      overflow:hidden;
      position:relative;
    }
    .paperInner{
      padding: var(--paperPad);
      background:#fff;
    }

    .paperA4{ aspect-ratio: 210 / 297; }
    .paperLetter{ aspect-ratio: 8.5 / 11; }
    .paperA5{ aspect-ratio: 148 / 210; }
    .paperLegal{ aspect-ratio: 8.5 / 14; }

    /* Paper typography */
    .rxPaper{
      color:#000;
      line-height: 1.32;
      --rxFont: 13.2px;
      --rxFamily: "Times New Roman", Times, serif;
      font-family: var(--rxFamily);
      font-size: var(--rxFont);
      background:#fff;
    }

    /* Reserved header/footer areas */
    .rxPaper .headerArea{
      position:relative;
      height: 78px;
      margin-bottom: 6px;
    }
    .rxPaper .footerArea{
      position:relative;
      height: 62px;
      margin-top: 10px;
    }
    .instImgSimple{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      max-height: 74px;
      max-width: 92%;
      object-fit: contain;
      pointer-events:none;
    }
    .instImgSimple--footer{ max-height: 58px; }

    /* ===== Novo cabeçalho da receita (sem linha Paciente/Data) ===== */
    .rxMeta{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
    }
    .rxPatientLine{
      font-weight: 900;
      font-size: 12.8px;
      letter-spacing:.15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 68ch;
    }
    .rxPatientLine .docInline{
      font-weight: 800;
      opacity:.9;
      margin-left: 10px;
      white-space:nowrap;
    }

    .rxDatePill{
      flex: 0 0 auto;
      border-radius: 999px;
      background: #f1f1f1;
      color: #111;
      padding: 4px 10px;
      font-weight: 900;
      font-size: 12.1px;
      line-height: 1.2;
      border: 1px solid rgba(0,0,0,.10);
      white-space:nowrap;
    }

    .rxDividerLine{
      height:1px;
      background: #cfcfcf;
      margin: 10px 0 14px;
    }

    /* R// obrigatório */
    .rxSymbol{
      font-weight: 900;
      font-size: 16px;
      margin: 0 0 10px;
    }

    .rxList{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-bottom: 14px;
      font-size: var(--rxFont);
      line-height: 1.34;
    }

    .rxItem{ padding: 0; border: none; background: transparent; }

    .rxLine{
      display:flex;
      align-items:flex-end;
      gap: 10px;
    }

    .rxNo{
      font-weight: 900;
      letter-spacing:.1px;
      width: 20px;
      flex: 0 0 auto;
    }

    .drugName{
      font-weight: 800;
      letter-spacing:.15px;
      max-width: 58%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .leaderText{
      flex: 1;
      overflow:hidden;
      white-space:nowrap;
      color:#000;
      transform: translateY(-1px);
      opacity: 1;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      letter-spacing: .2px;
    }
    .qty{
      font-weight: 800;
      white-space:nowrap;
      color:#000;
      max-width: 40%;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ✅ sem “linha do Uso”: instrução limpa */
    .rxInstr{
      margin-top: 4px;
      padding-left: 30px; /* alinhado após "1." */
      color:#000;
      font-size: var(--rxFont);
      line-height: 1.28;
      word-break: break-word;
    }

    /* ícones embaixo da instrução */
    .useIconsBelow{
      margin-top: 6px;
      padding-left: 30px;
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      color:#000;
      font-size: 13px;
      transform: translateY(-1px);
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .useIconsBelow span{
      border:1px solid rgba(0,0,0,.14);
      border-radius: 999px;
      padding: 2px 8px;
      line-height: 1.2;
      font-weight: 900;
      background: #fff;
    }

    /* assinatura e rodapé */
    .sigWrap{
      margin-top: 6px;
      padding-top: 6px;
    }
    .docSig{
      display:inline-block;
      max-width: 100%;
      text-align:center;
      margin: 0 auto;
    }
    .sigLine{
      width: 100%;
      border-bottom: 1px solid #000;
      height: 24px;
      margin: 0 auto 8px;
    }
    .docCenter{
      text-align:center;
      font-size: 12.2px;
      line-height: 1.25;
      color:#000;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .docCenter .docName{ font-weight: 900; }
    .docCenter .docLine{ margin-top: 2px; }

    .instFooterGray{
      margin-top: 10px;
      text-align:center;
      color:#666;
      font-size: 11.6px;
      line-height: 1.25;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* ===== Preview header tools (gear) ===== */
    .gearBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.02);
      transition: transform var(--t), background var(--t), border-color var(--t);
      font-weight: 900;
      font-size: 12.8px;
      color: var(--text);
      white-space: nowrap;
      height: var(--topH);
    }
    .gearBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.12); }
    .gearBtn .gico{
      width:32px;height:32px;
      display:inline-flex;align-items:center;justify-content:center;
      border-radius: 12px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      font-size: 16px;
    }

    /* ===== Mobile: tabs ===== */
    .mobileTabs{
      display:none;
      margin-top: 14px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      border-radius: 999px;
      padding: 6px;
      gap: 6px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .tab{
      flex:1;
      text-align:center;
      padding: 10px 10px;
      border-radius: 999px;
      font-weight: 900;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      transition: background var(--t), color var(--t), box-shadow var(--t), border-color var(--t);
      border:1px solid transparent;
    }
    .tab.on{
      color: var(--text);
      border-color: rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 0 60px rgba(255,255,255,.06);
    }

    @media (max-width: 980px){
      .main{ grid-template-columns: 1fr; }
      .paper{ max-width: 620px; }
      .mobileTabs{ display:flex; }
      .panel[data-panel="preview"]{ display:none; }
      .panel[data-panel="preview"].show{ display:block; }
      .panel[data-panel="editor"].hide{ display:none; }
    }

    @media (max-width: 520px){
      .brand p{ display:none; }
      .grid2{ grid-template-columns: 1fr; }
      .grid3eq{ grid-template-columns: 1fr; }
      .rxGrid{ grid-template-columns: 1fr; }
      .paperInner{ padding: 16mm; } /* um pouco menor no celular */
      .userPill{ max-width: 92vw; }
      .userPill b, .userPill small{ max-width: 22ch; }
      .gearBtn{ width: 100%; justify-content:space-between; }
    }

    /* ===== Modal ===== */
    .modalMask{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 90;
    }
    .modal{
      width: min(900px, 96vw);
      border-radius: 22px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,18,26,.92), rgba(10,12,18,.92));
      box-shadow: var(--shadowBig);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--line2);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .modalHead b{ font-size: 14px; letter-spacing:.2px; }
    .modalBody{ padding: 14px; }
    .modalFoot{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--line2);
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    .modalCard{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 12px;
    }

    /* ===== History page ===== */
    .historyWrap{ max-width: 980px; margin: 0 auto; padding: 10px 0; }
    .histList{ display:flex; flex-direction:column; gap: 12px; margin-top: 14px; }
    .histItem{
      border:1px solid var(--line);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: 0 16px 50px rgba(0,0,0,.35);
      padding: 14px;
      display:flex;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .histMeta b{ display:block; font-size: 13.5px; letter-spacing:.2px; }
    .histMeta small{ display:block; margin-top:6px; color: var(--muted); font-size: 12.4px; line-height:1.25; }

    /* ===== PRINT (PDF) ===== */
    .printAll{ display:none; }

    @media print{
      body{ background:#fff !important; color:#000 !important; }
      .topbarShell, .mobileTabs, .panel[data-panel="editor"], .panel[data-panel="preview"], #historyPage, .modalMask{ display:none !important; }
      .wrap{ max-width:none; padding:0; }
      .printAll{ display:block !important; }
      .printPage{ width:auto; background:#fff; }

      /* margem segura ~2cm */
      @page { margin: 20mm; }
    }
  </style>
</head>

<body>

  <!-- ===== TOPBAR full width ===== -->
  <div class="topbarShell">
    <div class="topbarInner">
      <div class="topbar">
        <div class="brand">
          <img id="brandMark" class="markImg" alt="Logo UsoJaleco" />
          <div class="brandTxt">
            <h1>UsoJaleco</h1>
            <p>Um jeito mais fácil de prescrever.</p>
          </div>
        </div>

        <div class="actions">
          <span class="userPill" id="userPill" style="display:none;">
            <img id="userPic" alt="" />
            <div style="display:flex;flex-direction:column;gap:2px;min-width:0;">
              <b id="userName">—</b>
              <small id="userEmail">—</small>
            </div>
            <button class="iconBtn iconBtnDanger" id="btnLogout" type="button" title="Sair">⎋</button>
          </span>

          <button class="btn btnGhost" id="btnLogin" type="button">Login</button>

          <button class="btn btnGhost" id="btnHistory" type="button" style="display:none;">Histórico de Prescrições</button>

          <button class="btn btnGhost" id="btnAddMed" type="button">+ Adicionar remédio</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap" id="appWrap">

    <!-- Tabs mobile -->
    <div class="mobileTabs" aria-label="Alternar entre editor e prévia">
      <div class="tab on" id="tabEditor">Editar</div>
      <div class="tab" id="tabPreview">Prévia</div>
    </div>

    <!-- ===== MAIN APP ===== -->
    <div class="main" id="mainApp">
      <!-- ===== Editor ===== -->
      <div class="card panel" data-panel="editor" id="panelEditor">
        <div class="cardHeader">
          <div>
            <h2>Editor</h2>
            <p class="sub">Ao abrir, tudo começa retraído. Você expande só o que for usar.</p>
          </div>
        </div>

        <div class="cardBody">

          <!-- 1) Informações do médico (começa retraído) -->
          <details class="sec">
            <summary>
              <div class="secTitle">
                <b>1. Informações do médico</b>
                <small id="sumMedico">—</small>
              </div>
              <div class="chev">˅</div>
            </summary>
            <div class="secBody">
              <div class="grid2">
                <div>
                  <label class="label" for="docTitle">Título</label>
                  <select class="select" id="docTitle">
                    <option value="Dr." selected>Doutor (Dr.)</option>
                    <option value="Dra.">Doutora (Dra.)</option>
                  </select>
                </div>
                <div>
                  <label class="label" for="docName">Nome do médico</label>
                  <input class="field" id="docName" placeholder="Nome completo…" autocomplete="name" />
                </div>
              </div>

              <div class="divider"></div>

              <div class="grid2">
                <div>
                  <label class="label">CRM(s)</label>
                  <div id="crmList"></div>
                  <div style="margin-top:10px">
                    <button class="btn btnGhost" id="btnAddCRM" type="button">+ Adicionar outro CRM</button>
                  </div>
                </div>

                <div>
                  <label class="label">RQE(s) (opcional)</label>
                  <div id="rqeList"></div>
                  <div style="margin-top:10px">
                    <button class="btn btnGhost" id="btnAddRQE" type="button">+ Adicionar outro RQE</button>
                  </div>
                </div>
              </div>

              <div class="divider"></div>
              <div class="mini" id="persistHint">
                Faça login para salvar os dados do médico “para sempre” nessa conta (e recarregar automaticamente no futuro).
              </div>
            </div>
          </details>

          <!-- 2) Informações do paciente (começa retraído) -->
          <details class="sec">
            <summary>
              <div class="secTitle">
                <b>2. Informações do paciente</b>
                <small id="sumPaciente">—</small>
              </div>
              <div class="chev">˅</div>
            </summary>
            <div class="secBody">
              <div class="grid2">
                <div>
                  <label class="label" for="patientName">Nome do paciente</label>
                  <input class="field" id="patientName" placeholder="Digite o nome do paciente…" autocomplete="name" />
                </div>

                <div>
                  <label class="label">Documento (opcional)</label>
                  <div class="grid2" style="gap:10px;">
                    <select class="select" id="patientDocType">
                      <option value="CPF" selected>CPF</option>
                      <option value="RG">RG</option>
                      <option value="CNS">CNS</option>
                    </select>
                    <input class="field" id="patientDocValue" placeholder="Digite o número…" inputmode="text" />
                  </div>
                </div>
              </div>
            </div>
          </details>

          <!-- 3) Medicamentos (começa retraído) -->
          <details class="sec">
            <summary>
              <div class="secTitle">
                <b>3. Medicamentos</b>
                <small id="sumMeds">—</small>
              </div>
              <div class="chev">˅</div>
            </summary>
            <div class="secBody">
              <div class="mini">Ao adicionar um novo remédio, os anteriores minimizam automaticamente.</div>
              <div style="height:10px"></div>

              <div class="rxBlocks" id="rxBlocks"></div>

              <div class="divider"></div>

              <div class="row">
                <button class="btn btnGhost" id="btnAddMed2" type="button">+ Adicionar remédio</button>
                <button class="btn btnGhost" id="btnClear" type="button">Limpar tudo</button>
              </div>
            </div>
          </details>

        </div>
      </div>

      <!-- ===== Preview ===== -->
      <div class="card panel" data-panel="preview" id="panelPreview">
        <div class="cardHeader">
          <div>
            <h2>Prévia</h2>
            <p class="sub">Receita branca, margens seguras, R// obrigatório e lista numerada.</p>
          </div>

          <div style="display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; justify-content:flex-end;">
            <button class="gearBtn" id="btnOpenConfig" type="button" title="Configurar prescrição">
              <span style="opacity:.95;">Configure sua prescrição</span>
              <span class="gico">⚙️</span>
            </button>
          </div>
        </div>

        <div class="cardBody paperShell">
          <div class="paperControls">
            <div class="mini" id="pageInfo">Página 1 de 1</div>

            <div class="row" style="gap:8px; justify-content:flex-end;">
              <button class="btn btnGhost" id="btnPrevPage" type="button">◀</button>
              <select class="select" id="pageSelect" style="width: 160px;">
                <option value="1" selected>Página 1</option>
              </select>
              <button class="btn btnGhost" id="btnNextPage" type="button">▶</button>
            </div>
          </div>

          <div class="paperWrap">
            <div class="paper paperA4" id="paper">
              <div class="paperInner">
                <div class="rxPaper" id="rxPaper"></div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between; gap:10px;">
            <button class="btn btnPrimary" id="btnPrintOnly" type="button">Imprimir / PDF</button>
            <button class="btn btnGhost" id="btnPrintSave" type="button" style="display:none;">Imprimir + Guardar no Histórico</button>
          </div>

          <div class="mini" id="histHint" style="margin-top:10px; display:none;">
            Dica: o histórico fica salvo nesta conta neste dispositivo.
          </div>
        </div>
      </div>
    </div>

    <!-- ===== HISTORY PAGE (render interno quando URL terminar com /historico-receita) ===== -->
    <div id="historyPage" style="display:none;">
      <div class="historyWrap">
        <div class="card">
          <div class="cardHeader">
            <div>
              <h2>Histórico de Prescrições</h2>
              <p class="sub">Aqui ficam as prescrições que você salvou (nesta conta e neste dispositivo).</p>
            </div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
              <button class="btn btnGhost" id="btnBackToApp" type="button">← Voltar</button>
              <button class="btn btnGhost" id="btnClearHistory" type="button" style="display:none;">Limpar histórico</button>
            </div>
          </div>
          <div class="cardBody">
            <div class="mini" id="histTopInfo">—</div>
            <div class="histList" id="histList"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Conteúdo que só aparece na impressão (todas as páginas) -->
  <div class="printAll" id="printAll"></div>

  <!-- ===== Modal Login ===== -->
  <div class="modalMask" id="loginMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Login">
      <div class="modalHead">
        <div>
          <b>Login com Google</b>
          <div class="mini" style="margin-top:6px;">Ao logar, os dados do médico, padrões e histórico ficam associados à sua conta neste dispositivo.</div>
        </div>
        <button class="iconBtn iconBtnDanger" id="btnCloseLogin" type="button">✕</button>
      </div>
      <div class="modalBody">
        <div id="googleBtnMount"></div>
        <div class="mini" id="loginWarn" style="margin-top:10px; display:none;"></div>
      </div>
      <div class="modalFoot">
        <button class="btn btnGhost" id="btnCloseLogin2" type="button">Fechar</button>
      </div>
    </div>
  </div>

  <!-- ===== Modal Config (padrões + configurações) ===== -->
  <div class="modalMask" id="configMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Configurar prescrição">
      <div class="modalHead">
        <div>
          <b>Configure sua prescrição</b>
          <div class="mini" style="margin-top:6px;">Selecione um padrão já criado ou crie um novo padrão completo.</div>
        </div>
        <button class="iconBtn iconBtnDanger" id="btnCloseConfig" type="button">✕</button>
      </div>

      <div class="modalBody">
        <div class="modalCard">
          <div class="label" style="margin-bottom:8px;">Padrão existente</div>
          <div class="row" style="justify-content:flex-start; gap:10px;">
            <select class="select" id="patternSelect" style="min-width: 280px; flex: 1;">
              <option value="" selected>Nenhum padrão</option>
            </select>
            <button class="btn btnGhost" id="btnApplyPattern" type="button">Aplicar</button>
            <button class="btn btnGhost" id="btnEditPattern" type="button">Editar</button>
            <button class="btn btnGhost" id="btnDeletePattern" type="button">Excluir</button>
          </div>
          <div class="mini" style="margin-top:10px;">
            Ao aplicar, a prévia muda imediatamente para o padrão escolhido.
          </div>
        </div>

        <div class="divider"></div>

        <div class="modalCard">
          <div class="row" style="justify-content:space-between; gap:10px;">
            <div>
              <div class="label" style="margin:0;">Novo padrão</div>
              <div class="mini" style="margin-top:6px;">Clique para criar e preencher tamanho, fonte, cabeçalho/rodapé e dados da instituição.</div>
            </div>
            <button class="btn btnPrimary" id="btnToggleNewPattern" type="button">+ Criar novo padrão</button>
          </div>

          <div id="newPatternArea" style="display:none; margin-top:14px;">
            <div class="grid2">
              <div>
                <label class="label" for="patternName">Nome do padrão</label>
                <input class="field" id="patternName" placeholder="Ex: Clínica X (A4, Times, 13.2)" />
              </div>
              <div>
                <label class="label" for="paperSize">Tamanho da folha</label>
                <select class="select" id="paperSize">
                  <option value="A4" selected>A4</option>
                  <option value="LETTER">Carta (Letter)</option>
                  <option value="A5">A5</option>
                  <option value="LEGAL">Legal</option>
                </select>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="grid3eq">
              <div>
                <label class="label" for="rxFontFamily">Fonte</label>
                <select class="select" id="rxFontFamily">
                  <option value="TIMES" selected>Times New Roman</option>
                  <option value="CALIBRI">Calibri</option>
                  <option value="ARIAL">Arial</option>
                </select>
              </div>

              <div>
                <label class="label" for="rxFontSize">Tamanho da fonte da prescrição</label>
                <input class="field" id="rxFontSize" placeholder="Ex: 13.2" inputmode="decimal" />
              </div>

              <div>
                <label class="label">Data</label>
                <div class="toggleRow" style="justify-content:flex-start;">
                  <label class="toggle" title="Mostrar/ocultar a data na receita">
                    <input type="checkbox" id="includeDate" checked />
                    <span>Incluir</span>
                  </label>
                </div>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="grid2">
              <div>
                <label class="label" for="dateValue">Data (se ativada)</label>
                <input class="field" id="dateValue" placeholder="dd/mm/aaaa" inputmode="numeric" />
              </div>

              <div>
                <label class="label" for="instName">Instituição de Saúde</label>
                <input class="field" id="instName" placeholder="Nome da instituição…" />
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="modalCard" style="padding:12px; border-radius:16px;">
              <div class="label" style="margin-bottom:8px;">Endereço da Instituição (aparece em cinza no rodapé)</div>
              <div class="grid3eq">
                <div>
                  <label class="label" for="addrStreet">Rua</label>
                  <input class="field" id="addrStreet" placeholder="Rua…" />
                </div>
                <div>
                  <label class="label" for="addrNumber">Número</label>
                  <input class="field" id="addrNumber" placeholder="Nº…" />
                </div>
                <div>
                  <label class="label" for="addrDistrict">Bairro</label>
                  <input class="field" id="addrDistrict" placeholder="Bairro…" />
                </div>
              </div>

              <div style="height:10px"></div>

              <div class="grid3eq">
                <div>
                  <label class="label" for="addrCity">Cidade</label>
                  <input class="field" id="addrCity" placeholder="Cidade…" />
                </div>
                <div>
                  <label class="label" for="addrState">Estado (sigla)</label>
                  <input class="field" id="addrState" placeholder="BA" maxlength="2" />
                </div>
                <div>
                  <label class="label" for="addrCep">CEP</label>
                  <input class="field" id="addrCep" placeholder="00000-000" inputmode="numeric" />
                </div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="grid2">
              <div class="modalCard">
                <div class="label">Imagem de cabeçalho (URL ou Upload)</div>
                <div class="row" style="justify-content:flex-start; gap:10px;">
                  <button class="btn btnGhost" id="btnPickHeader" type="button">Upload</button>
                  <input type="file" id="fileHeader" accept="image/*" style="display:none;" />
                  <input class="field" id="headerUrl" placeholder="Cole a URL do cabeçalho (opcional)..." />
                </div>
                <div style="height:10px"></div>
                <img id="headerThumb" alt="" style="width:100%;height:56px;border-radius:14px;border:1px solid var(--line2);background:rgba(255,255,255,.02);object-fit:contain;padding:6px;" />
              </div>

              <div class="modalCard">
                <div class="label">Imagem de rodapé (URL ou Upload)</div>
                <div class="row" style="justify-content:flex-start; gap:10px;">
                  <button class="btn btnGhost" id="btnPickFooter" type="button">Upload</button>
                  <input type="file" id="fileFooter" accept="image/*" style="display:none;" />
                  <input class="field" id="footerUrl" placeholder="Cole a URL do rodapé (opcional)..." />
                </div>
                <div style="height:10px"></div>
                <img id="footerThumb" alt="" style="width:100%;height:56px;border-radius:14px;border:1px solid var(--line2);background:rgba(255,255,255,.02);object-fit:contain;padding:6px;" />
              </div>
            </div>

            <div class="divider"></div>

            <div class="row" style="justify-content:flex-end; gap:10px;">
              <button class="btn btnGhost" id="btnCancelNewPattern" type="button">Cancelar</button>
              <button class="btn btnPrimary" id="btnSavePattern" type="button">Salvar padrão</button>
            </div>

          </div>
        </div>

      </div>

      <div class="modalFoot">
        <button class="btn btnGhost" id="btnCloseConfig2" type="button">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    /************************************************************
     * CONFIG (dentro do código) — Ícone do topo (UsoJaleco)
     ************************************************************/
    let BRAND_LOGO_URL = "https://github.com/arthurambrosi/usojaleco/blob/1a17b841f2297bbb9237f5121ea34b67c1f18c45/Design%20sem%20nomes%20(28).png";
    let BRAND_LOGO_SIZE_PX = 40;

    /************************************************************
     * LOGIN GOOGLE (GIS)
     ************************************************************/
    const GOOGLE_CLIENT_ID = "703476878000-7h4lq2cbpffp3qp7hdn1hksi9k43qqm1.apps.googleusercontent.com";

    // Placeholder PNG transparente
    const PLACEHOLDER_PNG =
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABJ0lEQVR4nO3aMQ6CMBQF0U8m0dQmGQm0mQkYQm0mQkYQm0mQkYQm0mQkYQm0mQkYQm0mQkYQm0mQkYQm0mQkYQk0v2k6yqk7+XyQm5mYd8yqf9gQAAAAAAAAAA4Gm9oQm2b3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQAAAAA8D8m8i8b8kq8wQAAAABJRU5ErkJggg==";

    /************************************************************
     * GOOGLE SHEETS — múltiplas abas (classes)
     * - busca em TODAS as abas (publicadas) e unifica resultados
     ************************************************************/
    const SHEET_ID = "1CR3CtU-aA6-JZE37GUElF7CmHKudeiRgOK9WhIvBO8c";
    const SHEET_PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2px-SWkaAF39UmOm_lPxHheVOKclf-WOz4wW8I27xOcWg3MhJaq9YMR_Jxn5SDKOH9QuNHIl7sdIm/pubhtml";
    const DEFAULT_COLOR = getComputedStyle(document.documentElement).getPropertyValue("--pillOrange").trim() || "#ff7a18";

    const state = {
      // sessão (login)
      user: null, // {email,name,picture,sub}

      // médico
      docTitle: "Dr.",
      docName: "",
      crms: [""],
      rqes: [""],

      // paciente
      patientName: "",
      patientDocType: "CPF",
      patientDocValue: "",

      // config/página (agora fica no modal da engrenagem)
      paperSize: "A4",
      includeDate: true,
      dateValue: "",
      rxFontSize: 13.2,
      rxFontFamily: "TIMES",

      // instituição (rodapé cinza)
      instName: "",
      addrStreet: "",
      addrNumber: "",
      addrDistrict: "",
      addrCity: "",
      addrState: "",
      addrCep: "",

      // imagens institucionais simples (1 cabeçalho + 1 rodapé)
      headerImgData: "",
      headerImgUrl: "",
      footerImgData: "",
      footerImgUrl: "",

      // meds
      blocks: [], // {id, name, dose, qty, use, collapsed, showIcons, icons[]}
      selectedPage: 1,

      // db meds
      db: { loaded:false, loading:false, list:[], tabs:[] }
    };

    const $ = (id)=>document.getElementById(id);

    function safeText(s){ return (s||"").toString().replace(/\s+/g," ").trim(); }
    function norm(s){
      return (s||"")
        .toString()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .trim();
    }
    function keyify(s){ return norm(s).toLowerCase(); }
    function uid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function todayBR(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }

    function rxFontPx(){
      const v = parseFloat(String(state.rxFontSize).replace(",", "."));
      if(!isFinite(v) || v <= 6) return 13.2;
      return clamp(v, 7.5, 18);
    }

    function rxFamilyCSS(){
      if(state.rxFontFamily === "ARIAL") return "Arial, Helvetica, sans-serif";
      if(state.rxFontFamily === "CALIBRI") return "Calibri, Arial, sans-serif";
      return "\"Times New Roman\", Times, serif";
    }

    function medsPerPage(){
      const px = rxFontPx();
      if(px <= 9.1) return 12;
      if(px <= 9.7) return 11;
      if(px <= 10.3) return 10;
      if(px <= 10.9) return 9;
      if(px <= 11.5) return 9;
      if(px <= 12.4) return 8;
      if(px <= 13.0) return 7;
      return 6;
    }

    function leaderHyphens(){ return "-".repeat(220); }

    function paginateBlocks(){
      const per = medsPerPage();
      const pages = [];
      let cur = [];
      state.blocks.forEach(b=>{
        cur.push(b);
        if(cur.length >= per){
          pages.push(cur);
          cur = [];
        }
      });
      if(cur.length || pages.length===0) pages.push(cur);
      return pages;
    }

    /************************************************************
     * LOCAL STORAGE (por conta)
     ************************************************************/
    function sessionKey(){ return "uj_rx_session_v2"; }
    function profileKey(email){ return `uj_rx_profile_v2__${(email||"").toLowerCase()}`; }
    function patternsKey(email){ return `uj_rx_patterns_v2__${(email||"").toLowerCase()}`; }
    function historyKey(email){ return `uj_rx_history_v1__${(email||"").toLowerCase()}`; }

    function saveSession(){
      try{
        if(!state.user){ localStorage.removeItem(sessionKey()); return; }
        localStorage.setItem(sessionKey(), JSON.stringify(state.user));
      }catch(e){}
    }
    function loadSession(){
      try{
        const raw = localStorage.getItem(sessionKey());
        if(!raw) return null;
        const u = JSON.parse(raw);
        if(u && u.email) return u;
      }catch(e){}
      return null;
    }

    function saveProfileDebouncedFactory(){
      const fn = debounce(()=> saveProfile(), 180);
      return fn;
    }
    const saveProfileDebounced = saveProfileDebouncedFactory();

    function saveProfile(){
      if(!state.user || !state.user.email) return;
      const payload = {
        docTitle: state.docTitle,
        docName: state.docName,
        crms: state.crms,
        rqes: state.rqes
      };
      try{
        localStorage.setItem(profileKey(state.user.email), JSON.stringify(payload));
        $("persistHint").textContent = "Salvo automaticamente nesta conta (alterações ficam registradas).";
      }catch(e){}
    }

    function loadProfile(){
      if(!state.user || !state.user.email) return null;
      try{
        const raw = localStorage.getItem(profileKey(state.user.email));
        if(!raw) return null;
        const p = JSON.parse(raw);
        return p || null;
      }catch(e){ return null; }
    }

    function loadPatterns(){
      if(!state.user || !state.user.email) return [];
      try{
        const raw = localStorage.getItem(patternsKey(state.user.email));
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }

    function savePatterns(arr){
      if(!state.user || !state.user.email) return;
      try{
        localStorage.setItem(patternsKey(state.user.email), JSON.stringify(arr || []));
      }catch(e){}
    }

    function loadHistory(){
      if(!state.user || !state.user.email) return [];
      try{
        const raw = localStorage.getItem(historyKey(state.user.email));
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }

    function saveHistory(arr){
      if(!state.user || !state.user.email) return;
      try{
        localStorage.setItem(historyKey(state.user.email), JSON.stringify(arr || []));
      }catch(e){}
    }

    /************************************************************
     * GOOGLE LOGIN (GIS) — modal + render button
     ************************************************************/
    function b64urlDecode(str){
      str = (str||"").replace(/-/g, "+").replace(/_/g, "/");
      const pad = str.length % 4;
      if(pad) str += "=".repeat(4 - pad);
      try{ return decodeURIComponent(escape(atob(str))); }catch(e){
        try{ return atob(str); }catch(e2){ return ""; }
      }
    }
    function parseJwt(token){
      const parts = (token||"").split(".");
      if(parts.length < 2) return null;
      try{
        const json = b64urlDecode(parts[1]);
        return JSON.parse(json);
      }catch(e){ return null; }
    }

    function openLogin(){
      $("loginMask").style.display = "flex";
      $("loginMask").setAttribute("aria-hidden","false");

      const warn = $("loginWarn");
      warn.style.display = "none";
      warn.textContent = "";

      if(!GOOGLE_CLIENT_ID){
        warn.style.display = "block";
        warn.textContent = "⚠️ Falta configurar o GOOGLE_CLIENT_ID no código (no topo do <script>).";
        $("googleBtnMount").innerHTML = "";
        return;
      }

      $("googleBtnMount").innerHTML = "";
      if(window.google && google.accounts && google.accounts.id){
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: (resp)=>{
            const payload = parseJwt(resp.credential);
            if(!payload || !payload.email){
              warn.style.display = "block";
              warn.textContent = "Não foi possível ler os dados da conta. Tente novamente.";
              return;
            }
            onLogged({
              email: payload.email,
              name: payload.name || payload.given_name || payload.email,
              picture: payload.picture || "",
              sub: payload.sub || ""
            });
            closeLogin();
          }
        });

        google.accounts.id.renderButton(
          $("googleBtnMount"),
          { theme: "outline", size: "large", shape: "pill", width: 360 }
        );
      }else{
        warn.style.display = "block";
        warn.textContent = "Carregando Google… se não aparecer, recarregue a página.";
      }
    }

    function closeLogin(){
      $("loginMask").style.display = "none";
      $("loginMask").setAttribute("aria-hidden","true");
    }

    function onLogged(user){
      state.user = user;
      saveSession();
      applyUserUI();

      const p = loadProfile();
      if(p){
        state.docTitle = (p.docTitle === "Dra.") ? "Dra." : "Dr.";
        state.docName = safeText(p.docName);
        state.crms = Array.isArray(p.crms) && p.crms.length ? p.crms.map(safeText) : [""];
        state.rqes = Array.isArray(p.rqes) && p.rqes.length ? p.rqes.map(safeText) : [""];
      }

      $("docTitle").value = state.docTitle;
      $("docName").value = state.docName;

      renderCrmList();
      renderRqeList();

      refreshPatternSelect();

      $("persistHint").textContent = "Logado — suas alterações do médico serão salvas automaticamente nesta conta.";
      $("histHint").style.display = "block";

      updateSummaries();
      renderPaperDebounced();
    }

    function logout(){
      state.user = null;
      saveSession();
      applyUserUI();
      $("persistHint").textContent = "Faça login para salvar os dados do médico “para sempre” nessa conta (e recarregar automaticamente no futuro).";
      $("histHint").style.display = "none";
    }

    function applyUserUI(){
      const has = !!(state.user && state.user.email);
      $("btnLogin").style.display = has ? "none" : "inline-flex";
      $("userPill").style.display = has ? "inline-flex" : "none";

      $("btnHistory").style.display = has ? "inline-flex" : "none";
      $("btnPrintSave").style.display = has ? "inline-flex" : "none";

      if(has){
        $("userName").textContent = state.user.name || "Conta Google";
        $("userEmail").textContent = state.user.email;
        $("userPic").src = state.user.picture || PLACEHOLDER_PNG;
      }
    }

    /************************************************************
     * GOOGLE SHEETS — carregar abas + meds (A/B/C) via GVIZ
     ************************************************************/
    function decodeHTMLEntities(str){
      try{
        const t = document.createElement("textarea");
        t.innerHTML = str;
        return t.value;
      }catch(e){ return str; }
    }

    function sanitizeColor(c){
      const v = safeText(c);
      if(!v) return DEFAULT_COLOR;
      const s = v.trim();

      // hex
      if(/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(s)) return s;

      // rgb/rgba
      if(/^rgba?\(/i.test(s)) return s;

      // nome CSS simples
      if(/^[a-z]+$/i.test(s)) return s;

      return DEFAULT_COLOR;
    }

    async function fetchSheetTabsFromPubhtml(){
  return [
    { "gid": "915261507",  "name": "Agentes antirreumáticos específicos" },
    { "gid": "478511829",  "name": "Agentes imunizantes" },
    { "gid": "1411845420", "name": "Alcalinizantes" },
    { "gid": "395560222",  "name": "Analgésicos-Antipiréticos" },
    { "gid": "862085121",  "name": "Anestésicos locais" },
    { "gid": "20003638",   "name": "Anti-Histamínicos H1" },
    { "gid": "1822197995", "name": "Anti-hemorroidários" },
    { "gid": "1061659817", "name": "Anti-infecciosos do trato gastrintestinal" },
    { "gid": "1661597209", "name": "Anti-infecciosos tópicos e relacionados" },
    { "gid": "1954155192", "name": "Antialcoólicos" },
    { "gid": "1265384594", "name": "Antialérgicos" },
    { "gid": "563048962",  "name": "Antiastênicos-Energéticos" },
    { "gid": "827175960",  "name": "Antibióticos" },
    { "gid": "1098787868", "name": "Agentes anti-inflamatórios não esteróides" },
    { "gid": "1418395467", "name": "Anticoncepcionais" },
    { "gid": "2118860551", "name": "Antidiabéticos" },
    { "gid": "1848961101", "name": "Antidiarreicos" },
    { "gid": "388566765",  "name": "Antieméticos" },
    { "gid": "803029356",  "name": "Antifiséticos (Antiflatulentos)" },
    { "gid": "839735687",  "name": "Antifúngicos" },
    { "gid": "1604110756", "name": "Antifúngicos tópicos" },
    { "gid": "138405399",  "name": "Antilipêmicos" },
    { "gid": "1785559041", "name": "Antineuríticos" },
    { "gid": "1333824946", "name": "Antissépticos" },
    { "gid": "551218037",  "name": "Antitussígenos" },
    { "gid": "132076127",  "name": "Antivaricosos" },
    { "gid": "368598785",  "name": "Antiácidos" },
    { "gid": "1057228386", "name": "Antídotos, agentes quelantes e outros" },
    { "gid": "1424426563", "name": "Broncodilatadores" },
    { "gid": "258241824",  "name": "Corticosteróides" },
    { "gid": "1184992018", "name": "Dissuasores de álcool" },
    { "gid": "142814384",  "name": "Diuréticos" },
    { "gid": "1554213437", "name": "Emolientes, demulcentes e protetores" },
    { "gid": "2005343620", "name": "Espasmolíticos" },
    { "gid": "1203728329", "name": "Expectorantes" },
    { "gid": "542940365",  "name": "Fornecedores de água e sais minerais" },
    { "gid": "1781539542", "name": "Anti-hipertensivos" },
    { "gid": "1393215463", "name": "Anti-inflamatórios locais" },
    { "gid": "1927396219", "name": "Antianêmicos" },
    { "gid": "1077847451", "name": "Fármacos antiarrítmicos" },
    { "gid": "834788399",  "name": "Antiobesidade" },
    { "gid": "579731426",  "name": "Antiprotozoários para distúrbios gastrintestinais" },
    { "gid": "46875283",   "name": "Antivertiginosos" },
    { "gid": "37066094",   "name": "Fármacos com outros usos terapêuticos" },
    { "gid": "17226000",   "name": "Coagulação sanguínea e hemostípticos" },
    { "gid": "1946266019", "name": "Fármacos para hiperparatireoidismo" },
    { "gid": "1138414149", "name": "Fármacos para hipotireoidismo" },
    { "gid": "293362851",  "name": "Fármacos para insuficiência cardíaca congestiva" },
    { "gid": "264388654",  "name": "Fármacos para o resfriado/gripe" },
    { "gid": "1275257911", "name": "Ansiolíticos" },
    { "gid": "1253291853", "name": "Antidepressivos" },
    { "gid": "1803919161", "name": "Antiepilépticos" },
    { "gid": "920573383",  "name": "Antipsicóticos" },
    { "gid": "725911",     "name": "Antidemência" },
    { "gid": "329680812",  "name": "Psicoestimulantes" },
    { "gid": "2138352132", "name": "Sedativos ansiolíticos" },
    { "gid": "1736193150", "name": "Sedativos hipnóticos" },
    { "gid": "983295901",  "name": "Fármacos que atuam no metabolismo do ácido úrico" },
    { "gid": "382171978",  "name": "Fármacos usados no tratamento da gota" },
    { "gid": "400958663",  "name": "Hipnoanalgésicos" },
    { "gid": "1238735812", "name": "Inibidores específicos da reabsorção óssea" },
    { "gid": "1840608601", "name": "Laxantes de contato" },
    { "gid": "175034763",  "name": "Medicamento Antroposófico" },
    { "gid": "981256256",  "name": "Medicamentos nasofaríngeos" },
    { "gid": "675507405",  "name": "Medicamentos otológicos" },
    { "gid": "1413136239", "name": "Medicamentos para distúrbios gastrointestinais funcionais" },
    { "gid": "310730728",  "name": "Miorrelaxantes" },
    { "gid": "588781851",  "name": "Outros analgésicos" },
    { "gid": "235558101",  "name": "Outros fármacos para constipação" },
    { "gid": "1270044698", "name": "Probiótico" },
    { "gid": "655464895",  "name": "Quimioterápicos/Antissépticos para o trato urinário" },
    { "gid": "2102197488", "name": "Sangue e frações do sangue" },
    { "gid": "1176403748", "name": "Tranquilizantes" },
    { "gid": "897302584",  "name": "Tratamento de doenças degenerativas e traumáticas das articulações" },
    { "gid": "1272484250", "name": "Tratamento de perda de massa óssea" },
    { "gid": "326771482",  "name": "lostáticos e Hansenostáticos" },
    { "gid": "1783656678", "name": "Uso Sistêmico" },
    { "gid": "552279527",  "name": "Vasoconstritores" },
    { "gid": "225561128",  "name": "Vitaminas" },
    { "gid": "1285273334", "name": "Agentes antibacterianos" }
  ];
}
        return tabs;
      }catch(e){
        return [{ gid:"0", name:"Medicamentos" }];
      }
    }

    async function fetchGvizByGid(gid){
      const url = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SHEET_ID)}/gviz/tq?gid=${encodeURIComponent(gid)}&tqx=out:json`;
      const res = await fetch(url, { cache:"no-store" });
      const txt = await res.text();
      const jsonStr = txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1);
      const data = JSON.parse(jsonStr);
      const rows = (data.table && data.table.rows) ? data.table.rows : [];
      return rows;
    }

    async function loadSheetDB(){
      if(state.db.loading) return;
      state.db.loading = true;
      state.db.loaded = false;
      state.db.list = [];

      try{
        const tabs = await fetchSheetTabsFromPubhtml();
        state.db.tabs = tabs;

        const temp = [];

        for(const tab of tabs){
          let rows = [];
          try{
            rows = await fetchGvizByGid(tab.gid);
          }catch(e){
            continue;
          }

          rows.forEach((r, idx)=>{
            const c = r.c || [];
            const A = safeText(c[0]?.v ?? "");
            const B = safeText(c[1]?.v ?? "");
            const C = safeText(c[2]?.v ?? "");

            // pula linhas vazias
            if(!A && !B) return;

            // heurística simples para ignorar cabeçalho
            if(idx === 0){
              const aK = keyify(A);
              const bK = keyify(B);
              if(aK.includes("nome") && (aK.includes("gener") || aK.includes("principal"))) return;
              if(bK.includes("nome") && bK.includes("comerc")) return;
            }

            temp.push({
              a: A,
              b: B,
              color: C,
              cat: tab.name || `Aba ${tab.gid}`,
            });
          });
        }

        // unifica por A|B (item único por medicamento)
        const map = new Map();
        for(const it of temp){
          const k = keyify(it.a) + "|" + keyify(it.b);
          if(!map.has(k)){
            map.set(k, {
              a: it.a,
              b: it.b,
              color: it.color,
              cats: [it.cat]
            });
          }else{
            const cur = map.get(k);
            // agrega categorias
            if(it.cat && !cur.cats.includes(it.cat)) cur.cats.push(it.cat);
            // se não tinha cor, pega
            if(!safeText(cur.color) && safeText(it.color)) cur.color = it.color;
          }
        }

        const list = Array.from(map.values()).map(x=>{
          const a = safeText(x.a);
          const b = safeText(x.b);
          const cats = Array.isArray(x.cats) ? x.cats.filter(Boolean) : [];
          const catLabel = cats.length
            ? (cats[0] + (cats.length > 1 ? ` +${cats.length-1}` : ""))
            : "—";

          return {
            a,
            b,
            cats,
            catLabel,
            color: sanitizeColor(x.color),
            search: keyify([a,b,cats.join(" ")].join(" "))
          };
        });

        list.sort((p,q)=>{
          const A = (p.a || p.b || "").localeCompare((q.a || q.b || ""), "pt-BR", { sensitivity:"base" });
          if(A !== 0) return A;
          return (p.b||"").localeCompare((q.b||""), "pt-BR", { sensitivity:"base" });
        });

        state.db.list = list;
        state.db.loaded = true;
      }catch(e){
        state.db.loaded = false;
        state.db.list = [];
      }finally{
        state.db.loading = false;
      }
    }

    /************************************************************
     * CRM / RQE lists
     ************************************************************/
    function buildLineRow(type, idx){
      const row = document.createElement("div");
      row.className = "row";
      row.style.alignItems = "center";
      row.style.justifyContent = "stretch";
      row.style.gap = "8px";
      row.style.marginBottom = "8px";

      const input = document.createElement("input");
      input.className = "field";
      input.placeholder = type === "crm"
        ? (idx===0 ? "CRM (ex: CRM-BA 12345)" : `CRM ${idx+1}`)
        : (idx===0 ? "RQE (ex: RQE 9876)" : `RQE ${idx+1}`);
      input.inputMode = "text";
      input.autocomplete = "off";
      input.spellcheck = false;

      input.value = (type==="crm" ? state.crms[idx] : state.rqes[idx]) || "";

      input.addEventListener("input", ()=>{
        const v = safeText(input.value);
        if(type==="crm") state.crms[idx] = v;
        else state.rqes[idx] = v;

        updateSummaries();
        renderPaperDebounced();
        saveProfileDebounced();
      });

      const del = document.createElement("button");
      del.className = "iconBtn iconBtnDanger";
      del.type = "button";
      del.textContent = "✕";
      del.title = "Remover";
      const arr = (type==="crm") ? state.crms : state.rqes;
      del.disabled = arr.length === 1;
      del.style.opacity = (arr.length === 1) ? .45 : 1;

      del.addEventListener("click", ()=>{
        const arr2 = (type==="crm") ? state.crms : state.rqes;
        if(arr2.length === 1) return;

        arr2.splice(idx, 1);
        if(type==="crm") renderCrmList();
        else renderRqeList();

        updateSummaries();
        renderPaperDebounced();
        saveProfileDebounced();
      });

      row.appendChild(input);
      row.appendChild(del);
      return row;
    }

    function renderCrmList(){
      const box = $("crmList");
      box.innerHTML = "";
      state.crms.forEach((_, idx)=> box.appendChild(buildLineRow("crm", idx)));
    }
    function renderRqeList(){
      const box = $("rqeList");
      box.innerHTML = "";
      state.rqes.forEach((_, idx)=> box.appendChild(buildLineRow("rqe", idx)));
    }

    /************************************************************
     * Padrões — aplicar / editar / excluir
     ************************************************************/
    function refreshPatternSelect(){
      const sel = $("patternSelect");
      sel.innerHTML = `<option value="" selected>Nenhum padrão</option>`;

      const hasUser = !!(state.user && state.user.email);
      sel.disabled = !hasUser;
      $("btnApplyPattern").disabled = !hasUser;
      $("btnEditPattern").disabled = !hasUser;
      $("btnDeletePattern").disabled = !hasUser;

      if(!hasUser) return;

      const arr = loadPatterns();
      arr.forEach(p=>{
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name || "Sem nome";
        sel.appendChild(opt);
      });
    }

    function setThumbs(){
      const h = safeText(state.headerImgData || state.headerImgUrl) || PLACEHOLDER_PNG;
      const f = safeText(state.footerImgData || state.footerImgUrl) || PLACEHOLDER_PNG;
      $("headerThumb").src = h;
      $("footerThumb").src = f;
    }

    function applyPatternById(pid){
      if(!pid) return;
      const arr = loadPatterns();
      const p = arr.find(x=> x.id === pid);
      if(!p) return;

      state.paperSize = (p.paperSize==="LETTER"||p.paperSize==="A5"||p.paperSize==="LEGAL") ? p.paperSize : "A4";
      state.includeDate = (p.includeDate !== false);
      state.dateValue = safeText(p.dateValue) || state.dateValue;
      state.rxFontSize = isFinite(parseFloat(p.rxFontSize)) ? parseFloat(p.rxFontSize) : state.rxFontSize;
      state.rxFontFamily = (p.rxFontFamily==="ARIAL"||p.rxFontFamily==="CALIBRI") ? p.rxFontFamily : "TIMES";

      state.instName = safeText(p.instName);
      state.addrStreet = safeText(p.addrStreet);
      state.addrNumber = safeText(p.addrNumber);
      state.addrDistrict = safeText(p.addrDistrict);
      state.addrCity = safeText(p.addrCity);
      state.addrState = safeText(p.addrState);
      state.addrCep = safeText(p.addrCep);

      state.headerImgData = safeText(p.headerImgData);
      state.headerImgUrl = safeText(p.headerImgUrl);
      state.footerImgData = safeText(p.footerImgData);
      state.footerImgUrl = safeText(p.footerImgUrl);

      syncConfigFieldsFromState();
      setThumbs();

      updateSummaries();
      renderPaperDebounced();
    }

    function deletePatternById(pid){
      if(!pid) return;
      if(!confirm("Excluir este padrão?")) return;
      const arr = loadPatterns().filter(x=> x.id !== pid);
      savePatterns(arr);
      refreshPatternSelect();
      $("patternSelect").value = "";
    }

    function upsertPatternFromFields(editingId){
      const name = safeText($("patternName").value);
      if(!name){
        alert("Defina um nome para o padrão.");
        return null;
      }

      readConfigFieldsToState();

      const payload = {
        id: editingId || uid(),
        name,
        paperSize: state.paperSize,
        includeDate: !!state.includeDate,
        dateValue: safeText(state.dateValue),
        rxFontSize: rxFontPx(),
        rxFontFamily: state.rxFontFamily,

        instName: safeText(state.instName),
        addrStreet: safeText(state.addrStreet),
        addrNumber: safeText(state.addrNumber),
        addrDistrict: safeText(state.addrDistrict),
        addrCity: safeText(state.addrCity),
        addrState: safeText(state.addrState),
        addrCep: safeText(state.addrCep),

        headerImgData: safeText(state.headerImgData),
        headerImgUrl: safeText(state.headerImgUrl),
        footerImgData: safeText(state.footerImgData),
        footerImgUrl: safeText(state.footerImgUrl),
      };

      const arr = loadPatterns();
      const i = arr.findIndex(x=> x.id === payload.id);
      if(i >= 0) arr[i] = payload;
      else arr.push(payload);
      savePatterns(arr);
      refreshPatternSelect();
      $("patternSelect").value = payload.id;
      return payload.id;
    }

    /************************************************************
     * Config Modal open/close + fields sync
     ************************************************************/
    let editingPatternId = null;

    function openConfig(){
      $("configMask").style.display = "flex";
      $("configMask").setAttribute("aria-hidden","false");

      refreshPatternSelect();
      syncConfigFieldsFromState();
      setThumbs();

      $("newPatternArea").style.display = "none";
      $("btnToggleNewPattern").textContent = "+ Criar novo padrão";
      editingPatternId = null;
      $("patternName").value = "";
    }

    function closeConfig(){
      $("configMask").style.display = "none";
      $("configMask").setAttribute("aria-hidden","true");
      editingPatternId = null;
    }

    function syncConfigFieldsFromState(){
      $("paperSize").value = state.paperSize;
      $("includeDate").checked = !!state.includeDate;
      $("dateValue").value = safeText(state.dateValue);
      $("rxFontFamily").value = state.rxFontFamily;
      $("rxFontSize").value = String(rxFontPx()).replace(".", ".");

      $("instName").value = safeText(state.instName);
      $("addrStreet").value = safeText(state.addrStreet);
      $("addrNumber").value = safeText(state.addrNumber);
      $("addrDistrict").value = safeText(state.addrDistrict);
      $("addrCity").value = safeText(state.addrCity);
      $("addrState").value = safeText(state.addrState);
      $("addrCep").value = safeText(state.addrCep);

      $("headerUrl").value = safeText(state.headerImgUrl);
      $("footerUrl").value = safeText(state.footerImgUrl);
    }

    function readConfigFieldsToState(){
      const ps = $("paperSize").value;
      state.paperSize = (ps==="LETTER"||ps==="A5"||ps==="LEGAL") ? ps : "A4";

      state.includeDate = !!$("includeDate").checked;
      state.dateValue = safeText($("dateValue").value);

      const fam = $("rxFontFamily").value;
      state.rxFontFamily = (fam==="ARIAL"||fam==="CALIBRI") ? fam : "TIMES";

      const fz = safeText($("rxFontSize").value).replace(",", ".");
      state.rxFontSize = parseFloat(fz) || state.rxFontSize;

      state.instName = safeText($("instName").value);
      state.addrStreet = safeText($("addrStreet").value);
      state.addrNumber = safeText($("addrNumber").value);
      state.addrDistrict = safeText($("addrDistrict").value);
      state.addrCity = safeText($("addrCity").value);
      state.addrState = safeText($("addrState").value).toUpperCase().slice(0,2);
      state.addrCep = safeText($("addrCep").value);

      state.headerImgUrl = safeText($("headerUrl").value);
      if(state.headerImgUrl) state.headerImgData = "";
      state.footerImgUrl = safeText($("footerUrl").value);
      if(state.footerImgUrl) state.footerImgData = "";
    }

    function toggleNewPatternArea(){
      const area = $("newPatternArea");
      const on = area.style.display === "block";
      area.style.display = on ? "none" : "block";
      $("btnToggleNewPattern").textContent = on ? "+ Criar novo padrão" : "— Ocultar criação";

      if(!on){
        editingPatternId = null;
        $("patternName").value = "";
        syncConfigFieldsFromState();
        setThumbs();
      }
    }

    function editSelectedPattern(){
      const pid = $("patternSelect").value;
      if(!pid) return;

      const arr = loadPatterns();
      const p = arr.find(x=> x.id === pid);
      if(!p) return;

      editingPatternId = p.id;
      applyPatternById(pid);

      $("patternName").value = p.name || "";
      $("newPatternArea").style.display = "block";
      $("btnToggleNewPattern").textContent = "— Ocultar criação";
    }

    function pickImageTo(target){
      const input = (target === "header") ? $("fileHeader") : $("fileFooter");
      input.click();
    }

    function handlePickedFile(target, file){
      if(!file) return;
      const r = new FileReader();
      r.onload = ()=>{
        if(target === "header"){
          state.headerImgData = r.result;
          state.headerImgUrl = "";
          $("headerUrl").value = "";
        }else{
          state.footerImgData = r.result;
          state.footerImgUrl = "";
          $("footerUrl").value = "";
        }
        setThumbs();
        renderPaperDebounced();
      };
      r.readAsDataURL(file);
    }

    /************************************************************
     * Medicine blocks (autocomplete novo — múltiplas abas)
     ************************************************************/
    const ICON_LIBRARY = [
      { key:"MANHA", label:"Manhã", ico:"☀️" },
      { key:"TARDE", label:"Tarde", ico:"🌤️" },
      { key:"NOITE", label:"Noite", ico:"🌙" },
      { key:"JEJUM", label:"Jejum", ico:"☕" },
      { key:"ANTES_ALMOCO", label:"Antes almoço", ico:"🍽️" },
      { key:"ANTES_JANTAR", label:"Antes jantar", ico:"🍲" },
      { key:"APOS", label:"Após refeição", ico:"✅" },
      { key:"8H", label:"8/8h", ico:"⏱️" },
      { key:"12H", label:"12/12h", ico:"⏱️" },
    ];

    function addBlock({focusName=true} = {}){
      state.blocks.forEach(b=> b.collapsed = true);

      const b = {
        id: uid(),
        name:"",
        dose:"",
        qty:"",
        use:"",
        collapsed:false,
        showIcons:true,
        icons:[]
      };
      state.blocks.push(b);

      appendBlockDOM(b, state.blocks.length-1);

      updateSummaries();
      renderPaperDebounced();

      if(focusName){
        setTimeout(()=>{
          const el = document.querySelector(`[data-block="${b.id}"] input[data-field="name"]`);
          if(el) el.focus({ preventScroll:true });
        }, 0);
      }
    }

    function removeBlock(id){
      const idx = state.blocks.findIndex(x=> x.id === id);
      if(idx < 0) return;

      state.blocks.splice(idx,1);
      const el = document.querySelector(`[data-block="${id}"]`);
      if(el) el.remove();

      renumberBlocks();

      if(state.blocks.length && !state.blocks.some(b=> !b.collapsed)){
        state.blocks[state.blocks.length-1].collapsed = false;
        const lastEl = document.querySelector(`[data-block="${state.blocks[state.blocks.length-1].id}"]`);
        if(lastEl) lastEl.classList.remove("collapsed");
      }

      updateSummaries();
      renderPaperDebounced();
    }

    function toggleBlock(id){
      const b = state.blocks.find(x=> x.id === id);
      const el = document.querySelector(`[data-block="${id}"]`);
      if(!b || !el) return;
      b.collapsed = !b.collapsed;
      el.classList.toggle("collapsed", !!b.collapsed);
    }

    function renumberBlocks(){
      const nodes = document.querySelectorAll(".rxBlock");
      nodes.forEach((node, i)=>{
        const num = node.querySelector(".rxNum");
        if(num) num.textContent = String(i+1);

        const bid = node.getAttribute("data-block");
        const b = state.blocks.find(x=> x.id === bid);
        const title = node.querySelector(".rxTitle strong");
        if(title){
          const nm = (b && safeText(b.name)) ? safeText(b.name) : `Remédio ${i+1}`;
          const ds = (b && safeText(b.dose)) ? " " + safeText(b.dose) : "";
          title.textContent = nm + ds;
        }
      });
    }

    function renderBlocksInitial(){
      const root = $("rxBlocks");
      root.innerHTML = "";
      state.blocks.forEach((b, idx)=> appendBlockDOM(b, idx));
      renumberBlocks();
    }

    function appendBlockDOM(b, idx){
      const root = $("rxBlocks");

      const wrap = document.createElement("div");
      wrap.className = "rxBlock" + (b.collapsed ? " collapsed" : "");
      wrap.setAttribute("data-block", b.id);

      const top = document.createElement("div");
      top.className = "rxTop";

      const title = document.createElement("div");
      title.className = "rxTitle";

      const num = document.createElement("div");
      num.className = "rxNum";
      num.textContent = String(idx+1);

      const tcol = document.createElement("div");
      tcol.style.display = "flex";
      tcol.style.flexDirection = "column";
      tcol.style.gap = "2px";

      const strong = document.createElement("strong");
      strong.textContent = b.name ? b.name : `Remédio ${idx+1}`;

      const small = document.createElement("div");
      small.className = "mini";
      small.style.marginTop = "0";
      small.style.color = "var(--muted)";
      small.textContent = b.collapsed ? "Clique para expandir e editar" : "Edite nome, dosagem, quantidade e ícones";

      tcol.appendChild(strong);
      tcol.appendChild(small);

      title.appendChild(num);
      title.appendChild(tcol);

      const tools = document.createElement("div");
      tools.className = "rxTools";

      const btnMin = document.createElement("button");
      btnMin.className = "iconBtn iconBtnDim";
      btnMin.type = "button";
      btnMin.title = b.collapsed ? "Expandir" : "Minimizar";
      btnMin.textContent = b.collapsed ? "▾" : "▴";
      btnMin.addEventListener("click", ()=>{
        toggleBlock(b.id);
        btnMin.textContent = (b.collapsed ? "▾" : "▴");
        btnMin.title = (b.collapsed ? "Expandir" : "Minimizar");
      });

      const btnDel = document.createElement("button");
      btnDel.className = "iconBtn iconBtnDanger";
      btnDel.type = "button";
      btnDel.title = "Remover";
      btnDel.textContent = "✕";
      btnDel.addEventListener("click", ()=> removeBlock(b.id));

      tools.appendChild(btnMin);
      tools.appendChild(btnDel);

      top.appendChild(title);
      top.appendChild(tools);

      const body = document.createElement("div");
      body.className = "rxExpandedBody";

      const grid = document.createElement("div");
      grid.className = "rxGrid";

      // Nome + autocomplete (novo)
      const col1 = document.createElement("div");
      const lab1 = document.createElement("label");
      lab1.className = "label";
      lab1.textContent = "Nome do medicamento";
      col1.appendChild(lab1);

      const acWrap = document.createElement("div");
      acWrap.className = "acWrap";

      const inpName = document.createElement("input");
      inpName.className = "field";
      inpName.placeholder = "Ex: Losartana potássica";
      inpName.value = b.name || "";
      inpName.setAttribute("data-field","name");
      inpName.autocomplete = "off";
      inpName.spellcheck = false;
      inpName.inputMode = "text";

      const acList = document.createElement("div");
      acList.className = "acList";

      function closeList(){
        acList.style.display = "none";
        acList.innerHTML = "";
      }
      function openList(){ acList.style.display = "block"; }

      function applyChoice(it, mode){
        const A = safeText(it.a);
        const B = safeText(it.b);

        let txt = "";
        if(mode === "A") txt = A || B;
        else if(mode === "B") txt = B || A;
        else txt = (A && B) ? `${B} (${A})` : (B || A);

        b.name = txt;
        inpName.value = txt;

        const nm = txt ? txt : `Remédio ${idx+1}`;
        const ds = safeText(b.dose) ? " " + safeText(b.dose) : "";
        strong.textContent = nm + ds;

        closeList();
        renderPaperDebounced();
        updateSummaries();
      }

      function renderHits(hits, q){
        acList.innerHTML = "";

        if(!hits.length){
          const d = document.createElement("div");
          d.className = "acEmpty";
          d.textContent = q ? "Nenhum resultado. Continue digitando ou insira manualmente." : "Digite para buscar. (A planilha é consultada em todas as abas.)";
          acList.appendChild(d);
          openList();
          return;
        }

        hits.forEach((it)=>{
          const item = document.createElement("div");
          item.className = "medItem";

          const dot = document.createElement("div");
          dot.className = "medDot";
          dot.style.background = sanitizeColor(it.color);

          const main = document.createElement("div");
          main.className = "medMain";

          const topRow = document.createElement("div");
          topRow.className = "medTopRow";

          const txtBox = document.createElement("div");
          txtBox.style.minWidth = "0";

          const lineA = document.createElement("div");
          lineA.className = "medA";
          lineA.textContent = it.a || it.b || "—";

          const lineB = document.createElement("div");
          lineB.className = "medB";
          lineB.textContent = it.b ? it.b : (it.a ? "—" : "");

          txtBox.appendChild(lineA);
          txtBox.appendChild(lineB);

          const tag = document.createElement("div");
          tag.className = "medTag";
          tag.textContent = it.catLabel || "—";

          topRow.appendChild(txtBox);
          topRow.appendChild(tag);

          const subs = document.createElement("div");
          subs.className = "medSubs";

          const btnA = document.createElement("button");
          btnA.className = "subBtn";
          btnA.type = "button";
          btnA.textContent = "Inserir Genérico (A)";
          btnA.addEventListener("mousedown", (ev)=>{ ev.preventDefault(); applyChoice(it, "A"); });

          const btnB = document.createElement("button");
          btnB.className = "subBtn";
          btnB.type = "button";
          btnB.textContent = "Inserir Comercial (B)";
          btnB.addEventListener("mousedown", (ev)=>{ ev.preventDefault(); applyChoice(it, "B"); });

          const btnAB = document.createElement("button");
          btnAB.className = "subBtn";
          btnAB.type = "button";
          btnAB.textContent = "Inserir B (A)";
          btnAB.addEventListener("mousedown", (ev)=>{ ev.preventDefault(); applyChoice(it, "AB"); });

          subs.appendChild(btnA);
          subs.appendChild(btnB);
          subs.appendChild(btnAB);

          main.appendChild(topRow);
          main.appendChild(subs);

          item.appendChild(dot);
          item.appendChild(main);

          // abre/fecha subitens (sem duplicar resultados)
          item.addEventListener("mousedown", (ev)=>{
            // se clicou em botão, deixa o handler do botão agir
            if(ev.target && ev.target.closest && ev.target.closest("button")) return;
            ev.preventDefault();
            const open = item.classList.toggle("open");
            // fecha outros
            Array.from(acList.querySelectorAll(".medItem.open")).forEach(x=>{
              if(x !== item) x.classList.remove("open");
            });
            // se abriu, não fecha a lista
            if(open) openList();
          });

          acList.appendChild(item);
        });

        openList();
      }

      function computeHits(q){
        const hits = [];
        if(!state.db.loaded) return hits;

        if(!q){
          // sem query: mostra primeiros
          for(const it of state.db.list){
            hits.push(it);
            if(hits.length >= 10) break;
          }
          return hits;
        }

        for(const it of state.db.list){
          if(it.search && it.search.includes(q)) hits.push(it);
          if(hits.length >= 12) break;
        }
        return hits;
      }

      inpName.addEventListener("input", ()=>{
        b.name = safeText(inpName.value);

        const nm = b.name ? b.name : `Remédio ${idx+1}`;
        const ds = safeText(b.dose) ? " " + safeText(b.dose) : "";
        strong.textContent = nm + ds;

        renderPaperDebounced();
        updateSummaries();

        const q = keyify(b.name);

        // se ainda está carregando ou não carregou, não quebra: apenas fecha
        if(state.db.loading){
          acList.innerHTML = `<div class="acEmpty">Carregando planilha…</div>`;
          openList();
          return;
        }
        if(!state.db.loaded){
          closeList();
          return;
        }

        const hits = computeHits(q);
        renderHits(hits, q);
      });

      inpName.addEventListener("focus", ()=>{
        if(state.db.loading){
          acList.innerHTML = `<div class="acEmpty">Carregando planilha…</div>`;
          openList();
          return;
        }
        if(state.db.loaded){
          const q = keyify(safeText(inpName.value));
          const hits = computeHits(q);
          renderHits(hits, q);
        }
      });

      inpName.addEventListener("blur", ()=> setTimeout(closeList, 180));

      acWrap.appendChild(inpName);
      acWrap.appendChild(acList);
      col1.appendChild(acWrap);

      // Dosagem
      const colDose = document.createElement("div");
      const labDose = document.createElement("label");
      labDose.className = "label";
      labDose.textContent = "Dosagem";
      colDose.appendChild(labDose);

      const inpDose = document.createElement("input");
      inpDose.className = "field";
      inpDose.placeholder = "Ex: 50mg";
      inpDose.value = b.dose || "";
      inpDose.setAttribute("data-field","dose");
      inpDose.autocomplete = "off";
      inpDose.spellcheck = false;
      inpDose.inputMode = "text";
      inpDose.addEventListener("input", ()=>{
        b.dose = safeText(inpDose.value);
        const nm = safeText(b.name) ? safeText(b.name) : `Remédio ${idx+1}`;
        const ds = safeText(b.dose) ? " " + safeText(b.dose) : "";
        strong.textContent = nm + ds;
        renderPaperDebounced();
      });
      colDose.appendChild(inpDose);

      // Quantidade
      const col2 = document.createElement("div");
      const lab2 = document.createElement("label");
      lab2.className = "label";
      lab2.textContent = "Quantidade / Apresentação";
      col2.appendChild(lab2);

      const inpQty = document.createElement("input");
      inpQty.className = "field";
      inpQty.placeholder = "Ex: 30 comprimidos";
      inpQty.value = b.qty || "";
      inpQty.setAttribute("data-field","qty");
      inpQty.autocomplete = "off";
      inpQty.spellcheck = false;
      inpQty.inputMode = "text";
      inpQty.addEventListener("input", ()=>{
        b.qty = safeText(inpQty.value);
        renderPaperDebounced();
      });

      col2.appendChild(inpQty);

      grid.appendChild(col1);
      grid.appendChild(colDose);
      grid.appendChild(col2);

      body.appendChild(grid);

      // Posologia (fica no editor, mas na receita sai “linha do uso”)
      const full = document.createElement("div");
      full.className = "rxFull";
      const lab3 = document.createElement("label");
      lab3.className = "label";
      lab3.textContent = "Posologia / Orientações";

      const ta = document.createElement("textarea");
      ta.className = "field";
      ta.placeholder = "Ex: Tomar 1 comprimido pela manhã por 30 dias.";
      ta.value = b.use || "";
      ta.autocomplete = "off";
      ta.spellcheck = true;
      ta.addEventListener("input", ()=>{
        b.use = safeText(ta.value);
        renderPaperDebounced();
      });

      full.appendChild(lab3);
      full.appendChild(ta);

      body.appendChild(full);

      // Ícones
      const iconTools = document.createElement("div");
      iconTools.className = "rxFull";

      const labIcons = document.createElement("label");
      labIcons.className = "label";
      labIcons.textContent = "Ícones (horário/rotina) — para facilitar a compreensão";

      const togIcons = document.createElement("label");
      togIcons.className = "toggle";
      togIcons.title = "Mostrar/ocultar ícones na receita";
      togIcons.innerHTML = `<input type="checkbox"><span>Mostrar ícones</span>`;
      const iconsCheck = togIcons.querySelector("input");
      iconsCheck.checked = (b.showIcons !== false);
      iconsCheck.addEventListener("change", ()=>{
        b.showIcons = !!iconsCheck.checked;
        renderPaperDebounced();
      });

      const iconPick = document.createElement("div");
      iconPick.className = "iconPick";

      function isOn(k){ return Array.isArray(b.icons) && b.icons.includes(k); }
      function toggleIcon(k){
        b.icons = Array.isArray(b.icons) ? b.icons : [];
        if(b.icons.includes(k)) b.icons = b.icons.filter(x=> x !== k);
        else b.icons.push(k);
        renderPaperDebounced();
      }

      ICON_LIBRARY.forEach(it=>{
        const tag = document.createElement("div");
        tag.className = "iconTag" + (isOn(it.key) ? " on" : "");
        tag.innerHTML = `<span>${it.ico}</span><span>${it.label}</span>`;
        tag.addEventListener("click", ()=>{
          toggleIcon(it.key);
          tag.classList.toggle("on", isOn(it.key));
        });
        iconPick.appendChild(tag);
      });

      iconTools.appendChild(labIcons);
      iconTools.appendChild(togIcons);
      iconTools.appendChild(iconPick);

      body.appendChild(iconTools);

      wrap.appendChild(top);
      wrap.appendChild(body);

      root.appendChild(wrap);

      // minimiza anteriores
      document.querySelectorAll(".rxBlock").forEach(node=>{
        const bid = node.getAttribute("data-block");
        if(bid && bid !== b.id){
          node.classList.add("collapsed");
          const bb = state.blocks.find(x=> x.id === bid);
          if(bb) bb.collapsed = true;
          const btn = node.querySelector(".rxTools .iconBtnDim");
          if(btn){ btn.textContent = "▾"; btn.title = "Expandir"; }
        }
      });

      renumberBlocks();
    }

    /************************************************************
     * Summaries
     ************************************************************/
    function updateSummaries(){
      const medName = safeText(state.docName);
      const crms = state.crms.map(safeText).filter(Boolean);
      $("sumMedico").textContent = medName
        ? `${state.docTitle} ${medName}${crms.length ? " • " + crms[0] : ""}`
        : "Preencha nome/CRM";

      const pName = safeText(state.patientName);
      const pType = safeText(state.patientDocType);
      const pDoc = safeText(state.patientDocValue);
      $("sumPaciente").textContent = pName
        ? (pDoc ? `${pName} • ${pType}: ${pDoc}` : pName)
        : "Preencha o paciente";

      $("sumMeds").textContent = state.blocks.length
        ? `${state.blocks.length} item(ns) • ${medsPerPage()} por página`
        : "Adicione remédios";
    }

    /************************************************************
     * Paper render — branco, margens seguras, R// obrigatório, numerado
     ************************************************************/
    function formatInstitutionAddress(){
      const st = safeText(state.addrStreet);
      const no = safeText(state.addrNumber);
      const di = safeText(state.addrDistrict);
      const ci = safeText(state.addrCity);
      const uf = safeText(state.addrState).toUpperCase();
      const cep = safeText(state.addrCep);

      const parts = [];
      const line1 = [st, no ? "nº " + no : ""].filter(Boolean).join(", ");
      if(line1) parts.push(line1);

      const line2 = [di, ci && uf ? `${ci}-${uf}` : (ci || uf)].filter(Boolean).join(". ");
      if(line2) parts.push(line2);

      if(cep) parts.push(`CEP. ${cep}`);

      return parts.join(". ");
    }

    function docFooterHTML(){
      const title = safeText(state.docTitle);
      const name = safeText(state.docName);

      const crms = (state.crms || []).map(safeText).filter(Boolean);
      const rqes = (state.rqes || []).map(safeText).filter(Boolean);

      const lines = [];
      if(crms.length) lines.push(crms.join(" • "));
      if(rqes.length) lines.push(rqes.join(" • "));

      const displayName = [title, name].filter(Boolean).join(" ");

      const instN = safeText(state.instName);
      const instA = formatInstitutionAddress();

      const instBlock = (instN || instA) ? `
        <div class="instFooterGray">
          ${instN ? `<div style="font-weight:900;">${instN}</div>` : ""}
          ${instA ? `<div>${instA}</div>` : ""}
        </div>
      ` : "";

      const inner = `
        <div class="sigLine"></div>
        <div class="docCenter">
          <div class="docName">${displayName || "&nbsp;"}</div>
          ${lines.map(l=> `<div class="docLine">${l}</div>`).join("") || `<div class="docLine">&nbsp;</div>`}
        </div>
        ${instBlock}
      `;

      return `
        <div class="sigWrap">
          <div style="text-align:center;">
            <div class="docSig">${inner}</div>
          </div>
        </div>
      `;
    }

    function headerImgSrc(){ return safeText(state.headerImgData || state.headerImgUrl); }
    function footerImgSrc(){ return safeText(state.footerImgData || state.footerImgUrl); }

    function iconsHTML(b){
      if(!b || b.showIcons === false) return "";
      const arr = Array.isArray(b.icons) ? b.icons : [];
      if(!arr.length) return "";
      const icons = arr.map(k=>{
        const it = ICON_LIBRARY.find(x=> x.key === k);
        return it ? `<span>${it.ico} ${it.label}</span>` : "";
      }).filter(Boolean).join("");
      if(!icons) return "";
      return `<div class="useIconsBelow">${icons}</div>`;
    }

    function pageHTML(blocks, startIndex){
      const patient = safeText(state.patientName);
      const docType = safeText(state.patientDocType) || "CPF";
      const docVal = safeText(state.patientDocValue);

      const showDate = !!state.includeDate;
      const date = safeText(state.dateValue);

      const rxFont = rxFontPx().toFixed(1) + "px";
      const rxFamily = rxFamilyCSS();

      const items = blocks.map((b, i)=>{
        const n = (startIndex || 0) + i + 1;

        const name = safeText(b.name) || "—";
        const dose = safeText(b.dose) || "";
        const showName = dose ? `${name} ${dose}` : name;

        const qty = safeText(b.qty) || "";
        const use = safeText(b.use) || "";

        const qtyPart = qty
          ? `<div class="qty">${qty}</div>`
          : `<div class="qty" style="opacity:.55;">&nbsp;</div>`;

        const instr = use ? `<div class="rxInstr">${use}</div>` : ``;

        return `
          <div class="rxItem">
            <div class="rxLine">
              <div class="rxNo">${n}.</div>
              <div class="drugName">${showName}</div>
              <div class="leaderText">${leaderHyphens()}</div>
              ${qtyPart}
            </div>
            ${instr}
            ${iconsHTML(b)}
          </div>
        `;
      }).join("");

      const datePill = showDate
        ? `<div class="rxDatePill">Data: ${date || "&nbsp;"}</div>`
        : ``;

      const docInline = docVal
        ? `<span class="docInline">• ${docType}: ${docVal}</span>`
        : "";

      const hsrc = headerImgSrc();
      const fsrc = footerImgSrc();

      return `
        <div class="rxPaper" style="--rxFont:${rxFont}; --rxFamily:${rxFamily};">
          <div class="headerArea">
            ${hsrc ? `<img class="instImgSimple" src="${hsrc}" alt="" />` : ""}
          </div>

          <div class="rxMeta">
            <div class="rxPatientLine">${patient || "&nbsp;"}${docInline}</div>
            ${datePill}
          </div>

          <div class="rxDividerLine"></div>

          <div class="rxSymbol">R//</div>

          <div class="rxList">
            ${items || `<div style="font-size:12px;color:#111; font-family:Manrope,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;">Adicione medicamentos no editor.</div>`}
          </div>

          <div class="footerArea">
            ${fsrc ? `<img class="instImgSimple instImgSimple--footer" src="${fsrc}" alt="" />` : ""}
          </div>

          ${docFooterHTML()}
        </div>
      `;
    }

    function renderPaper(){
      const pages = paginateBlocks();
      const total = pages.length;

      state.selectedPage = clamp(parseInt(state.selectedPage,10) || 1, 1, total);

      const paper = $("paper");
      paper.classList.remove("paperA4","paperLetter","paperA5","paperLegal");
      if(state.paperSize==="LETTER") paper.classList.add("paperLetter");
      else if(state.paperSize==="A5") paper.classList.add("paperA5");
      else if(state.paperSize==="LEGAL") paper.classList.add("paperLegal");
      else paper.classList.add("paperA4");

      const sel = $("pageSelect");
      sel.innerHTML = "";
      for(let i=1;i<=total;i++){
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `Página ${i}`;
        if(i === state.selectedPage) opt.selected = true;
        sel.appendChild(opt);
      }

      $("pageInfo").textContent = `Página ${state.selectedPage} de ${total}`;

      const per = medsPerPage();
      const startIndex = (state.selectedPage - 1) * per;

      $("rxPaper").innerHTML = pageHTML(pages[state.selectedPage-1], startIndex);

      const printAll = $("printAll");
      printAll.innerHTML = pages.map((p, idx)=>{
        return `
          <div class="printPage">
            ${pageHTML(p, idx * per)}
          </div>
          ${idx < pages.length-1 ? `<div style="break-after:page;"></div>` : ``}
        `;
      }).join("");
    }

    function debounce(fn, ms=120){
      let t;
      return (...args)=>{
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), ms);
      };
    }
    const renderPaperDebounced = debounce(renderPaper, 90);

    /************************************************************
     * Histórico
     ************************************************************/
    function snapshotStateForHistory(){
      return {
        ts: Date.now(),
        patientName: safeText(state.patientName),
        patientDocType: safeText(state.patientDocType),
        patientDocValue: safeText(state.patientDocValue),

        docTitle: safeText(state.docTitle),
        docName: safeText(state.docName),
        crms: (state.crms||[]).map(safeText),
        rqes: (state.rqes||[]).map(safeText),

        paperSize: state.paperSize,
        includeDate: !!state.includeDate,
        dateValue: safeText(state.dateValue),
        rxFontSize: rxFontPx(),
        rxFontFamily: state.rxFontFamily,

        instName: safeText(state.instName),
        addrStreet: safeText(state.addrStreet),
        addrNumber: safeText(state.addrNumber),
        addrDistrict: safeText(state.addrDistrict),
        addrCity: safeText(state.addrCity),
        addrState: safeText(state.addrState),
        addrCep: safeText(state.addrCep),

        headerImgData: safeText(state.headerImgData),
        headerImgUrl: safeText(state.headerImgUrl),
        footerImgData: safeText(state.footerImgData),
        footerImgUrl: safeText(state.footerImgUrl),

        blocks: (state.blocks||[]).map(b=>({
          name: safeText(b.name),
          dose: safeText(b.dose),
          qty: safeText(b.qty),
          use: safeText(b.use),
          showIcons: b.showIcons !== false,
          icons: Array.isArray(b.icons) ? b.icons.slice(0) : []
        }))
      };
    }

    function saveToHistoryAndPrint(){
      if(!(state.user && state.user.email)){
        openLogin();
        return;
      }
      renderPaper();

      const snap = snapshotStateForHistory();
      const entry = {
        id: uid(),
        ts: snap.ts,
        patient: snap.patientName || "Paciente",
        pagesHTML: $("printAll").innerHTML,
        snapshot: snap
      };

      const arr = loadHistory();
      arr.unshift(entry);
      saveHistory(arr.slice(0, 200));
      window.print();
    }

    function printOnly(){
      renderPaper();
      window.print();
    }

    function isHistoryRoute(){
      const p = (location.pathname || "").toLowerCase();
      return p.includes("historico-receita");
    }

    function goToHistory(){
      window.location.href = "https://www.usojaleco.com.br/historico-receita";
    }

    function goToApp(){
      window.location.href = "https://www.usojaleco.com.br/";
    }

    function renderHistoryPage(){
      const has = !!(state.user && state.user.email);
      $("btnClearHistory").style.display = has ? "inline-flex" : "none";
      const top = $("histTopInfo");
      const list = $("histList");
      list.innerHTML = "";

      if(!has){
        top.textContent = "Faça login para ver seu histórico.";
        const msg = document.createElement("div");
        msg.className = "mini";
        msg.textContent = "Você precisa estar logado na mesma conta usada ao salvar prescrições neste dispositivo.";
        list.appendChild(msg);
        return;
      }

      const arr = loadHistory();
      top.textContent = arr.length ? `${arr.length} prescrição(ões) salva(s).` : "Nenhuma prescrição salva ainda.";

      if(!arr.length){
        const msg = document.createElement("div");
        msg.className = "mini";
        msg.textContent = "Volte para a prescrição e use “Imprimir + Guardar no Histórico”.";
        list.appendChild(msg);
        return;
      }

      arr.forEach((it)=>{
        const d = new Date(it.ts);
        const when = `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()} • ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;

        const card = document.createElement("div");
        card.className = "histItem";

        const meta = document.createElement("div");
        meta.className = "histMeta";
        meta.innerHTML = `<b>${safeText(it.patient) || "Paciente"}</b><small>${when}</small>`;

        const tools = document.createElement("div");
        tools.style.display = "flex";
        tools.style.gap = "10px";
        tools.style.alignItems = "center";
        tools.style.flexWrap = "wrap";

        const btnPrint = document.createElement("button");
        btnPrint.className = "btn btnPrimary";
        btnPrint.type = "button";
        btnPrint.textContent = "Imprimir";
        btnPrint.addEventListener("click", ()=>{
          $("printAll").innerHTML = it.pagesHTML || "";
          window.print();
        });

        const btnDel = document.createElement("button");
        btnDel.className = "btn btnGhost";
        btnDel.type = "button";
        btnDel.textContent = "Excluir";
        btnDel.addEventListener("click", ()=>{
          if(!confirm("Excluir esta prescrição do histórico?")) return;
          const next = loadHistory().filter(x=> x.id !== it.id);
          saveHistory(next);
          renderHistoryPage();
        });

        tools.appendChild(btnPrint);
        tools.appendChild(btnDel);

        card.appendChild(meta);
        card.appendChild(tools);
        list.appendChild(card);
      });
    }

    /************************************************************
     * Bind inputs
     ************************************************************/
    function bind(){
      // login
      $("btnLogin").addEventListener("click", openLogin);
      $("btnCloseLogin").addEventListener("click", closeLogin);
      $("btnCloseLogin2").addEventListener("click", closeLogin);
      $("btnLogout").addEventListener("click", logout);

      // histórico
      $("btnHistory").addEventListener("click", goToHistory);
      $("btnBackToApp").addEventListener("click", goToApp);
      $("btnClearHistory").addEventListener("click", ()=>{
        if(!(state.user && state.user.email)) return;
        if(!confirm("Limpar TODO o histórico desta conta neste dispositivo?")) return;
        saveHistory([]);
        renderHistoryPage();
      });

      // médico
      $("docTitle").addEventListener("change", (e)=>{
        state.docTitle = (e.target.value === "Dra.") ? "Dra." : "Dr.";
        updateSummaries();
        renderPaperDebounced();
        saveProfileDebounced();
      });
      $("docName").addEventListener("input", (e)=>{
        state.docName = safeText(e.target.value);
        updateSummaries();
        renderPaperDebounced();
        saveProfileDebounced();
      });

      // paciente
      $("patientName").addEventListener("input", (e)=>{
        state.patientName = safeText(e.target.value);
        updateSummaries();
        renderPaperDebounced();
      });
      $("patientDocType").addEventListener("change", (e)=>{
        state.patientDocType = (e.target.value === "RG" || e.target.value === "CNS") ? e.target.value : "CPF";
        updateSummaries();
        renderPaperDebounced();
      });
      $("patientDocValue").addEventListener("input", (e)=>{
        state.patientDocValue = safeText(e.target.value);
        updateSummaries();
        renderPaperDebounced();
      });

      // meds
      $("btnAddMed").addEventListener("click", ()=> addBlock({focusName:true}));
      $("btnAddMed2").addEventListener("click", ()=> addBlock({focusName:true}));

      $("btnClear").addEventListener("click", ()=>{
        state.patientName = "";
        state.patientDocType = "CPF";
        state.patientDocValue = "";
        state.blocks = [];
        state.selectedPage = 1;

        $("patientName").value = "";
        $("patientDocType").value = "CPF";
        $("patientDocValue").value = "";

        renderBlocksInitial();
        updateSummaries();
        renderPaperDebounced();
      });

      // navegação páginas
      $("pageSelect").addEventListener("change", (e)=>{
        state.selectedPage = parseInt(e.target.value,10) || 1;
        renderPaperDebounced();
      });
      $("btnPrevPage").addEventListener("click", ()=>{
        const pages = paginateBlocks();
        state.selectedPage = clamp(state.selectedPage - 1, 1, pages.length);
        renderPaperDebounced();
      });
      $("btnNextPage").addEventListener("click", ()=>{
        const pages = paginateBlocks();
        state.selectedPage = clamp(state.selectedPage + 1, 1, pages.length);
        renderPaperDebounced();
      });

      $("btnPrintOnly").addEventListener("click", printOnly);
      $("btnPrintSave").addEventListener("click", saveToHistoryAndPrint);

      // Config (gear)
      $("btnOpenConfig").addEventListener("click", openConfig);
      $("btnCloseConfig").addEventListener("click", closeConfig);
      $("btnCloseConfig2").addEventListener("click", closeConfig);

      // patterns actions
      $("btnApplyPattern").addEventListener("click", ()=>{
        const pid = $("patternSelect").value;
        if(!pid) return;
        applyPatternById(pid);
      });
      $("btnEditPattern").addEventListener("click", ()=>{
        if(!(state.user && state.user.email)){ openLogin(); return; }
        editSelectedPattern();
      });
      $("btnDeletePattern").addEventListener("click", ()=>{
        if(!(state.user && state.user.email)){ openLogin(); return; }
        const pid = $("patternSelect").value;
        if(!pid) return;
        deletePatternById(pid);
      });

      $("btnToggleNewPattern").addEventListener("click", ()=>{
        if(!(state.user && state.user.email)){ openLogin(); return; }
        toggleNewPatternArea();
      });
      $("btnCancelNewPattern").addEventListener("click", ()=>{
        $("newPatternArea").style.display = "none";
        $("btnToggleNewPattern").textContent = "+ Criar novo padrão";
        editingPatternId = null;
        $("patternName").value = "";
        syncConfigFieldsFromState();
        setThumbs();
      });

      // live config changes -> preview
      const live = ["paperSize","includeDate","dateValue","rxFontFamily","rxFontSize","instName","addrStreet","addrNumber","addrDistrict","addrCity","addrState","addrCep","headerUrl","footerUrl"];
      live.forEach(id=>{
        const el = $(id);
        const ev = (el && el.tagName === "SELECT") ? "change" : "input";
        el.addEventListener(ev, ()=>{
          readConfigFieldsToState();
          setThumbs();
          renderPaperDebounced();
        });
      });

      // upload header/footer
      $("btnPickHeader").addEventListener("click", ()=> pickImageTo("header"));
      $("btnPickFooter").addEventListener("click", ()=> pickImageTo("footer"));

      $("fileHeader").addEventListener("change", ()=>{
        const f = $("fileHeader").files && $("fileHeader").files[0];
        $("fileHeader").value = "";
        handlePickedFile("header", f);
      });
      $("fileFooter").addEventListener("change", ()=>{
        const f = $("fileFooter").files && $("fileFooter").files[0];
        $("fileFooter").value = "";
        handlePickedFile("footer", f);
      });

      $("btnSavePattern").addEventListener("click", ()=>{
        if(!(state.user && state.user.email)){ openLogin(); return; }
        const id = upsertPatternFromFields(editingPatternId);
        if(id){
          editingPatternId = id;
          applyPatternById(id);
          alert("Padrão salvo.");
        }
      });

      // Tabs mobile
      const tabEditor = $("tabEditor");
      const tabPreview = $("tabPreview");
      const panelEditor = $("panelEditor");
      const panelPreview = $("panelPreview");

      function showEditor(){
        tabEditor.classList.add("on");
        tabPreview.classList.remove("on");
        panelEditor.classList.remove("hide");
        panelPreview.classList.remove("show");
      }
      function showPreview(){
        tabPreview.classList.add("on");
        tabEditor.classList.remove("on");
        panelEditor.classList.add("hide");
        panelPreview.classList.add("show");
      }

      tabEditor.addEventListener("click", showEditor);
      tabPreview.addEventListener("click", showPreview);
    }

    function applyBrandLogo(){
      const img = $("brandMark");
      const url = BRAND_LOGO_URL || PLACEHOLDER_PNG;

      img.src = url;
      img.style.width = BRAND_LOGO_SIZE_PX + "px";
      img.style.height = BRAND_LOGO_SIZE_PX + "px";
    }

    /************************************************************
     * Init
     ************************************************************/
    (function init(){
      // sempre abre no topo
      try{ history.scrollRestoration = "manual"; }catch(e){}
      window.scrollTo(0,0);

      state.dateValue = todayBR();

      applyBrandLogo();

      renderCrmList();
      renderRqeList();

      // meds: começa com 1 bloco, sem focar
      state.blocks = [];
      renderBlocksInitial();
      addBlock({focusName:false});

      bind();

      const u = loadSession();
      if(u){
        onLogged(u);
      }else{
        applyUserUI();
        refreshPatternSelect();
      }

      $("dateValue").value = state.dateValue;
      $("rxFontSize").value = String(rxFontPx());

      // seções retraídas ao abrir
      document.querySelectorAll("details.sec").forEach(d=> d.open = false);

      updateSummaries();
      renderPaper();

      // carrega DB multi-abas (silencioso)
      loadSheetDB();

      const isHist = isHistoryRoute();
      $("mainApp").style.display = isHist ? "none" : "grid";
      $("historyPage").style.display = isHist ? "block" : "none";
      if(isHist) renderHistoryPage();

      setTimeout(()=> window.scrollTo(0,0), 0);
    })();
  </script>
</body>
</html>
