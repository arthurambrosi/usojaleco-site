<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UsoJaleco | Prescrições</title>

  <!-- Fonts (base) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Manrope:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Outfit (brand only) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Google Identity Services (Login Google) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      /* ===== TOKENS (white) ===== */
      --bg:#ffffff;
      --surface:#ffffff;
      --surface2:#f8fafc;

      --text:#0f172a;
      --muted:#6b7280;

      --line:#e9eef5;

      --shadow: 0 10px 22px rgba(17,24,39,.08);
      --shadow2: 0 14px 28px rgba(17,24,39,.10);

      --accent:#f97316;

      /* ===== Layout controls ===== */
      --edgeL: 24px;
      --edgeR: 24px;
      --paperMax: 600px;
      --rightColW: 440px;         /* agora controla a largura do painel "Copiar" DENTRO do painel da prescrição */
      --deskGap: 22px;

      /* >>> Sidebar (Sumário) */
      --navW: 130px;
      --navPad: 12px;
      --navIcon: 46px;
      --navIconR: 14px;
      --navCardR: 24px;

      /* ===== Layout vars (kept) ===== */
      --rBig:26px;
      --rMid:22px;
      --rSm:18px;
      --rBtn:14px;

      --t: .18s ease;

      --gap: 18px;
      --gap2: 26px;

      --topH: 44px;

      --paperPad: 20mm;

      --pillOrange: var(--accent);
    }

    @media (max-width: 720px){
      :root{
        --edgeL: 16px;
        --edgeR: 16px;
        --paperMax: 620px;
        --deskGap: 16px;
        --rightColW: 100%;
        --navW: 100%;
      }
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 12% 10%, rgba(249,115,22,.10), transparent 60%),
        radial-gradient(1000px 580px at 85% 18%, rgba(15,23,42,.06), transparent 62%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg) 100%);
      background-attachment: fixed, fixed, fixed;
      overflow-x:hidden;
      color-scheme: light;
    }

    a{ color:inherit; text-decoration:none }
    button, input, textarea, select{ font:inherit }
    ::selection{ background:rgba(249,115,22,.18) }

    /* ===== HEADER ===== */
    .topbarWrap{
      background:#fff;
      box-shadow: 0 10px 22px rgba(17,24,39,.10);
      position: sticky;
      top: 0;
      z-index: 40;
    }

    .topbar{
      width: 100%;
      padding: 16px var(--edgeR);
      padding-left: var(--edgeL);
      margin: 0;
      display:flex;
      align-items:center;
      gap: 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 190px;

      user-select:none;
      -webkit-user-select:none;
      -ms-user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .brand img{
      height: 28px;
      width: auto;
      display:block;

      user-select:none;
      -webkit-user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    .brandName{
      display:flex;
      align-items:baseline;
      gap: 0;
      font-family: Outfit, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 18px;
      font-weight: 400;
      letter-spacing: -0.01em;
      color:#475569;

      user-select:none;
      -webkit-user-select:none;
      -ms-user-select:none;
      pointer-events:none;
    }

    .brandName b{
      font-weight: 800;
      color:#334155;
    }

    .headRight{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap: 12px;
    }

    .headBtn{
      height: 38px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid #e7ebf2;
      background: #fff;
      color:#334155;
      font-weight: 800;
      cursor: pointer;
      transition: background var(--t), filter var(--t), transform var(--t);
      white-space: nowrap;

      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      line-height: 1;
    }

    .headBtn:hover{
      background:#f8fafc;
      transform: translateY(-1px);
    }
    .headBtn:active{ transform: translateY(0px); }

    .headBtnPrimary{
      background: var(--accent);
      border-color: var(--accent);
      color:#fff;
    }

    .headBtnPrimary:hover{
      background: var(--accent);
      border-color: var(--accent);
      filter: brightness(.92);
    }

    .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      color: #f97316;
      transition: background var(--t), border-color var(--t), transform var(--t);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .iconBtn:hover{
      background:#fff7ed;
      border-color:#fed7aa;
      transform: translateY(-1px);
    }
    .iconBtn:active{ transform: translateY(0px); }

    @media (max-width: 720px){
      .topbar{ padding-top: 14px; padding-bottom: 14px; }
      .brand{ min-width: auto; }
      .headRight{ gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
      .headBtn{ height: 36px; padding: 0 12px; font-size: 13px; }
    }

    /* ===== Account dropdown ===== */
    .acctWrap{
      position: fixed;
      top: 74px;
      right: 18px;
      z-index: 60;
      display:none;
    }
    .acctCard{
      width: min(360px, 92vw);
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow2);
      padding: 12px;
    }
    .acctRow{
      display:flex;
      align-items:center;
      gap: 10px;
      margin-bottom: 10px;
      min-width: 0;
    }
    .acctRow img{
      width: 40px;
      height: 40px;
      border-radius: 999px;
      object-fit: cover;
      border: 1px solid var(--line);
      background: var(--surface2);
      flex: 0 0 auto;
    }
    .acctInfo{
      min-width: 0;
      display:flex;
      flex-direction: column;
      gap: 2px;
    }
    .acctInfo b{
      font-size: 13.5px;
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 30ch;
      line-height: 1.1;
    }
    .acctInfo small{
      color: var(--muted);
      font-size: 12.3px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 34ch;
      line-height: 1.1;
    }
    .acctBtns{
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    /* ===== App wrap ===== */
    .wrap{
      width:100%;
      max-width:none;
      margin:0;
      padding: 18px var(--edgeR) 30px;
      padding-left: var(--edgeL);
    }

    /* ===== Mobile tabs ===== */
    .mobileTabs{
      display:none;
      margin-top: 14px;
      border:1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 6px;
      gap: 6px;
      box-shadow: var(--shadow);
    }
    .tab{
      flex:1;
      text-align:center;
      padding: 10px 10px;
      border-radius: 999px;
      font-weight: 900;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      transition: background var(--t), color var(--t), box-shadow var(--t), border-color var(--t);
      border:1px solid transparent;
    }
    .tab.on{
      color: var(--text);
      border-color: rgba(249,115,22,.30);
      background: rgba(249,115,22,.08);
      box-shadow: 0 10px 18px rgba(249,115,22,.12);
    }

    /* ===== Main layout (Sidebar fora + Conteúdo) ===== */
.main{
  margin-top: 16px;
  display:grid;
  grid-template-columns: var(--navW) 1fr; /* sidebar à esquerda */
  gap: var(--deskGap);
  align-items:start;
}

.contentCols{
  display:flex;
  flex-direction:column; /* mantém editor em cima e workspace embaixo */
  gap: var(--gap2);
  min-width: 0;
  grid-column: 2;
}

.leftCol, .rightCol{
  display:flex;
  flex-direction:column;
  gap: var(--gap2);
  min-width: 0;
}

@media (max-width: 980px){
  .main{ grid-template-columns: 1fr; gap: var(--gap2); }
  .mobileTabs{ display:flex; }

  /* sidebar vira "faixa" no topo no mobile */
  .sideNav{
    width: 100%;
    padding: 10px;
  }
  .sideNavList{
    flex-direction: row;
    gap: 10px;
    justify-content: flex-start;
    align-items: stretch;
    overflow-x: auto;
    padding-bottom: 4px;
    scrollbar-width: thin;
  }
  .navItem{
    flex: 0 0 auto;
    width: 110px;
  }
}
/* ===== Sidebar (Sumário) ===== */
.sideNav{
  width: var(--navW);
  padding: var(--navPad);
  border: 1px solid var(--line);
  border-radius: var(--navCardR);
  background: var(--surface);
  box-shadow: var(--shadow);

  position: relative; /* volta pro fluxo do layout (não acompanha o scroll e alinha com o editor) */

  max-height: calc(100vh - 110px);
  overflow: auto;
}

.sideNavList{
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.navLoading{
  padding: 10px 8px;
  color: var(--muted);
  font-weight: 800;
  font-size: 12.6px;
}

.navItem{
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 10px 8px;
  border-radius: 18px;
  border: 1px solid var(--line);
  background: #fff;
  transition: transform var(--t), background var(--t), border-color var(--t), box-shadow var(--t);
  min-width: 0;
}

.navItem:hover{
  transform: translateY(-1px);
  background: var(--surface2);
  border-color: rgba(15,23,42,.14);
  box-shadow: 0 12px 22px rgba(17,24,39,.08);
}

.navIcon{
  width: var(--navIcon);
  height: var(--navIcon);
  border-radius: var(--navIconR);
  object-fit: contain;
  background: var(--surface2);
  border: 1px solid var(--line);
  flex: 0 0 auto;
  display: block;
}

.navLabel{
  font-size: 12px;
  font-weight: 900;
  color: var(--text);
  text-align: center;
  line-height: 1.15;

  max-width: 100%;
  white-space: normal;       /* <- quebra linha */
  overflow: visible;
  text-overflow: clip;

  overflow-wrap: anywhere;   /* <- não estoura */
  word-break: break-word;
  padding: 0 4px;
}

    .card{
      border: 1px solid var(--line);
      border-radius: var(--rBig);
      background: var(--surface);
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
      min-width: 0;
    }

    .cardHeader{
      padding: 16px 16px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(15,23,42,.03), rgba(15,23,42,0));
    }

    .cardHeader h2{
      margin:0;
      font-family: "DM Serif Display", serif;
      font-size: 18px;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .cardHeader .sub{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 12.8px;
      line-height:1.25;
      max-width: 70ch;
    }
    .cardBody{ padding: 16px; }

    .label{
      display:block;
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 750;
      margin: 0 0 6px;
      letter-spacing: .2px;
    }

    .field, .select{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: var(--surface2);
      color: var(--text);
      padding: 11px 12px;
      outline:none;
      transition: border-color var(--t), background var(--t), box-shadow var(--t);
    }
    .field:focus, .select:focus{
      border-color: rgba(249,115,22,.55);
      box-shadow: 0 0 0 3px rgba(249,115,22,.18);
      background: #fff;
    }
    textarea.field{ min-height: 92px; resize: vertical; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid3eq{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; align-items:end; }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .divider{ height:1px; background: var(--line); margin: 14px 0; }
    .mini{ font-size: 12.5px; color: var(--muted); line-height:1.2; }

    /* ===== Buttons (app) ===== */
    .btn{
      cursor:pointer;
      border-radius: var(--rBtn);
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      padding: 0 12px;
      height: var(--topH);
      font-weight: 900;
      font-size: 13.5px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform var(--t), background var(--t), border-color var(--t), box-shadow var(--t);
      white-space: nowrap;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ transform: translateY(-1px); background: var(--surface2); border-color: rgba(15,23,42,.14); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    .btnPrimary{
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
      box-shadow: 0 10px 18px rgba(249,115,22,.18);
    }
    .btnPrimary:hover{
      filter: brightness(.97);
      box-shadow: 0 12px 22px rgba(249,115,22,.22);
      border-color: rgba(249,115,22,.92);
      background: rgba(249,115,22,.98);
    }
    .btnGhost{ background: #fff; border-color: var(--line); color: var(--text); }

    /* ===== Collapsible sections ===== */
    details.sec{
      border:1px solid var(--line);
      background: #fff;
      border-radius: 18px;
      overflow:hidden;
      margin-bottom: 12px;
    }
    details.sec > summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      user-select:none;
    }
    details.sec > summary::-webkit-details-marker{ display:none; }
    .secTitle{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width: 0;
    }
    .secTitle b{
      font-size: 13px;
      letter-spacing:.2px;
    }
    .secTitle small{
      color: var(--muted);
      font-size: 12.3px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 72vw;
    }
    .chev{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: var(--surface2);
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      color: var(--text);
      flex: 0 0 auto;
      transition: transform var(--t);
    }
    details[open] .chev{ transform: rotate(180deg); }
    .secBody{ padding: 0 12px 12px; }

    /* ===== Toggle ===== */
    .toggleRow{ display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .toggle{
      display:inline-flex; align-items:center; gap:10px;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--surface2);
      user-select:none;
    }
    .toggle input{ width:18px; height:18px; }
    .toggle span{ font-size: 12.8px; font-weight: 900; color: var(--text); }

    /* ===== Medicine blocks ===== */
    .rxBlocks{ display:flex; flex-direction:column; gap: 12px; }
    .rxBlock{
      border: 1px solid var(--line);
      border-radius: var(--rMid);
      background: #fff;
      padding: 12px;
      position:relative;
      transition: transform var(--t), border-color var(--t), background var(--t), box-shadow var(--t);
      box-shadow: 0 10px 22px rgba(17,24,39,.06);
    }
    .rxBlock:hover{
      transform: translateY(-1px);
      border-color: rgba(15,23,42,.14);
      background: #fff;
      box-shadow: 0 14px 26px rgba(17,24,39,.08);
    }

    .rxTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .rxTitle{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex: 1;
    }
    .rxNum{
      width:28px; height:28px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: var(--surface2);
      font-weight: 900;
      color: var(--text);
      flex: 0 0 auto;
    }
    .rxTitle strong{
      font-size: 13px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 58vw;
    }
    .rxTools{ display:flex; gap:8px; align-items:center; flex: 0 0 auto; }

    .rxTools .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
    }
    .rxTools .iconBtn:hover{
      background: var(--surface2);
      border-color: rgba(15,23,42,.14);
    }
    .iconBtnDanger:hover{ border-color: rgba(239,68,68,.35) !important; background: rgba(239,68,68,.06) !important; }
    .iconBtnDim{ opacity:.78; }
    .iconBtnDim:hover{ opacity:1; }

    .rxGrid{
      display:grid;
      grid-template-columns: 1.35fr .90fr;
      gap: 12px;
      align-items:start;
    }
    .rxFull{ margin-top:12px; }

    .rxBlock.collapsed .rxExpandedBody{ display:none; }
    .rxBlock.collapsed .rxTop{ margin-bottom:0; }

    /* Icon selectors */
    .iconPick{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .iconTag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: #fff;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12.3px;
      transition: transform var(--t), background var(--t), border-color var(--t), opacity var(--t), box-shadow var(--t);
    }
    .iconTag:hover{
      transform: translateY(-1px);
      background: var(--surface2);
      border-color: rgba(15,23,42,.14);
    }
    .iconTag.on{
      border-color: rgba(249,115,22,.45);
      background: rgba(249,115,22,.07);
      box-shadow: 0 10px 18px rgba(249,115,22,.10);
    }

    /* ===== Autocomplete / Results ===== */
    .acWrap{ position:relative; }
    .acList{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow2);
      z-index: 50;
      overflow:hidden;
      display:none;
      max-height: 340px;
      overflow:auto;
    }
    .medItem{
      padding: 10px 12px;
      cursor:pointer;
      border-bottom: 1px solid var(--line);
      display:flex;
      gap: 12px;
      align-items:flex-start;
      transition: background var(--t);
    }
    .medItem:last-child{ border-bottom:none; }
    .medItem:hover{ background: var(--surface2); }
    .medDot{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      margin-top: 4px;
      border: 1px solid rgba(15,23,42,.12);
      flex: 0 0 auto;
      background: var(--accent);
      box-shadow: 0 8px 18px rgba(249,115,22,.18);
    }
    .medMain{ flex: 1 1 auto; min-width: 0; }
    .medTopRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .medA{
      font-weight: 900;
      font-size: 13.2px;
      color: var(--text);
      letter-spacing: .15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64ch;
    }
    .medB{
      margin-top: 2px;
      font-style: italic;
      font-size: 12.2px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64ch;
    }
    .medTag{
      flex: 0 0 auto;
      font-size: 11px;
      font-weight: 900;
      color: var(--text);
      border: 1px solid var(--line);
      background: #fff;
      padding: 4px 8px;
      border-radius: 999px;
      white-space:nowrap;
      max-width: 30ch;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .acEmpty{
      padding: 12px;
      color: var(--muted);
      font-size: 12.6px;
      line-height: 1.25;
    }

    /* ===== Workspace (Barra + Prévia + Copiar) ===== */
.workspaceBody{ padding: 16px; }

.workspaceGrid{
  display:grid;
  grid-template-columns: minmax(0, var(--paperMax)) minmax(340px, 1fr);
  grid-template-rows: auto 1fr;
  gap: 16px;
  align-items: start;
}

/* a barra de imprimir/páginas fica acima das DUAS colunas */
.workspaceGrid > .paperHead{
  grid-column: 1 / -1;
  margin-bottom: 0; /* importante: não empurrar tudo com margin */
}

.previewPane{
  min-width: 0;
  display:flex;
  flex-direction: column;
}

.copyPane{
  min-width: 0;
  display:flex;
  flex-direction: column;
  border-left: 1px dashed rgba(15,23,42,.10);
  padding-left: 10px;
}

/* quando ficar mais estreito, empilha: barra, prévia, copiar */
@media (max-width: 1320px){
  .workspaceGrid{
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto;
  }

  .workspaceGrid > .paperHead{ grid-column: 1; }

  .copyPane{
    border-left: none;
    border-top: 1px dashed rgba(15,23,42,.10);
    padding-left: 0;
    padding-top: 10px;
  }
}

    .paneTitleRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .paneTitleRow h3{
      margin:0;
      font-family: "DM Serif Display", serif;
      font-size: 16px;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .paneTitleRow .sub{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 12.4px;
      line-height:1.25;
      max-width: 60ch;
    }

    @media (max-width: 980px){
      .workspaceGrid{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
      }
      .sideNav{
        width: 100%;
        padding: 10px;
      }
      .sideNavList{
        flex-direction: row;
        gap: 10px;
        justify-content: flex-start;
        align-items: stretch;
        overflow-x: auto;
        padding-bottom: 4px;
        scrollbar-width: thin;
      }
      .navItem{
        flex: 0 0 auto;
        width: 110px;
      }
      .copyPane{
        grid-column: 1;
        border-top: none;
        padding-top: 0;
      }
    }

    /* ===== Preview / Paper ===== */
    .paperShell{ padding: 0; }

    .paperHead{
      border:1px solid var(--line);
      background: #fff;
      border-radius: 18px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
    }
    .paperHeadRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .paperHeadLeft{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .paperHeadRight{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-left:auto;
    }

    .paperWrap{ display:flex; justify-content:flex-start; }
    .paper{
      width: 100%;
      max-width: var(--paperMax);
      border-radius: 18px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      box-shadow: 0 18px 60px rgba(0,0,0,.16);
      overflow:hidden;
      position:relative;
    }

    @media (max-width: 980px){
      .paperWrap{ justify-content:center; }
      .paper{ max-width: min(var(--paperMax), 92vw); }
    }

    .paperInner{ padding: var(--paperPad); background:#fff; }
    .paperA4{ aspect-ratio: 210 / 297; }
    .paperLetter{ aspect-ratio: 8.5 / 11; }
    .paperA5{ aspect-ratio: 148 / 210; }
    .paperLegal{ aspect-ratio: 8.5 / 14; }

    .rxPaper{
      color:#000;
      line-height: 1.32;
      --rxFont: 13.2px;
      --rxFamily: "Times New Roman", Times, serif;
      font-family: var(--rxFamily);
      font-size: var(--rxFont);
      background:#fff;
    }

    .rxPaper .headerArea{
      position:relative;
      height: 78px;
      margin-bottom: 6px;
    }
    .rxPaper .footerArea{
      position:relative;
      height: 62px;
      margin-top: 10px;
    }

    /* ===== Transform box (drag/resize) ===== */
    .instImgBox{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%) translate(var(--tx, 0px), var(--ty, 0px)) scale(var(--sc, 1));
      transform-origin: center;
      user-select: none;
      touch-action: none;
      cursor: grab;
      z-index: 4;
      border-radius: 8px;
    }
    .instImgBox:active{ cursor: grabbing; }
    .instImgBox:hover{ outline: 1px dashed rgba(0,0,0,.28); outline-offset: 2px; }
    .instImgBox.active{ outline: 1px dashed rgba(0,0,0,.38); outline-offset: 2px; }
    .instImgBox .instImg{
      display:block;
      object-fit: contain;
      pointer-events:none;
      max-width: 92%;
      max-height: 74px;
    }
    .instImgBox.footer .instImg{ max-height: 58px; }

    .instHandle{
      position:absolute;
      right: -7px;
      bottom: -7px;
      width: 14px;
      height: 14px;
      border-radius: 5px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.28);
      box-shadow: 0 6px 16px rgba(0,0,0,.22);
      cursor: nwse-resize;
      touch-action:none;
      opacity: .92;
    }
    .instImgBox:hover .instHandle{ opacity: 1; }

    /* ===== Title & meta inside paper ===== */
    .rxTitleCenter{
      margin: 2px 0 10px;
      text-align:center;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 900;
      letter-spacing: .6px;
      text-transform: uppercase;
      font-size: 17px;
      color:#111;
    }

    .rxMeta{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
    }

    .rxPatientLine{
      font-weight: 400;
      font-size: 12.8px;
      letter-spacing:.15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 68ch;
      margin-top: 3px;
    }
    .rxNameLabel{ font-weight: 900; }
    .rxNameValue{ font-weight: 400; }

    .rxPatientLine .docInline{
      font-weight: 800;
      opacity:.9;
      margin-left: 10px;
      white-space:nowrap;
    }
    .rxDatePill{
      flex: 0 0 auto;
      border-radius: 999px;
      background: #f1f5f9;
      color: #111;
      padding: 4px 10px;
      font-weight: 900;
      font-size: 12.1px;
      line-height: 1.2;
      border: 1px solid rgba(15,23,42,.10);
      white-space:nowrap;
    }
    .rxDividerLine{
      height:1px;
      background: #cbd5e1;
      margin: 10px 0 14px;
    }

    .rxSymbol{
      font-weight: 900;
      font-size: 16px;
      margin: 0 0 10px;
      font-family: var(--rxFamily);
    }

    .rxList{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-bottom: 14px;
      font-size: var(--rxFont);
      line-height: 1.34;
    }

    /* ===== Linha do medicamento ===== */
    .rxLine{
      display: grid;
      grid-template-columns: auto fit-content(100%) 1fr auto;
      column-gap: .9ch;
      align-items: baseline;
    }
    @supports (align-items: last baseline){
      .rxLine{ align-items: last baseline; }
    }
    .rxNo{
      font-weight: 900;
      letter-spacing: .1px;
      width: 20px;
      margin-right: 0;
      white-space: nowrap;
    }
    .drugName{
      font-weight: 800;
      letter-spacing: .15px;
      min-width: 0;
      white-space: normal;
      overflow-wrap: anywhere;
    }
    .leaderText{
      justify-self: stretch;
      overflow: hidden;
      white-space: nowrap;
      min-width: 5ch;
      padding: 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      letter-spacing: 0;
      transform: translateY(-1px);
      color:#000;
    }
    .leaderText::before{
      content: "--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------";
    }
    .qty{
      font-weight: 800;
      color:#000;
      min-width: 0;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    .rxInstr{
      margin-top: 4px;
      padding-left: 30px;
      color:#000;
      font-size: var(--rxFont);
      line-height: 1.28;
      word-break: break-word;
    }

    .useIconsBelow{
      margin-top: 6px;
      padding-left: 30px;
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      color:#000;
      font-size: 13px;
      transform: translateY(-1px);
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .useIconsBelow span{
      border:1px solid rgba(0,0,0,.14);
      border-radius: 999px;
      padding: 2px 8px;
      line-height: 1.2;
      font-weight: 900;
      background: #fff;
    }

    .sigWrap{
      margin-top: 6px;
      padding-top: 6px;
    }
    .docSig{
      display:inline-block;
      max-width: 100%;
      text-align:center;
      margin: 0 auto;
    }
    .sigLine{
      width: 100%;
      border-bottom: 1px solid #000;
      height: 24px;
      margin: 0 auto 8px;
    }
    .docCenter{
      text-align:center;
      font-size: 12.2px;
      line-height: 1.25;
      color:#000;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .docCenter .docName{ font-weight: 900; }
    .docCenter .docLine{ margin-top: 2px; }

    .instFooterGray{
      margin-top: 10px;
      text-align:center;
      color:#666;
      font-size: 11.6px;
      line-height: 1.25;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .gearBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      transition: transform var(--t), background var(--t), border-color var(--t);
      font-weight: 900;
      font-size: 12.8px;
      color: var(--text);
      white-space: nowrap;
      height: var(--topH);
    }
    .gearBtn:hover{
      transform: translateY(-1px);
      background: var(--surface2);
      border-color: rgba(15,23,42,.14);
    }
    .gearBtn .gico{
      width:32px;height:32px;
      display:inline-flex;align-items:center;justify-content:center;
      border-radius: 12px;
      border:1px solid var(--line);
      background: var(--surface2);
      font-size: 16px;
    }

    @media (max-width: 520px){
      .grid2{ grid-template-columns: 1fr; }
      .grid3eq{ grid-template-columns: 1fr; }
      .rxGrid{ grid-template-columns: 1fr; }
      .paperInner{ padding: 16mm; }
      .gearBtn{ width: 100%; justify-content:space-between; }
      .rxTitleCenter{ font-size: 16px; }
      .drugName{ min-width: 160px; }
      .rxTitle strong{ max-width: 66vw; }
    }

    /* ===== Copy panel (inside workspace) ===== */
    .copyBox{
      width: 100%;
      flex: 1 1 auto;
      min-height: 320px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: #fff;
      padding: 12px 12px;
      outline: none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12.7px;
      line-height: 1.35;
      color: #0f172a;
      box-shadow: 0 10px 18px rgba(17,24,39,.06);
      white-space: pre-wrap;
      word-break: break-word;
      resize: vertical;
    }
    .copyHint{
  display: grid;
  grid-template-columns: 1fr; /* botão em largura total */
  gap: 8px;
  margin-top: 10px;
}

.copyHint .btn{
  width: 100%;
}

.copyPane{ 
   padding-right: 10px;
}

.copyStatus{
  width: 100%;
  text-align: center;
}
    .copyStatus{
      font-size: 12.4px;
      color: var(--muted);
      font-weight: 800;
    }

    /* ===== Modal ===== */
    .modalMask{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 90;
    }
    .modal{
      width: min(900px, 96vw);
      border-radius: 22px;
      border:1px solid var(--line);
      background: #fff;
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(15,23,42,.03), transparent);
    }
    .modalHead b{ font-size: 14px; letter-spacing:.2px; }
    .modalBody{ padding: 14px; }
    .modalFoot{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .modalCard{
      border:1px solid var(--line);
      background: #fff;
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 10px 18px rgba(17,24,39,.06);
    }
/* ===== Config: esconder margens e larguras ===== */
.cfgLayoutHidden{ display:none !important;
}
    /* ===== PRINT ===== */
    .printAll{ display:none; }
    .printPage{ break-after: page; page-break-after: always; }

    @media print{
      body{ background:#fff !important; color:#000 !important; }
      .topbarWrap, .mobileTabs, #panelEditor, #panelWorkspace, #sideNav, .sideNav, .modalMask, .acctWrap{ display:none !important; }
      .wrap{ max-width:none; padding:0; }
      .printAll{ display:block !important; }
      @page { margin: 20mm; }

      .instHandle{ display:none !important; }
      .instImgBox{ outline: none !important; cursor: default !important; }
      .paper{ box-shadow: none !important; border: none !important; border-radius: 0 !important; max-width: none !important; }
      .paperInner{ padding: var(--paperPad) !important; }
    }

    /* === FIX: quebra de linha dos medicamentos NÃO centralizar === */
    #preview .meds,
    #preview .meds * ,
    #preview .medList,
    #preview .medList * ,
    #preview .rx-meds,
    #preview .rx-meds * {
      text-align: left !important;
    }
    #preview .medItem,
    #preview .medLine,
    #preview .rxMedLine,
    #preview .rx-med-line {
      display: block;
      width: 100%;
      text-align: left !important;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      justify-content: flex-start !important;
      align-items: flex-start !important;
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <div class="topbarWrap">
    <header class="topbar">
      <div class="brand" aria-label="UsoJaleco">
        <img
          id="brandLogo"
          alt="Logo UsoJaleco"
          src="https://raw.githubusercontent.com/arthurambrosi/usojaleco/0204905b333f11d1eec3c7c6667d17dbfb457774/Design%20sem%20nome%20(28).png"
          draggable="false"
        />
        <div class="brandName"><span>uso</span><b>jaleco</b></div>
      </div>

      <div class="headRight">
        <button class="headBtn headBtnPrimary" id="btnGoogleLogin" type="button">
          Entrar com Google
        </button>

        <button class="headBtn" id="btnAddMed" type="button">
          + Adicionar medicamento
        </button>

        <button class="iconBtn" id="btnAccount" type="button" aria-label="Conta" style="display:none;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 12a4.2 4.2 0 1 0-4.2-4.2A4.2 4.2 0 0 0 12 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M4.5 20.1a8.6 8.6 0 0 1 15 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </header>
  </div>

  <!-- Account dropdown -->
  <div class="acctWrap" id="acctWrap" aria-hidden="true">
    <div class="acctCard">
      <div class="acctRow">
        <img id="userPic" alt="" />
        <div class="acctInfo">
          <b id="userName">—</b>
          <small id="userEmail">—</small>
        </div>
      </div>
      <div class="acctBtns">
        <button class="headBtn" id="btnLogout" type="button">Sair</button>
      </div>
    </div>
  </div>

  <div class="wrap" id="appWrap">
    <div class="mobileTabs" aria-label="Alternar entre editor e prévia">
      <div class="tab on" id="tabEditor">Editar</div>
      <div class="tab" id="tabPreview">Prévia</div>
    </div>

    <div class="main" id="mainApp">
  <!-- Sidebar (Sumário) — fora do Editor e fora da Prévia/Copiar -->
  <aside class="sideNav" id="sideNav" aria-label="Sumário do site">
    <div class="navLoading">Carregando menu…</div>
  </aside>

  <!-- Conteúdo (Editor + Workspace) -->
  <div class="contentCols" id="contentCols">

    <!-- LEFT COL -->
    <div class="leftCol" id="leftCol">

        <!-- ===== Editor ===== -->
        <div class="card panel" id="panelEditor">
          <div class="cardHeader">
            <div>
              <h2>Editor</h2>
              <p class="sub">Ao abrir, tudo começa retraído. Você expande só o que for usar.</p>
            </div>
          </div>

          <div class="cardBody">
            <!-- 1) Médico -->
            <details class="sec" id="secMedico">
              <summary>
                <div class="secTitle">
                  <b>1. Informações do médico</b>
                  <small id="sumMedico">—</small>
                </div>
                <div class="chev">˅</div>
              </summary>
              <div class="secBody">
                <div class="grid2">
                  <div>
                    <label class="label" for="docTitle">Título</label>
                    <select class="select" id="docTitle">
                      <option value="Dr." selected>Doutor (Dr.)</option>
                      <option value="Dra.">Doutora (Dra.)</option>
                    </select>
                  </div>
                  <div>
                    <label class="label" for="docName">Nome do médico</label>
                    <input class="field" id="docName" placeholder="Nome completo…" autocomplete="name" />
                  </div>
                </div>

                <div class="divider"></div>

                <div class="grid2">
                  <div>
                    <label class="label">CRM(s)</label>
                    <div id="crmList"></div>
                    <div style="margin-top:10px">
                      <button class="btn btnGhost" id="btnAddCRM" type="button">+ Adicionar outro CRM</button>
                    </div>
                  </div>

                  <div>
                    <label class="label">RQE(s) (opcional)</label>
                    <div id="rqeList"></div>
                    <div style="margin-top:10px">
                      <button class="btn btnGhost" id="btnAddRQE" type="button">+ Adicionar outro RQE</button>
                    </div>
                  </div>
                </div>

                <div class="divider"></div>
                <div class="mini" id="persistHint">Faça login para salvar os dados do médico “para sempre” nessa conta (e recarregar automaticamente no futuro).</div>
              </div>
            </details>

            <!-- 2) Paciente -->
            <details class="sec" id="secPaciente">
              <summary>
                <div class="secTitle">
                  <b>2. Informações do paciente</b>
                  <small id="sumPaciente">—</small>
                </div>
                <div class="chev">˅</div>
              </summary>
              <div class="secBody">
                <div class="grid2">
                  <div>
                    <label class="label" for="patientName">Nome do paciente</label>
                    <input class="field" id="patientName" placeholder="Digite o nome do paciente…" autocomplete="name" />
                  </div>

                  <div>
                    <label class="label">Documento (opcional)</label>
                    <div class="grid2" style="gap:10px;">
                      <select class="select" id="patientDocType">
                        <option value="CPF" selected>CPF</option>
                        <option value="RG">RG</option>
                        <option value="CNS">CNS</option>
                      </select>
                      <input class="field" id="patientDocValue" placeholder="Digite o número…" inputmode="text" />
                    </div>
                  </div>
                </div>
              </div>
            </details>

            <!-- 3) Medicamentos -->
            <details class="sec" id="secMeds">
              <summary>
                <div class="secTitle">
                  <b>3. Medicamentos</b>
                  <small id="sumMeds">—</small>
                </div>
                <div class="chev">˅</div>
              </summary>
              <div class="secBody">
                <div class="mini" id="dbStatus">Carregando base de medicamentos…</div>
                <div style="height:10px"></div>

                <div class="rxBlocks" id="rxBlocks"></div>

                <div class="divider"></div>

                <div class="row">
                  <button class="btn btnGhost" id="btnAddMed2" type="button">+ Adicionar medicamento</button>
                  <button class="btn btnGhost" id="btnClear" type="button">Limpar tudo</button>
                </div>
              </div>
            </details>
          </div>
        </div>
      </div>

      <!-- RIGHT COL -->
      <div class="rightCol" id="rightCol">
        <!-- ===== Workspace: Sidebar + Prévia (esq) + Copiar (dir) ===== -->
        <div class="card panel" id="panelWorkspace">
          <div class="cardHeader">
            <div>
              <h2>Prévia & Copiar</h2>
              <p class="sub">Prévia da prescrição (à esquerda) e texto pronto para copiar (à direita), com barra lateral de navegação.</p>
            </div>

            <div style="display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; justify-content:flex-end;">
              <button class="gearBtn" id="btnOpenConfig" type="button" title="Configurar prescrição">
                <span style="opacity:.95;">Configure sua prescrição</span>
                <span class="gico">⚙️</span>
              </button>
            </div>
          </div>

          <div class="cardBody workspaceBody">
            <div class="workspaceGrid">
  <!-- Barra de impressão/páginas (fica acima de prévia + copiar) -->
  <div class="paperHead">
    <div class="paperHeadRow">
      <div class="paperHeadLeft">
        <button class="btn btnPrimary" id="btnPrintOnly" type="button">Imprimir / PDF</button>
        <button class="btn btnGhost" id="btnPrintAll" type="button">Imprimir tudo</button>
      </div>

      <div class="paperHeadRight">
        <div class="mini" id="pageInfo">Página 1 de 1</div>

        <div class="row" style="gap:8px; justify-content:flex-end;">
          <button class="btn btnGhost" id="btnPrevPage" type="button">◀</button>
          <select class="select" id="pageSelect" style="width: 160px;">
            <option value="1" selected>Página 1</option>
          </select>
          <button class="btn btnGhost" id="btnNextPage" type="button">▶</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview -->
  <section class="previewPane" aria-label="Prévia da prescrição">
    <div class="paperShell">
      <div class="paperWrap">
        <div class="paper paperA4" id="paper">
          <div class="paperInner">
            <div class="rxPaper" id="rxPaper"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Copy -->
  <section class="copyPane" aria-label="Copiar texto da prescrição">
    <div class="paneTitleRow">
      <div>
        <h3>Copiar texto</h3>
        <p class="sub">Conteúdo pronto para copiar: nome, tracinhos, quantidade e posologia.</p>
      </div>
    </div>

    <textarea class="copyBox" id="copyBox" readonly spellcheck="false" aria-label="Texto para copiar"></textarea>
    <div class="copyHint">
      <button class="btn btnPrimary" id="btnCopyText" type="button">Copiar texto</button>
      <div class="copyStatus" id="copyStatus">—</div>
    </div>
  </section>
</div>
       
              </section>
            </div>
          </div>
        </div>
      </div>
        </div>
  </div> <!-- /contentCols -->

    <div class="printAll" id="printAll"></div>
  </div>

  <!-- ===== Modal Login ===== -->
  <div class="modalMask" id="loginMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Login">
      <div class="modalHead">
        <div>
          <b>Login com Google</b>
          <div class="mini" style="margin-top:6px;">Ao logar, os dados do médico ficam associados à sua conta neste dispositivo.</div>
        </div>
        <button class="iconBtn iconBtnDanger" id="btnCloseLogin" type="button" aria-label="Fechar">✕</button>
      </div>
      <div class="modalBody">
        <div id="googleBtnMount"></div>
        <div class="mini" id="loginWarn" style="margin-top:10px; display:none;"></div>
      </div>
      <div class="modalFoot">
        <button class="btn btnGhost" id="btnCloseLogin2" type="button">Fechar</button>
      </div>
    </div>
  </div>

  <!-- ===== Modal Config ===== -->
  <div class="modalMask" id="configMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Configurar prescrição">
      <div class="modalHead">
        <div>
          <b>Configure sua prescrição</b>
          <div class="mini" style="margin-top:6px;">Tamanho, fonte, data, cabeçalho/rodapé e layout (alinhamento).</div>
        </div>
        <button class="iconBtn iconBtnDanger" id="btnCloseConfig" type="button" aria-label="Fechar">✕</button>
      </div>

      <div class="modalBody">
        <div class="modalCard">
          <div class="grid2">
            <div>
              <label class="label" for="paperSize">Tamanho da folha</label>
              <select class="select" id="paperSize">
                <option value="A4" selected>A4</option>
                <option value="LETTER">Carta (Letter)</option>
                <option value="A5">A5</option>
                <option value="LEGAL">Legal</option>
              </select>
            </div>

            <div>
              <label class="label" for="rxFontFamily">Fonte</label>
              <select class="select" id="rxFontFamily">
                <option value="TIMES" selected>Times New Roman</option>
                <option value="CALIBRI">Calibri</option>
                <option value="ARIAL">Arial</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="grid3eq">
            <div>
              <label class="label" for="rxFontSize">Tamanho da fonte da prescrição</label>
              <input class="field" id="rxFontSize" placeholder="Ex: 13.2" inputmode="decimal" />
            </div>

            <div>
              <label class="label">Data</label>
              <div class="toggleRow" style="justify-content:flex-start;">
                <label class="toggle" title="Mostrar/ocultar a data na receita">
                  <input type="checkbox" id="includeDate" checked />
                  <span>Incluir</span>
                </label>
              </div>
            </div>

            <div>
              <label class="label" for="dateValue">Data (se ativada)</label>
              <input class="field" id="dateValue" placeholder="dd/mm/aaaa" inputmode="numeric" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid2">
            <div>
              <label class="label" for="headerUrl">Imagem de cabeçalho (URL)</label>
              <input class="field" id="headerUrl" placeholder="Cole a URL do cabeçalho (opcional)..." />
            </div>
            <div>
              <label class="label" for="footerUrl">Imagem de rodapé (URL)</label>
              <input class="field" id="footerUrl" placeholder="Cole a URL do rodapé (opcional)..." />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="grid2">
            <div>
              <img id="headerThumb" alt="" style="width:100%;height:56px;border-radius:14px;border:1px solid var(--line);background:var(--surface2);object-fit:contain;padding:6px;" />
            </div>
            <div>
              <img id="footerThumb" alt="" style="width:100%;height:56px;border-radius:14px;border:1px solid var(--line);background:var(--surface2);object-fit:contain;padding:6px;" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid2">
            <div>
              <label class="label" for="instName">Instituição de Saúde</label>
              <input class="field" id="instName" placeholder="Nome da instituição…" />
            </div>
            <div>
              <label class="label" for="instAddress">Endereço da Instituição (rodapé)</label>
              <input class="field" id="instAddress" placeholder="Rua, nº, bairro, cidade/UF, CEP" />
            </div>
          </div>

          <div class="cfgLayoutHidden"><div class="divider"></div>

<div class="grid2">
  <div>
    <label class="label" for="layoutEdgeL">Margem esquerda (px)</label>
              <input class="field" id="layoutEdgeL" placeholder="Ex: 24" inputmode="numeric" />
              <div class="mini" style="margin-top:6px;">Puxa logo + todo conteúdo da esquerda.</div>
            </div>
            <div>
              <label class="label" for="layoutEdgeR">Margem direita (px)</label>
              <input class="field" id="layoutEdgeR" placeholder="Ex: 24" inputmode="numeric" />
              <div class="mini" style="margin-top:6px;">Puxa botões + todo conteúdo.</div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="grid2">
            <div>
              <label class="label" for="layoutPaperMax">Largura da receita (px)</label>
              <input class="field" id="layoutPaperMax" placeholder="Ex: 600" inputmode="numeric" />
            </div>
            <div>
              <label class="label" for="layoutRightColW">Largura do painel de copiar (px)</label>
              <input class="field" id="layoutRightColW" placeholder="Ex: 440" inputmode="numeric" />
            </div>
          </div>
</div><!-- /.cfgLayoutHidden -->
          <div class="divider"></div>
          <div class="mini">Dica: na prévia, você pode <b>arrastar</b> e <b>redimensionar</b> (sem deformar) as imagens do cabeçalho/rodapé diretamente no papel.</div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn btnGhost" id="btnResetConfig" type="button">Voltar ao padrão</button>
        <button class="btn btnPrimary" id="btnSaveConfig" type="button">Salvar</button>
        <button class="btn btnGhost" id="btnCloseConfig2" type="button">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== Brand anti-caret/selection ===== */
    document.querySelector(".brand")?.addEventListener("mousedown", (e)=> e.preventDefault());

    /************************************************************
     * CONFIG (TOPO)
     ************************************************************/
    const LOGO_URL = "https://raw.githubusercontent.com/arthurambrosi/usojaleco/0204905b333f11d1eec3c7c6667d17dbfb457774/Design%20sem%20nome%20(28).png";
    const GOOGLE_CLIENT_ID = "703476878000-7h4lq2cbpffp3qp7hdn1hksi9k43qqm1.apps.googleusercontent.com";

    /************************************************************
     * SIDEBAR (SUMÁRIO) — planilha (Nome | Imagem | Link)
     * URLs fornecidas:
     * - https://docs.google.com/spreadsheets/d/15YnJdM_21o4E_9LmEew7mX1mmsN4iPRkoJI_fdiv3Zs/edit?gid=0#gid=0
     * - https://docs.google.com/spreadsheets/d/e/2PACX-1vRQDciPTEMkWCfOglnUubyxp6yME-99y-0fvKnumoq8ZdkG7HvKiWI7y7W17VVMjT_99zPAnH3PZ_Yx/pubhtml
     ************************************************************/
    const NAV_SHEET = {
      sheetId: "15YnJdM_21o4E_9LmEew7mX1mmsN4iPRkoJI_fdiv3Zs",
      gid: "0",
      pubId: "2PACX-1vRQDciPTEMkWCfOglnUubyxp6yME-99y-0fvKnumoq8ZdkG7HvKiWI7y7W17VVMjT_99zPAnH3PZ_Yx"
    };

    const NAV_CSV_URLS = [
      `https://docs.google.com/spreadsheets/d/e/${encodeURIComponent(NAV_SHEET.pubId)}/pub?gid=${encodeURIComponent(NAV_SHEET.gid)}&single=true&output=csv`,
      `https://docs.google.com/spreadsheets/d/${encodeURIComponent(NAV_SHEET.sheetId)}/gviz/tq?tqx=out:csv&gid=${encodeURIComponent(NAV_SHEET.gid)}`,
      `https://docs.google.com/spreadsheets/d/${encodeURIComponent(NAV_SHEET.sheetId)}/export?format=csv&gid=${encodeURIComponent(NAV_SHEET.gid)}`
    ];

    /************************************************************
     * GOOGLE SHEETS — CSV multi-abas (MEDICAMENTOS)
     ************************************************************/
    const SHEET_ID = "1es05SmJavEvGAK99kejsgy986T4kRJKw64wozSLTDRQ";

    const SHEET_TABS = [
      { gid: "915261507",  name: "Agentes antirreumáticos específicos" },
      { gid: "478511829",  name: "Agentes imunizantes" },
      { gid: "1411845420", name: "Alcalinizantes" },
      { gid: "395560222",  name: "Analgésicos-Antipiréticos" },
      { gid: "862085121",  name: "Anestésicos locais" },
      { gid: "20003638",   name: "Anti-Histamínicos H1" },
      { gid: "1822197995", name: "Anti-hemorroidários" },
      { gid: "1061659817", name: "Anti-infecciosos do trato gastrintestinal" },
      { gid: "1661597209", name: "Anti-infecciosos tópicos e relacionados" },
      { gid: "1954155192", name: "Antialcoólicos" },
      { gid: "1265384594", name: "Antialérgicos" },
      { gid: "563048962",  name: "Antiastênicos-Energéticos" },
      { gid: "827175960",  name: "Antibióticos" },
      { gid: "1098787868", name: "Agentes anti-inflamatórios não esteróides" },
      { gid: "1418395467", name: "Anticoncepcionais" },
      { gid: "2118860551", name: "Antidiabéticos" },
      { gid: "1848961101", name: "Antidiarreicos" },
      { gid: "388566765",  name: "Antieméticos" },
      { gid: "803029356",  name: "Antifiséticos (Antiflatulentos)" },
      { gid: "839735687",  name: "Antifúngicos" },
      { gid: "1604110756", name: "Antifúngicos tópicos" },
      { gid: "138405399",  name: "Antilipêmicos" },
      { gid: "1785559041", name: "Antineuríticos" },
      { gid: "1333824946", name: "Antissépticos" },
      { gid: "551218037",  name: "Antitussígenos" },
      { gid: "132076127",  name: "Antivaricosos" },
      { gid: "368598785",  name: "Antiácidos" },
      { gid: "1057228386", name: "Antídotos, agentes quelantes e outros" },
      { gid: "1424426563", name: "Broncodilatadores" },
      { gid: "258241824",  name: "Corticosteróides" },
      { gid: "1184992018", name: "Dissuasores de álcool" },
      { gid: "142814384",  name: "Diuréticos" },
      { gid: "1554213437", name: "Emolientes, demulcentes e protetores" },
      { gid: "2005343620", name: "Espasmolíticos" },
      { gid: "1203728329", name: "Expectorantes" },
      { gid: "542940365",  name: "Fornecedores de água e sais minerais" },
      { gid: "1781539542", name: "Anti-hipertensivos" },
      { gid: "1393215463", name: "Anti-inflamatórios locais" },
      { gid: "1927396219", name: "Antianêmicos" },
      { gid: "1077847451", name: "Fármacos antiarrítmicos" },
      { gid: "834788399",  name: "Antiobesidade" },
      { gid: "579731426",  name: "Antiprotozoários para distúrbios gastrintestinais" },
      { gid: "46875283",   name: "Antivertiginosos" },
      { gid: "37066094",   name: "Fármacos com outros usos terapêuticos" },
      { gid: "17226000",   name: "Coagulação sanguínea e hemostípticos" },
      { gid: "1946266019", name: "Fármacos para hiperparatireoidismo" },
      { gid: "1138414149", name: "Fármacos para hipotireoidismo" },
      { gid: "293362851",  name: "Fármacos para insuficiência cardíaca congestiva" },
      { gid: "264388654",  name: "Fármacos para o resfriado/gripe" },
      { gid: "1275257911", name: "Ansiolíticos" },
      { gid: "1253291853", name: "Antidepressivos" },
      { gid: "1803919161", name: "Antiepilépticos" },
      { gid: "920573383",  name: "Antipsicóticos" },
      { gid: "725911",     name: "Antidemência" },
      { gid: "329680812",  name: "Psicoestimulantes" },
      { gid: "2138352132", name: "Sedativos ansiolíticos" },
      { gid: "1736193150", name: "Sedativos hipnóticos" },
      { gid: "983295901",  name: "Fármacos que atuam no metabolismo do ácido úrico" },
      { gid: "382171978",  name: "Fármacos usados no tratamento da gota" },
      { gid: "400958663",  name: "Hipnoanalgésicos" },
      { gid: "1238735812", name: "Inibidores específicos da reabsorção óssea" },
      { gid: "1840608601", name: "Laxantes de contato" },
      { gid: "175034763",  name: "Medicamento Antroposófico" },
      { gid: "981256256",  name: "Medicamentos nasofaríngeos" },
      { gid: "675507405",  name: "Medicamentos otológicos" },
      { gid: "1413136239", name: "Medicamentos para distúrbios gastrointestinais funcionais" },
      { gid: "310730728",  name: "Miorrelaxantes" },
      { gid: "588781851",  name: "Outros analgésicos" },
      { gid: "235558101",  name: "Outros fármacos para constipação" },
      { gid: "1270044698", name: "Probiótico" },
      { gid: "655464895",  name: "Quimioterápicos/Antissépticos para o trato urinário" },
      { gid: "2102197488", name: "Sangue e frações do sangue" },
      { gid: "1176403748", name: "Tranquilizantes" },
      { gid: "897302584",  name: "Tratamento de doenças degenerativas e traumáticas das articulações" },
      { gid: "1272484250", name: "Tratamento de perda de massa óssea" },
      { gid: "326771482",  name: "lostáticos e Hansenostáticos" },
      { gid: "1783656678", name: "Uso Sistêmico" },
      { gid: "552279527",  name: "Vasoconstritores" },
      { gid: "225561128",  name: "Vitaminas" },
      { gid: "1285273334",  name: "Agentes antibacterianos" }
    ];

    let db_medicamentos = [];
    let db_loaded = false;
    let db_loading = false;
    const DEFAULT_DOT_COLOR = getComputedStyle(document.documentElement).getPropertyValue("--pillOrange").trim() || "#f97316";

    /************************************************************
     * STATE
     ************************************************************/
    const state = {
      user: null, // {email,name,picture,sub}

      docTitle: "Dr.",
      docName: "",
      crms: [""],
      rqes: [""],

      patientName: "",
      patientDocType: "CPF",
      patientDocValue: "",

      paperSize: "A4",
      includeDate: true,
      dateValue: "",
      rxFontSize: 13.2,
      rxFontFamily: "TIMES",

      headerImgUrl: "",
      footerImgUrl: "",
      instName: "",
      instAddress: "",

      headerTransform: { x: 0, y: 0, scale: 1 },
      footerTransform: { x: 0, y: 0, scale: 1 },

      /* layout */
      edgeL: 24,
      edgeR: 24,
      paperMax: 600,
      rightColW: 440,

      blocks: [], // {id,name,qty,qtyOptions,use,showIcons,icons,collapsed}
      selectedPage: 1
    };

    /************************************************************
     * Utils
     ************************************************************/
    const $ = (id)=>document.getElementById(id);

    const PLACEHOLDER_PNG =
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABJ0lEQVR4nO3aMQ6CMBQF0U8m0dQmGQm0mQkYQm0mQkYQm0mQkYQm0mQkYQm0mQkYQm0mQkYQm0mQkYQm0mQkYQk0v2k6yqk7+XyQm5mYd8yqf9gQAAAAAAAAAA4Gm9oQm2b3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQm3cQAAAAA8D8m8i8b8kq8wQAAAABJRU5ErkJggg==";

    function safeText(s){ return (s||"").toString().replace(/\s+/g," ").trim(); }
    function norm(s){
      return (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
    }
    function keyify(s){ return norm(s).toLowerCase(); }
    function uid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function todayBR(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    function rxFontPx(){
      const v = parseFloat(String(state.rxFontSize).replace(",", "."));
      if(!isFinite(v) || v <= 6) return 13.2;
      return clamp(v, 7.5, 18);
    }
    function rxFamilyCSS(){
      if(state.rxFontFamily === "ARIAL") return "Arial, Helvetica, sans-serif";
      if(state.rxFontFamily === "CALIBRI") return "Calibri, Arial, sans-serif";
      return "\"Times New Roman\", Times, serif";
    }

    function debounce(fn, ms){
      let t = null;
      return (...args)=>{
        clearTimeout(t);
        t = setTimeout(()=> fn(...args), ms);
      };
    }

    function getDefaultPageConfig(){
      return {
        paperSize: "A4",
        includeDate: true,
        dateValue: todayBR(),
        rxFontSize: 13.2,
        rxFontFamily: "TIMES",
        headerImgUrl: "",
        footerImgUrl: "",
        instName: "",
        instAddress: "",
        headerTransform: { x: 0, y: 0, scale: 1 },
        footerTransform: { x: 0, y: 0, scale: 1 },

        edgeL: 24,
        edgeR: 24,
        paperMax: 600,
        rightColW: 440
      };
    }

    function escapeHtml(s){
      return (s||"").toString()
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }
    function escapeAttr(s){ return escapeHtml(s); }

    function applyLayoutVars(){
      const root = document.documentElement;

      const el = parseInt(state.edgeL, 10);
      const er = parseInt(state.edgeR, 10);
      const pm = parseInt(state.paperMax, 10);
      const rc = parseInt(state.rightColW, 10);

      if(isFinite(el) && el >= 0) root.style.setProperty("--edgeL", `${el}px`);
      if(isFinite(er) && er >= 0) root.style.setProperty("--edgeR", `${er}px`);
      if(isFinite(pm) && pm >= 320) root.style.setProperty("--paperMax", `${pm}px`);
      if(isFinite(rc) && rc >= 280) root.style.setProperty("--rightColW", `${rc}px`);
    }

    /************************************************************
     * Local Storage (por conta)
     ************************************************************/
    function sessionKey(){ return "uj_rx_session_v3"; }
    function profileKey(email){ return `uj_rx_profile_v3__${(email||"").toLowerCase()}`; }
    function configKey(){ return "uj_rx_pagecfg_v3"; }

    function saveSession(){
      try{
        if(!state.user){ localStorage.removeItem(sessionKey()); return; }
        localStorage.setItem(sessionKey(), JSON.stringify(state.user));
      }catch(e){}
    }
    function loadSession(){
      try{
        const raw = localStorage.getItem(sessionKey());
        if(!raw) return null;
        const u = JSON.parse(raw);
        if(u && u.email) return u;
      }catch(e){}
      return null;
    }
    function saveProfile(){
      if(!state.user || !state.user.email) return;
      const payload = {
        docTitle: state.docTitle,
        docName: state.docName,
        crms: state.crms,
        rqes: state.rqes
      };
      try{
        localStorage.setItem(profileKey(state.user.email), JSON.stringify(payload));
        $("persistHint").textContent = "Salvo automaticamente nesta conta (alterações ficam registradas).";
      }catch(e){}
    }
    const saveProfileDebounced = debounce(saveProfile, 180);

    function loadProfile(){
      if(!state.user || !state.user.email) return null;
      try{
        const raw = localStorage.getItem(profileKey(state.user.email));
        if(!raw) return null;
        return JSON.parse(raw) || null;
      }catch(e){ return null; }
    }

    function saveConfig(){
      try{
        const payload = {
          paperSize: state.paperSize,
          includeDate: !!state.includeDate,
          dateValue: safeText(state.dateValue),
          rxFontSize: rxFontPx(),
          rxFontFamily: state.rxFontFamily,
          headerImgUrl: safeText(state.headerImgUrl),
          footerImgUrl: safeText(state.footerImgUrl),
          instName: safeText(state.instName),
          instAddress: safeText(state.instAddress),
          headerTransform: state.headerTransform,
          footerTransform: state.footerTransform,

          edgeL: parseInt(state.edgeL, 10),
          edgeR: parseInt(state.edgeR, 10),
          paperMax: parseInt(state.paperMax, 10),
          rightColW: parseInt(state.rightColW, 10)
        };
        localStorage.setItem(configKey(), JSON.stringify(payload));
      }catch(e){}
    }

    function loadConfig(){
      try{
        const raw = localStorage.getItem(configKey());
        if(!raw) return null;
        const cfg = JSON.parse(raw) || null;
        return cfg;
      }catch(e){ return null; }
    }

    /************************************************************
     * Google Login (GIS)
     ************************************************************/
    function b64urlDecode(str){
      str = (str||"").replace(/-/g, "+").replace(/_/g, "/");
      const pad = str.length % 4;
      if(pad) str += "=".repeat(4 - pad);
      try{ return decodeURIComponent(escape(atob(str))); }catch(e){
        try{ return atob(str); }catch(e2){ return ""; }
      }
    }
    function parseJwt(token){
      const parts = (token||"").split(".");
      if(parts.length < 2) return null;
      try{
        const json = b64urlDecode(parts[1]);
        return JSON.parse(json);
      }catch(e){ return null; }
    }

    function openLogin(){
      $("loginMask").style.display = "flex";
      $("loginMask").setAttribute("aria-hidden","false");

      const warn = $("loginWarn");
      warn.style.display = "none";
      warn.textContent = "";

      if(!GOOGLE_CLIENT_ID){
        warn.style.display = "block";
        warn.textContent = "⚠️ Falta configurar o GOOGLE_CLIENT_ID no código (no topo do <script>).";
        $("googleBtnMount").innerHTML = "";
        return;
      }

      $("googleBtnMount").innerHTML = "";
      if(window.google && google.accounts && google.accounts.id){
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: (resp)=>{
            const payload = parseJwt(resp.credential);
            if(!payload || !payload.email){
              warn.style.display = "block";
              warn.textContent = "Não foi possível ler os dados da conta. Tente novamente.";
              return;
            }
            onLogged({
              email: payload.email,
              name: payload.name || payload.given_name || payload.email,
              picture: payload.picture || "",
              sub: payload.sub || ""
            });
            closeLogin();
          }
        });

        google.accounts.id.renderButton(
          $("googleBtnMount"),
          { theme: "outline", size: "large", shape: "pill", width: 360 }
        );
      }else{
        warn.style.display = "block";
        warn.textContent = "Carregando Google… se não aparecer, recarregue a página.";
      }
    }

    function closeLogin(){
      $("loginMask").style.display = "none";
      $("loginMask").setAttribute("aria-hidden","true");
    }

    function openAccountMenu(){
      const wrap = $("acctWrap");
      wrap.style.display = "block";
      wrap.setAttribute("aria-hidden","false");
    }
    function closeAccountMenu(){
      const wrap = $("acctWrap");
      wrap.style.display = "none";
      wrap.setAttribute("aria-hidden","true");
    }
    function toggleAccountMenu(){
      const wrap = $("acctWrap");
      const isOpen = wrap.style.display === "block";
      if(isOpen) closeAccountMenu(); else openAccountMenu();
    }

    function onLogged(user){
      state.user = user;
      saveSession();
      applyUserUI();

      const p = loadProfile();
      if(p){
        state.docTitle = (p.docTitle === "Dra.") ? "Dra." : "Dr.";
        state.docName = safeText(p.docName);
        state.crms = Array.isArray(p.crms) && p.crms.length ? p.crms.map(safeText) : [""];
        state.rqes = Array.isArray(p.rqes) && p.rqes.length ? p.rqes.map(safeText) : [""];
      }

      $("docTitle").value = state.docTitle;
      $("docName").value = state.docName;
      renderCrmList();
      renderRqeList();

      $("persistHint").textContent = "Logado — suas alterações do médico serão salvas automaticamente nesta conta.";
      updateSummaries();
      renderPaperDebounced();
    }

    function logout(){
      state.user = null;
      saveSession();
      applyUserUI();
      closeAccountMenu();
      $("persistHint").textContent = "Faça login para salvar os dados do médico “para sempre” nessa conta (e recarregar automaticamente no futuro).";
    }

    function applyUserUI(){
      const has = !!(state.user && state.user.email);

      $("btnGoogleLogin").style.display = has ? "none" : "inline-flex";
      $("btnAccount").style.display = has ? "grid" : "none";

      if(has){
        $("userName").textContent = state.user.name || "Conta Google";
        $("userEmail").textContent = state.user.email;
        $("userPic").src = state.user.picture || PLACEHOLDER_PNG;
      }else{
        $("userName").textContent = "—";
        $("userEmail").textContent = "—";
        $("userPic").src = PLACEHOLDER_PNG;
      }
    }

    /************************************************************
     * CSV Parser
     ************************************************************/
    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      const s = (text || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");
      for(let i=0;i<s.length;i++){
        const ch = s[i];

        if(inQuotes){
          if(ch === '"'){
            const next = s[i+1];
            if(next === '"'){ cur += '"'; i++; }
            else{ inQuotes = false; }
          }else{
            cur += ch;
          }
        }else{
          if(ch === '"'){ inQuotes = true; }
          else if(ch === ","){
            row.push(cur);
            cur = "";
          }else if(ch === "\n"){
            row.push(cur);
            rows.push(row);
            row = [];
            cur = "";
          }else{
            cur += ch;
          }
        }
      }
      row.push(cur);
      rows.push(row);
      return rows.filter(r => r.some(c => safeText(c)));
    }

    function splitQty(s){
      const raw = safeText(s);
      if(!raw) return [];
      const arr = raw.split(";").map(x=> safeText(x)).filter(Boolean);
      const seen = new Set();
      const out = [];
      for(const it of arr){
        const k = keyify(it);
        if(!k || seen.has(k)) continue;
        seen.add(k);
        out.push(it);
      }
      return out;
    }

    async function fetchTextWithFallback(urls){
      let lastErr = null;
      for(const url of urls){
        try{
          const res = await fetch(url, { cache:"no-store" });
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const txt = await res.text();
          if(!txt || txt.length < 3) throw new Error("Resposta vazia");
          return txt;
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("Falha ao buscar");
    }

    /************************************************************
     * SIDEBAR NAV (Sumário) — carrega da planilha
     ************************************************************/
    function renderSidebar(items){
      const nav = $("sideNav");
      nav.innerHTML = "";

      const list = document.createElement("div");
      list.className = "sideNavList";

      if(!items || !items.length){
        const empty = document.createElement("div");
        empty.className = "navLoading";
        empty.textContent = "Menu vazio.";
        nav.appendChild(empty);
        return;
      }

      for(const it of items){
        const a = document.createElement("a");
        a.className = "navItem";
        a.href = it.href || "#";
        a.rel = "noopener";
        a.setAttribute("aria-label", it.name || "Atalho");

        const img = document.createElement("img");
        img.className = "navIcon";
        img.alt = "";
        img.loading = "lazy";
        img.decoding = "async";
        img.src = it.img || PLACEHOLDER_PNG;
        img.addEventListener("error", ()=>{ img.src = PLACEHOLDER_PNG; }, { once:true });

        const label = document.createElement("div");
        label.className = "navLabel";
        label.textContent = it.name || "—";

        a.appendChild(img);
        a.appendChild(label);

        list.appendChild(a);
      }

      nav.appendChild(list);
    }

    async function loadSidebarNav(){
      const nav = $("sideNav");
      if(nav) nav.innerHTML = `<div class="navLoading">Carregando menu…</div>`;

      try{
        const csvText = await fetchTextWithFallback(NAV_CSV_URLS);
        const rows = parseCSV(csvText);
        if(!rows.length){ renderSidebar([]); return; }

        let start = 0;
        const h0 = keyify(rows[0]?.[0] || "");
        const h1 = keyify(rows[0]?.[1] || "");
        const h2 = keyify(rows[0]?.[2] || "");
        const looksHeader =
          (h0.includes("nome") || h0.includes("name") || h0.includes("titulo")) ||
          (h1.includes("imagem") || h1.includes("icon") || h1.includes("icone")) ||
          (h2.includes("link") || h2.includes("url") || h2.includes("redirect"));
        if(looksHeader) start = 1;

        const items = [];
        for(let i=start;i<rows.length;i++){
          const r = rows[i] || [];
          const name = safeText(r[0] || "");
          const img = safeText(r[1] || "");
          const href = safeText(r[2] || "");
          if(!name && !href && !img) continue;

          items.push({
            name: name || "Acesso",
            img: img || "",
            href: href || "#"
          });
        }

        renderSidebar(items);
      }catch(e){
        renderSidebar([]);
      }
    }

    /************************************************************
     * Medicamentos DB
     ************************************************************/
    async function fetchCsvByGid(gid){
      const urls = [
        `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SHEET_ID)}/gviz/tq?tqx=out:csv&gid=${encodeURIComponent(gid)}`,
        `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SHEET_ID)}/export?format=csv&gid=${encodeURIComponent(gid)}`
      ];
      return await fetchTextWithFallback(urls);
    }

    async function loadMedicamentosDB(){
      if(db_loading) return;
      db_loading = true;
      db_loaded = false;
      db_medicamentos = [];
      $("dbStatus").textContent = "Carregando base de medicamentos…";

      try{
        const allItems = [];
        for(const tab of SHEET_TABS){
          let csvText = "";
          try{
            csvText = await fetchCsvByGid(tab.gid);
          }catch(e){
            continue;
          }
          const rows = parseCSV(csvText);

          let start = 0;
          if(rows.length){
            const h0 = keyify(rows[0]?.[0] || "");
            const h3 = keyify(rows[0]?.[3] || "");
            if(h0.includes("nome") || h0.includes("comercial") || h3.includes("generico")) start = 1;
          }

          for(let i=start;i<rows.length;i++){
            const r = rows[i] || [];
            const A = safeText(r[0] || "");
            const B = safeText(r[1] || "");
            const C = safeText(r[2] || "");
            const D = safeText(r[3] || "");
            const E = safeText(r[4] || "");

            if(!A && !D) continue;

            if(A){
              allItems.push({
                type: "A",
                main: A,
                sub: B,
                qty: splitQty(C),
                categoria: tab.name || `Aba ${tab.gid}`
              });
            }
            if(D){
              allItems.push({
                type: "B",
                main: D,
                sub: "",
                qty: splitQty(E),
                categoria: tab.name || `Aba ${tab.gid}`
              });
            }
          }
        }

        const map = new Map();
        for(const it of allItems){
          const k = `${it.type}|${keyify(it.main)}|${keyify(it.sub || "")}`;
          if(!map.has(k)){
            map.set(k, {
              type: it.type,
              main: it.main,
              sub: it.sub || "",
              qty: Array.isArray(it.qty) ? it.qty.slice() : [],
              categorias: it.categoria ? [it.categoria] : [],
              color: DEFAULT_DOT_COLOR
            });
          }else{
            const cur = map.get(k);
            if(it.categoria && !cur.categorias.includes(it.categoria)) cur.categorias.push(it.categoria);
            if(Array.isArray(it.qty)){
              const seen = new Set(cur.qty.map(x=> keyify(x)));
              for(const q of it.qty){
                const kk = keyify(q);
                if(!kk || seen.has(kk)) continue;
                seen.add(kk);
                cur.qty.push(q);
              }
            }
          }
        }

        db_medicamentos = Array.from(map.values()).map(x=>{
          const catLabel = x.categorias?.length ? x.categorias[0] : "—";
          return {
            type: x.type,
            main: x.main,
            sub: x.sub,
            qty: x.qty || [],
            categorias: x.categorias || [],
            catLabel,
            color: x.color || DEFAULT_DOT_COLOR,
            search: keyify([x.main, x.sub, (x.categorias||[]).join(" ")].join(" ")),
            mainKey: keyify(x.main),
            subKey: keyify(x.sub || "")
          };
        });

        db_medicamentos.sort((p,q)=> (p.main||"").localeCompare((q.main||""), "pt-BR", { sensitivity:"base" }));

        db_loaded = true;
        $("dbStatus").textContent = `Base carregada: ${db_medicamentos.length} itens.`;
      }catch(e){
        db_loaded = false;
        db_medicamentos = [];
        $("dbStatus").textContent = "Falha ao carregar base. Você ainda pode digitar manualmente.";
      }finally{
        db_loading = false;
      }
    }

    /************************************************************
     * CRM/RQE lists
     ************************************************************/
    function buildLineRow(type, idx){
      const row = document.createElement("div");
      row.className = "row";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.gap = "10px";
      row.style.flexWrap = "nowrap";

      const wrap = document.createElement("div");
      wrap.style.display = "flex";
      wrap.style.alignItems = "center";
      wrap.style.gap = "10px";
      wrap.style.flex = "1";
      wrap.style.minWidth = "0";

      const inp = document.createElement("input");
      inp.className = "field";
      inp.placeholder = (type === "CRM") ? "Ex: BA 12345" : "Ex: 123456";
      inp.value = safeText((type === "CRM" ? state.crms[idx] : state.rqes[idx]) || "");
      inp.autocomplete = "off";
      inp.inputMode = "text";
      inp.style.flex = "1";
      inp.style.minWidth = "0";

      inp.addEventListener("input", ()=>{
        const v = safeText(inp.value);
        if(type === "CRM"){
          state.crms[idx] = v;
        }else{
          state.rqes[idx] = v;
        }
        if(state.user) saveProfileDebounced();
        updateSummaries();
        renderPaperDebounced();
      });

      const btnX = document.createElement("button");
      btnX.className = "btn btnGhost";
      btnX.type = "button";
      btnX.textContent = "Remover";
      btnX.style.height = "40px";

      btnX.addEventListener("click", ()=>{
        if(type === "CRM"){
          state.crms.splice(idx, 1);
          if(!state.crms.length) state.crms = [""];
          renderCrmList();
        }else{
          state.rqes.splice(idx, 1);
          if(!state.rqes.length) state.rqes = [""];
          renderRqeList();
        }
        if(state.user) saveProfileDebounced();
        updateSummaries();
        renderPaperDebounced();
      });

      wrap.appendChild(inp);
      row.appendChild(wrap);
      row.appendChild(btnX);

      return row;
    }

    function renderCrmList(){
      const host = $("crmList");
      host.innerHTML = "";
      state.crms = Array.isArray(state.crms) && state.crms.length ? state.crms : [""];
      state.crms.forEach((_, idx)=>{
        host.appendChild(buildLineRow("CRM", idx));
      });
    }

    function renderRqeList(){
      const host = $("rqeList");
      host.innerHTML = "";
      state.rqes = Array.isArray(state.rqes) && state.rqes.length ? state.rqes : [""];
      state.rqes.forEach((_, idx)=>{
        host.appendChild(buildLineRow("RQE", idx));
      });
    }

    /************************************************************
     * Summaries
     ************************************************************/
    function updateSummaries(){
      // Médico
      const docNm = safeText(state.docName);
      const crms = (state.crms||[]).map(safeText).filter(Boolean);
      const rqes = (state.rqes||[]).map(safeText).filter(Boolean);

      const sumMed = [];
      if(docNm) sumMed.push(`${state.docTitle} ${docNm}`);
      if(crms.length) sumMed.push(`CRM: ${crms.join(" | ")}`);
      if(rqes.length) sumMed.push(`RQE: ${rqes.join(" | ")}`);
      $("sumMedico").textContent = sumMed.length ? sumMed.join(" — ") : "—";

      // Paciente
      const pn = safeText(state.patientName);
      const dv = safeText(state.patientDocValue);
      const dt = safeText(state.patientDocType);
      const sumPac = [];
      if(pn) sumPac.push(pn);
      if(dv) sumPac.push(`${dt}: ${dv}`);
      $("sumPaciente").textContent = sumPac.length ? sumPac.join(" — ") : "—";

      // Meds
      const n = (state.blocks||[]).length;
      $("sumMeds").textContent = n ? `${n} medicamento${n>1?"s":""}` : "—";
    }

    /************************************************************
     * Autocomplete (Medicamentos)
     ************************************************************/
    function scoreText(q, text){
      const qq = keyify(q);
      const tt = keyify(text);
      if(!qq || !tt) return 0;

      if(tt === qq) return 120;
      if(tt.startsWith(qq)) return 95;
      if(tt.includes(qq)) return 70;

      // tokens
      const toks = qq.split(/\s+/).filter(Boolean);
      let s = 0;
      let hit = 0;
      for(const t of toks){
        if(!t) continue;
        if(tt.includes(t)){
          hit++;
          s += (t.length >= 4 ? 18 : 10);
          if(tt.startsWith(t)) s += 6;
        }
      }
      if(hit === 0) return 0;

      // small penalty by distance (rough)
      const pos = tt.indexOf(toks[0] || "");
      if(pos > 0) s -= Math.min(12, Math.floor(pos/6));

      return s;
    }

    function computeHits(q){
      const qq = safeText(q);
      if(!qq) return [];
      const list = db_loaded ? db_medicamentos : [];
      if(!list.length) return [];

      const out = [];
      for(const it of list){
        const s1 = scoreText(qq, it.main || "");
        const s2 = it.sub ? scoreText(qq, it.sub) * 0.85 : 0;
        const s3 = it.catLabel ? scoreText(qq, it.catLabel) * 0.65 : 0;
        const sc = Math.max(s1, s2, s3);
        if(sc <= 0) continue;
        out.push({ it, sc });
      }
      out.sort((a,b)=> b.sc - a.sc);
      return out.slice(0, 12).map(x=> x.it);
    }

    /************************************************************
     * Medicamento blocks UI
     ************************************************************/
    const ICONS = [
      { id:"manha", label:"Manhã", emoji:"☀️" },
      { id:"tarde", label:"Tarde", emoji:"🌤️" },
      { id:"noite", label:"Noite", emoji:"🌙" },
      { id:"refeicao", label:"Com refeição", emoji:"🍽️" },
      { id:"jejum", label:"Em jejum", emoji:"⏳" },
      { id:"agua", label:"Com água", emoji:"💧" },
      { id:"dose", label:"Dose", emoji:"💊" },
      { id:"alarme", label:"Horário", emoji:"⏰" }
    ];

    function newBlock(){
      return {
        id: uid(),
        name: "",
        qty: "",
        qtyOptions: [],
        use: "",
        showIcons: false,
        icons: [],
        collapsed: false,
        _selectedKey: "" // internal
      };
    }

    function addBlock(){
      state.blocks = Array.isArray(state.blocks) ? state.blocks : [];
      state.blocks.push(newBlock());
      updateSummaries();
      renderRxBlocks();
      renderPaperDebounced();
    }

    function duplicateBlock(id){
      const idx = (state.blocks||[]).findIndex(b=> b.id === id);
      if(idx < 0) return;
      const src = state.blocks[idx];
      const copy = {
        ...src,
        id: uid(),
        icons: Array.isArray(src.icons) ? src.icons.slice() : [],
        qtyOptions: Array.isArray(src.qtyOptions) ? src.qtyOptions.slice() : []
      };
      state.blocks.splice(idx+1, 0, copy);
      updateSummaries();
      renderRxBlocks();
      renderPaperDebounced();
    }

    function removeBlock(id){
      state.blocks = (state.blocks||[]).filter(b=> b.id !== id);
      if(!state.blocks.length) state.blocks = [];
      updateSummaries();
      renderRxBlocks();
      renderPaperDebounced();
    }

    function toggleCollapseBlock(id){
      const b = (state.blocks||[]).find(x=> x.id === id);
      if(!b) return;
      b.collapsed = !b.collapsed;
      renderRxBlocks();
    }

    function setBlockSelected(block, item){
      if(!block) return;
      block.name = safeText(item?.main || "");
      block._selectedKey = keyify(block.name);
      block.qtyOptions = Array.isArray(item?.qty) ? item.qty.slice() : [];
    }

    function renderRxBlocks(){
      const host = $("rxBlocks");
      host.innerHTML = "";

      const blocks = Array.isArray(state.blocks) ? state.blocks : [];
      if(!blocks.length){
        const hint = document.createElement("div");
        hint.className = "mini";
        hint.style.padding = "10px 2px";
        hint.textContent = "Nenhum medicamento ainda. Clique em “+ Adicionar medicamento”.";
        host.appendChild(hint);
        return;
      }

      blocks.forEach((b, index)=>{
        const block = document.createElement("div");
        block.className = "rxBlock" + (b.collapsed ? " collapsed" : "");
        block.dataset.id = b.id;

        // Top
        const top = document.createElement("div");
        top.className = "rxTop";

        const title = document.createElement("div");
        title.className = "rxTitle";

        const num = document.createElement("div");
        num.className = "rxNum";
        num.textContent = String(index+1);

        const strong = document.createElement("strong");
        strong.textContent = safeText(b.name) || "Medicamento sem nome";

        title.appendChild(num);
        title.appendChild(strong);

        const tools = document.createElement("div");
        tools.className = "rxTools";

        const btnCollapse = document.createElement("button");
        btnCollapse.type = "button";
        btnCollapse.className = "iconBtn iconBtnDim";
        btnCollapse.title = b.collapsed ? "Expandir" : "Recolher";
        btnCollapse.textContent = b.collapsed ? "▾" : "▴";
        btnCollapse.addEventListener("click", ()=> toggleCollapseBlock(b.id));

        const btnDup = document.createElement("button");
        btnDup.type = "button";
        btnDup.className = "iconBtn iconBtnDim";
        btnDup.title = "Duplicar";
        btnDup.textContent = "⎘";
        btnDup.addEventListener("click", ()=> duplicateBlock(b.id));

        const btnDel = document.createElement("button");
        btnDel.type = "button";
        btnDel.className = "iconBtn iconBtnDanger";
        btnDel.title = "Remover";
        btnDel.textContent = "✕";
        btnDel.addEventListener("click", ()=> removeBlock(b.id));

        tools.appendChild(btnCollapse);
        tools.appendChild(btnDup);
        tools.appendChild(btnDel);

        top.appendChild(title);
        top.appendChild(tools);

        // Body
        const expanded = document.createElement("div");
        expanded.className = "rxExpandedBody";

        const grid = document.createElement("div");
        grid.className = "rxGrid";

        // Name + autocomplete
        const colA = document.createElement("div");
        const labA = document.createElement("label");
        labA.className = "label";
        labA.textContent = "Medicamento";
        colA.appendChild(labA);

        const acWrap = document.createElement("div");
        acWrap.className = "acWrap";

        const inpName = document.createElement("input");
        inpName.className = "field";
        inpName.placeholder = db_loaded ? "Digite para buscar…" : "Digite o nome do medicamento…";
        inpName.value = safeText(b.name);
        inpName.autocomplete = "off";
        inpName.spellcheck = false;

        const acList = document.createElement("div");
        acList.className = "acList";

        const hideList = ()=>{ acList.style.display = "none"; acList.innerHTML = ""; };
        const showList = (items)=>{
          acList.innerHTML = "";
          if(!items.length){
            const empty = document.createElement("div");
            empty.className = "acEmpty";
            empty.textContent = db_loaded ? "Nenhum resultado." : "Base não carregada. Você pode digitar manualmente.";
            acList.appendChild(empty);
            acList.style.display = "block";
            return;
          }

          for(const it of items){
            const row = document.createElement("div");
            row.className = "medItem";

            const dot = document.createElement("div");
            dot.className = "medDot";
            dot.style.background = it.color || DEFAULT_DOT_COLOR;

            const main = document.createElement("div");
            main.className = "medMain";

            const topRow = document.createElement("div");
            topRow.className = "medTopRow";

            const a = document.createElement("div");
            a.className = "medA";
            a.textContent = it.main || "—";

            const tag = document.createElement("div");
            tag.className = "medTag";
            tag.textContent = it.catLabel || "—";

            topRow.appendChild(a);
            topRow.appendChild(tag);

            main.appendChild(topRow);

            if(it.sub){
              const bsub = document.createElement("div");
              bsub.className = "medB";
              bsub.textContent = it.sub;
              main.appendChild(bsub);
            }

            row.appendChild(dot);
            row.appendChild(main);

            row.addEventListener("mousedown", (e)=> e.preventDefault());
            row.addEventListener("click", ()=>{
              setBlockSelected(b, it);
              inpName.value = b.name;

              // Re-render this block's qty datalist quickly:
              renderRxBlocks();
              renderPaperDebounced();
            });

            acList.appendChild(row);
          }

          acList.style.display = "block";
        };

        const runSearch = debounce(()=>{
          const q = safeText(inpName.value);
          // manual typing always updates
          b.name = q;
          b._selectedKey = keyify(q);

          if(!db_loaded || !q){
            hideList();
            updateSummaries();
            renderPaperDebounced();
            return;
          }
          const hits = computeHits(q);
          showList(hits);
          updateSummaries();
          renderPaperDebounced();
        }, 80);

        inpName.addEventListener("input", runSearch);
        inpName.addEventListener("focus", ()=>{
          const q = safeText(inpName.value);
          if(db_loaded && q){
            const hits = computeHits(q);
            showList(hits);
          }
        });
        inpName.addEventListener("blur", ()=> setTimeout(hideList, 140));

        acWrap.appendChild(inpName);
        acWrap.appendChild(acList);

        colA.appendChild(acWrap);

        const mini = document.createElement("div");
        mini.className = "mini";
        mini.style.marginTop = "8px";
        mini.textContent = db_loaded ? "Clique em um resultado para puxar as opções de “Quantidade / Apresentação”." : "Carregando base… (ou digite manualmente).";
        colA.appendChild(mini);

        // Qty
        const colB = document.createElement("div");
        const labB = document.createElement("label");
        labB.className = "label";
        labB.textContent = "Quantidade / Apresentação";
        colB.appendChild(labB);

        const inpQty = document.createElement("input");
        inpQty.className = "field";
        inpQty.placeholder = "Ex: 30 comprimidos / 1 frasco / 1 caixa…";
        inpQty.value = safeText(b.qty);
        inpQty.autocomplete = "off";

        const listId = `qtyList_${b.id}`;
        inpQty.setAttribute("list", listId);

        const dlist = document.createElement("datalist");
        dlist.id = listId;

        const opts = Array.isArray(b.qtyOptions) ? b.qtyOptions : [];
        for(const opt of opts.slice(0, 50)){
          const o = document.createElement("option");
          o.value = opt;
          dlist.appendChild(o);
        }

        inpQty.addEventListener("input", ()=>{
          b.qty = safeText(inpQty.value);
          renderPaperDebounced();
        });

        colB.appendChild(inpQty);
        colB.appendChild(dlist);

        grid.appendChild(colA);
        grid.appendChild(colB);

        const full = document.createElement("div");
        full.className = "rxFull";

        const labC = document.createElement("label");
        labC.className = "label";
        labC.textContent = "Posologia / Orientações";
        full.appendChild(labC);

        const ta = document.createElement("textarea");
        ta.className = "field";
        ta.placeholder = "Ex: Tomar 1 comprimido VO a cada 12 horas por 7 dias.";
        ta.value = (b.use || "");
        ta.addEventListener("input", ()=>{
          b.use = ta.value;
          renderPaperDebounced();
        });
        full.appendChild(ta);

        const row2 = document.createElement("div");
        row2.className = "row";
        row2.style.marginTop = "10px";

        const toggle = document.createElement("label");
        toggle.className = "toggle";
        toggle.title = "Mostrar ícones abaixo do texto na receita";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!b.showIcons;
        const sp = document.createElement("span");
        sp.textContent = "Ícones abaixo";
        cb.addEventListener("change", ()=>{
          b.showIcons = !!cb.checked;
          renderRxBlocks();
          renderPaperDebounced();
        });
        toggle.appendChild(cb);
        toggle.appendChild(sp);

        const btnClearUse = document.createElement("button");
        btnClearUse.className = "btn btnGhost";
        btnClearUse.type = "button";
        btnClearUse.textContent = "Limpar posologia";
        btnClearUse.addEventListener("click", ()=>{
          b.use = "";
          renderRxBlocks();
          renderPaperDebounced();
        });

        row2.appendChild(toggle);
        row2.appendChild(btnClearUse);

        full.appendChild(row2);

        const iconPick = document.createElement("div");
        iconPick.className = "iconPick";
        iconPick.style.display = b.showIcons ? "flex" : "none";

        const chosen = new Set((b.icons||[]).map(String));
        for(const ic of ICONS){
          const tag = document.createElement("div");
          tag.className = "iconTag" + (chosen.has(ic.id) ? " on" : "");
          tag.innerHTML = `<span aria-hidden="true">${ic.emoji}</span><span>${ic.label}</span>`;
          tag.addEventListener("click", ()=>{
            b.icons = Array.isArray(b.icons) ? b.icons : [];
            const set = new Set(b.icons.map(String));
            if(set.has(ic.id)) set.delete(ic.id);
            else set.add(ic.id);
            b.icons = Array.from(set);
            renderRxBlocks();
            renderPaperDebounced();
          });
          iconPick.appendChild(tag);
        }

        full.appendChild(iconPick);

        expanded.appendChild(grid);
        expanded.appendChild(full);

        block.appendChild(top);
        block.appendChild(expanded);

        host.appendChild(block);
      });
    }

    /************************************************************
     * Pages (heuristic pagination)
     ************************************************************/
    function estimateLinesForBlock(b){
      let n = 1; // main line
      const u = safeText(b.use);
      if(u){
        n += Math.max(1, Math.ceil(u.length / 72));
      }
      if(b.showIcons && Array.isArray(b.icons) && b.icons.length) n += 1;
      return n;
    }

    function maxLinesPerPage(){
      const font = rxFontPx();
      const base = 34; // tuned for ~13px Times A4 with margins
      const m = Math.floor(base * (13.2 / font));
      return clamp(m, 20, 40);
    }

    function splitIntoPages(blocks){
      const pages = [];
      const maxL = maxLinesPerPage();

      let cur = [];
      let used = 0;

      for(const b of blocks){
        const need = estimateLinesForBlock(b);
        if(cur.length && used + need > maxL){
          pages.push(cur);
          cur = [];
          used = 0;
        }
        cur.push(b);
        used += need;
      }
      if(cur.length) pages.push(cur);
      if(!pages.length) pages.push([]);
      return pages;
    }

    /************************************************************
     * Paper render + Copy
     ************************************************************/
    function doctorLine(){
      const title = safeText(state.docTitle) || "Dr.";
      const name = safeText(state.docName);
      return name ? `${title} ${name}` : "";
    }

    function crmLine(){
      const crms = (state.crms||[]).map(safeText).filter(Boolean);
      if(!crms.length) return "";
      return `CRM: ${crms.join(" | ")}`;
    }

    function rqeLine(){
      const rqes = (state.rqes||[]).map(safeText).filter(Boolean);
      if(!rqes.length) return "";
      return `RQE: ${rqes.join(" | ")}`;
    }

    function patientLine(){
      const pn = safeText(state.patientName);
      if(!pn) return "";
      const dt = safeText(state.patientDocType);
      const dv = safeText(state.patientDocValue);
      if(dv) return `<span class="rxNameLabel">Paciente:</span> <span class="rxNameValue">${escapeHtml(pn)}</span><span class="docInline">${escapeHtml(dt)}: ${escapeHtml(dv)}</span>`;
      return `<span class="rxNameLabel">Paciente:</span> <span class="rxNameValue">${escapeHtml(pn)}</span>`;
    }

    function getIconPills(ids){
      const set = new Set((ids||[]).map(String));
      const pills = [];
      for(const ic of ICONS){
        if(set.has(ic.id)){
          pills.push(`<span>${escapeHtml(ic.emoji)} ${escapeHtml(ic.label)}</span>`);
        }
      }
      return pills.join("");
    }

    function paperSizeClass(){
      if(state.paperSize === "LETTER") return "paperLetter";
      if(state.paperSize === "A5") return "paperA5";
      if(state.paperSize === "LEGAL") return "paperLegal";
      return "paperA4";
    }

    function applyPaperSize(){
      const p = $("paper");
      p.classList.remove("paperA4","paperLetter","paperA5","paperLegal");
      p.classList.add(paperSizeClass());
    }

    function buildHeaderFooter(kind){
      const isHeader = kind === "header";
      const url = safeText(isHeader ? state.headerImgUrl : state.footerImgUrl);
      const tf = isHeader ? (state.headerTransform||{x:0,y:0,scale:1}) : (state.footerTransform||{x:0,y:0,scale:1});
      const cls = isHeader ? "instImgBox header" : "instImgBox footer";
      if(!url) return "";

      return `
        <div class="${cls}"
             data-kind="${isHeader ? "header" : "footer"}"
             style="--tx:${(tf.x||0)}px;--ty:${(tf.y||0)}px;--sc:${(tf.scale||1)};">
          <img class="instImg" src="${escapeAttr(url)}" alt="" draggable="false" />
          <div class="instHandle" title="Arraste para redimensionar"></div>
        </div>
      `;
    }

    function renderPaper(){
      applyLayoutVars();
      applyPaperSize();

      // enforce “qty” no wrap (and number already nowrap)
      if(!document.getElementById("qtyNoWrapStyle")){
        const st = document.createElement("style");
        st.id = "qtyNoWrapStyle";
        st.textContent = `.rxLine .qty{ white-space: nowrap; }`;
        document.head.appendChild(st);
      }

      const blocks = Array.isArray(state.blocks) ? state.blocks : [];
      const pages = splitIntoPages(blocks);

      // clamp selected page
      state.selectedPage = clamp(parseInt(state.selectedPage,10) || 1, 1, pages.length);

      // page selector
      const sel = $("pageSelect");
      sel.innerHTML = "";
      for(let i=1;i<=pages.length;i++){
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `Página ${i}`;
        if(i === state.selectedPage) opt.selected = true;
        sel.appendChild(opt);
      }
      $("pageInfo").textContent = `Página ${state.selectedPage} de ${pages.length}`;

      // render current page
      const cur = pages[state.selectedPage - 1] || [];
      const rx = $("rxPaper");

      // rx styles
      rx.style.setProperty("--rxFont", `${rxFontPx()}px`);
      rx.style.setProperty("--rxFamily", rxFamilyCSS());

      const hasDate = !!state.includeDate;
      const dt = safeText(state.dateValue) || todayBR();

      // numbering across ALL blocks
      const indexMap = new Map();
      blocks.forEach((b, i)=> indexMap.set(b.id, i+1));

      const medsHtml = cur.map((b)=>{
        const idx = indexMap.get(b.id) || 1;
        const nm = safeText(b.name) || "—";
        const qt = safeText(b.qty);
        const use = safeText(b.use);

        const line = `
          <div class="rxLine">
            <span class="rxNo">${idx}.</span>
            <span class="drugName">${escapeHtml(nm)}</span>
            <span class="leaderText" aria-hidden="true"></span>
            <span class="qty">${escapeHtml(qt || " ")}</span>
          </div>
        `;
        const instr = use ? `<div class="rxInstr">${escapeHtml(use)}</div>` : "";
        const icons = (b.showIcons && Array.isArray(b.icons) && b.icons.length)
          ? `<div class="useIconsBelow">${getIconPills(b.icons)}</div>` : "";
        return `<div>${line}${instr}${icons}</div>`;
      }).join("");

      const docNm = doctorLine();
      const crm = crmLine();
      const rqe = rqeLine();

      const sigLines = [
        docNm ? `<div class="docName">${escapeHtml(docNm)}</div>` : `<div class="docName">—</div>`,
        crm ? `<div class="docLine">${escapeHtml(crm)}</div>` : "",
        rqe ? `<div class="docLine">${escapeHtml(rqe)}</div>` : ""
      ].filter(Boolean).join("");

      const instFooter = [safeText(state.instName), safeText(state.instAddress)].filter(Boolean).join(" • ");

      rx.innerHTML = `
        <div class="headerArea">
          ${buildHeaderFooter("header")}
        </div>

        <div class="rxTitleCenter">RECEITA MÉDICA</div>

        <div class="rxMeta">
          <div class="rxPatientLine">${patientLine() || ""}</div>
          ${hasDate ? `<div class="rxDatePill">${escapeHtml(dt)}</div>` : ""}
        </div>

        <div class="rxDividerLine"></div>

        <div class="rxSymbol">R//</div>

        <div class="rxList">${medsHtml || ""}</div>

        <div class="sigWrap">
          <div class="docSig">
            <div class="sigLine"></div>
            <div class="docCenter">${sigLines}</div>
          </div>
        </div>

        <div class="footerArea">
          ${buildHeaderFooter("footer")}
        </div>

        ${instFooter ? `<div class="instFooterGray">${escapeHtml(instFooter)}</div>` : ``}
      `;

      wireTransformHandlers();

      // copy box always = tudo (todas as páginas)
      renderCopyText(blocks);
    }

    const renderPaperDebounced = debounce(renderPaper, 70);

    function renderCopyText(blocks){
      const out = [];
      const dashes = "-".repeat(34);

      blocks.forEach((b, i)=>{
        const nm = safeText(b.name);
        const qt = safeText(b.qty);
        const use = safeText(b.use);

        if(!nm && !qt && !use) return;

        const idx = i+1;
        out.push(`${idx}. ${nm || "—"} ${dashes} ${qt || ""}`.trimEnd());
        if(use) out.push(`   ${use}`);
        if(b.showIcons && Array.isArray(b.icons) && b.icons.length){
          const pills = [];
          for(const ic of ICONS){
            if(b.icons.includes(ic.id)) pills.push(`${ic.emoji} ${ic.label}`);
          }
          if(pills.length) out.push(`   ${pills.join("  ")}`);
        }
        out.push(""); // blank line
      });

      $("copyBox").value = out.join("\n");
      $("copyStatus").textContent = blocks.length ? "Atualizado." : "—";
    }

    /************************************************************
     * Drag/Resize header/footer images on paper
     ************************************************************/
    function wireTransformHandlers(){
      const boxes = Array.from(document.querySelectorAll("#rxPaper .instImgBox"));
      boxes.forEach((box)=>{
        if(box.dataset.bound === "1") return;
        box.dataset.bound = "1";

        const kind = box.dataset.kind === "footer" ? "footer" : "header";
        const handle = box.querySelector(".instHandle");

        const getTf = ()=> (kind === "header" ? state.headerTransform : state.footerTransform);
        const setTf = (tf)=>{
          if(kind === "header") state.headerTransform = tf;
          else state.footerTransform = tf;
        };

        let mode = "drag"; // drag | resize
        let startX = 0, startY = 0;
        let base = null;

        const apply = (tf)=>{
          box.style.setProperty("--tx", `${tf.x}px`);
          box.style.setProperty("--ty", `${tf.y}px`);
          box.style.setProperty("--sc", `${tf.scale}`);
        };

        const onDown = (e)=>{
          e.preventDefault();
          e.stopPropagation();

          mode = (handle && e.target === handle) ? "resize" : "drag";
          box.classList.add("active");

          const tf = getTf() || { x:0, y:0, scale:1 };
          base = { x: tf.x||0, y: tf.y||0, scale: tf.scale||1 };
          startX = e.clientX;
          startY = e.clientY;

          box.setPointerCapture(e.pointerId);
        };

        const onMove = (e)=>{
          if(!base) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;

          if(mode === "drag"){
            const tf = {
              x: clamp(base.x + dx, -260, 260),
              y: clamp(base.y + dy, -160, 160),
              scale: base.scale
            };
            setTf(tf);
            apply(tf);
          }else{
            // uniform scale based on diagonal delta
            const d = (dx - dy) / 220; // tuned
            const sc = clamp(base.scale + d, 0.25, 2.4);
            const tf = { x: base.x, y: base.y, scale: sc };
            setTf(tf);
            apply(tf);
          }
        };

        const onUp = (e)=>{
          if(!base) return;
          base = null;
          box.classList.remove("active");
          try{ box.releasePointerCapture(e.pointerId); }catch(err){}
          // persist
          saveConfig();
        };

        box.addEventListener("pointerdown", onDown);
        box.addEventListener("pointermove", onMove);
        box.addEventListener("pointerup", onUp);
        box.addEventListener("pointercancel", onUp);
      });
    }

    /************************************************************
     * Config modal
     ************************************************************/
    function syncConfigToInputs(){
      $("paperSize").value = state.paperSize;
      $("rxFontFamily").value = state.rxFontFamily;
      $("rxFontSize").value = String(rxFontPx());
      $("includeDate").checked = !!state.includeDate;
      $("dateValue").value = safeText(state.dateValue) || todayBR();

      $("headerUrl").value = safeText(state.headerImgUrl);
      $("footerUrl").value = safeText(state.footerImgUrl);

      $("headerThumb").src = safeText(state.headerImgUrl) || PLACEHOLDER_PNG;
      $("footerThumb").src = safeText(state.footerImgUrl) || PLACEHOLDER_PNG;

      $("instName").value = safeText(state.instName);
      $("instAddress").value = safeText(state.instAddress);

      $("layoutEdgeL").value = String(parseInt(state.edgeL,10) || 0);
      $("layoutEdgeR").value = String(parseInt(state.edgeR,10) || 0);
      $("layoutPaperMax").value = String(parseInt(state.paperMax,10) || 600);
      $("layoutRightColW").value = String(parseInt(state.rightColW,10) || 440);
    }

    function readConfigFromInputs(){
      state.paperSize = $("paperSize").value || "A4";
      state.rxFontFamily = $("rxFontFamily").value || "TIMES";

      state.rxFontSize = rxFontPx(); // keep current first
      const fs = parseFloat(String($("rxFontSize").value||"").replace(",", "."));
      if(isFinite(fs)) state.rxFontSize = clamp(fs, 7.5, 18);

      state.includeDate = !!$("includeDate").checked;
      state.dateValue = safeText($("dateValue").value) || todayBR();

      state.headerImgUrl = safeText($("headerUrl").value);
      state.footerImgUrl = safeText($("footerUrl").value);

      state.instName = safeText($("instName").value);
      state.instAddress = safeText($("instAddress").value);

      const el = parseInt($("layoutEdgeL").value,10);
      const er = parseInt($("layoutEdgeR").value,10);
      const pm = parseInt($("layoutPaperMax").value,10);
      const rc = parseInt($("layoutRightColW").value,10);

      if(isFinite(el)) state.edgeL = clamp(el, 0, 120);
      if(isFinite(er)) state.edgeR = clamp(er, 0, 120);
      if(isFinite(pm)) state.paperMax = clamp(pm, 320, 1100);
      if(isFinite(rc)) state.rightColW = clamp(rc, 280, 920);

      applyLayoutVars();
    }

    function openConfig(){
      syncConfigToInputs();
      $("configMask").style.display = "flex";
      $("configMask").setAttribute("aria-hidden","false");
    }
    function closeConfig(){
      $("configMask").style.display = "none";
      $("configMask").setAttribute("aria-hidden","true");
    }

    /************************************************************
     * Mobile tabs
     ************************************************************/
    function setMobileTab(which){
      const isMobile = window.matchMedia("(max-width: 980px)").matches;
      if(!isMobile){
        $("leftCol").style.display = "";
        $("rightCol").style.display = "";
        $("tabEditor").classList.add("on");
        $("tabPreview").classList.remove("on");
        return;
      }

      if(which === "preview"){
        $("leftCol").style.display = "none";
        $("rightCol").style.display = "";
        $("tabEditor").classList.remove("on");
        $("tabPreview").classList.add("on");
      }else{
        $("leftCol").style.display = "";
        $("rightCol").style.display = "none";
        $("tabEditor").classList.add("on");
        $("tabPreview").classList.remove("on");
      }
    }

    /************************************************************
     * Print
     ************************************************************/
    function renderPrintPages(pagesToPrint){
      const all = $("printAll");
      all.innerHTML = "";

      const blocks = Array.isArray(state.blocks) ? state.blocks : [];
      const pages = splitIntoPages(blocks);

      const wanted = pagesToPrint === "all"
        ? pages.map((_,i)=> i+1)
        : [state.selectedPage];

      // numbering across all meds
      const indexMap = new Map();
      blocks.forEach((b, i)=> indexMap.set(b.id, i+1));

      wanted.forEach((pno, idx)=>{
        const cur = pages[pno-1] || [];

        const shell = document.createElement("div");
        shell.className = "printPage";

        const paper = document.createElement("div");
        paper.className = `paper ${paperSizeClass()}`;
        paper.style.maxWidth = "none";

        const inner = document.createElement("div");
        inner.className = "paperInner";

        const rx = document.createElement("div");
        rx.className = "rxPaper";
        rx.style.setProperty("--rxFont", `${rxFontPx()}px`);
        rx.style.setProperty("--rxFamily", rxFamilyCSS());

        const hasDate = !!state.includeDate;
        const dt = safeText(state.dateValue) || todayBR();

        const medsHtml = cur.map((b)=>{
          const idxG = indexMap.get(b.id) || 1;
          const nm = safeText(b.name) || "—";
          const qt = safeText(b.qty);
          const use = safeText(b.use);
          const line = `
            <div class="rxLine">
              <span class="rxNo">${idxG}.</span>
              <span class="drugName">${escapeHtml(nm)}</span>
              <span class="leaderText" aria-hidden="true"></span>
              <span class="qty">${escapeHtml(qt || " ")}</span>
            </div>
          `;
          const instr = use ? `<div class="rxInstr">${escapeHtml(use)}</div>` : "";
          const icons = (b.showIcons && Array.isArray(b.icons) && b.icons.length)
            ? `<div class="useIconsBelow">${getIconPills(b.icons)}</div>` : "";
          return `<div>${line}${instr}${icons}</div>`;
        }).join("");

        const docNm = doctorLine();
        const crm = crmLine();
        const rqe = rqeLine();
        const sigLines = [
          docNm ? `<div class="docName">${escapeHtml(docNm)}</div>` : `<div class="docName">—</div>`,
          crm ? `<div class="docLine">${escapeHtml(crm)}</div>` : "",
          rqe ? `<div class="docLine">${escapeHtml(rqe)}</div>` : ""
        ].filter(Boolean).join("");

        const instFooter = [safeText(state.instName), safeText(state.instAddress)].filter(Boolean).join(" • ");

        rx.innerHTML = `
          <div class="headerArea">${buildHeaderFooter("header")}</div>
          <div class="rxTitleCenter">PRESCRIÇÃO</div>
          <div class="rxMeta">
            <div class="rxPatientLine">${patientLine() || ""}</div>
            ${hasDate ? `<div class="rxDatePill">${escapeHtml(dt)}</div>` : ""}
          </div>
          <div class="rxDividerLine"></div>
          <div class="rxSymbol">R//</div>
          <div class="rxList">${medsHtml || ""}</div>
          <div class="sigWrap">
            <div class="docSig">
              <div class="sigLine"></div>
              <div class="docCenter">${sigLines}</div>
            </div>
          </div>
          <div class="footerArea">${buildHeaderFooter("footer")}</div>
          ${instFooter ? `<div class="instFooterGray">${escapeHtml(instFooter)}</div>` : ``}
        `;

        inner.appendChild(rx);
        paper.appendChild(inner);
        shell.appendChild(paper);

        all.appendChild(shell);
      });
    }

    function printCurrent(){
      renderPrintPages("one");
      window.print();
    }
    function printAll(){
      renderPrintPages("all");
      window.print();
    }

    /************************************************************
     * Init + Bindings
     ************************************************************/
    function bindEvents(){
      // login
      $("btnGoogleLogin").addEventListener("click", openLogin);
      $("btnCloseLogin").addEventListener("click", closeLogin);
      $("btnCloseLogin2").addEventListener("click", closeLogin);
      $("loginMask").addEventListener("mousedown", (e)=>{ if(e.target === $("loginMask")) closeLogin(); });

      // account
      $("btnAccount").addEventListener("click", (e)=>{ e.stopPropagation(); toggleAccountMenu(); });
      $("btnLogout").addEventListener("click", logout);
      document.addEventListener("click", ()=> closeAccountMenu());

      // médico
      $("docTitle").addEventListener("change", ()=>{
        state.docTitle = $("docTitle").value === "Dra." ? "Dra." : "Dr.";
        if(state.user) saveProfileDebounced();
        updateSummaries();
        renderPaperDebounced();
      });
      $("docName").addEventListener("input", ()=>{
        state.docName = safeText($("docName").value);
        if(state.user) saveProfileDebounced();
        updateSummaries();
        renderPaperDebounced();
      });

      $("btnAddCRM").addEventListener("click", ()=>{
        state.crms = Array.isArray(state.crms) ? state.crms : [];
        state.crms.push("");
        renderCrmList();
      });
      $("btnAddRQE").addEventListener("click", ()=>{
        state.rqes = Array.isArray(state.rqes) ? state.rqes : [];
        state.rqes.push("");
        renderRqeList();
      });

      // paciente
      $("patientName").addEventListener("input", ()=>{
        state.patientName = safeText($("patientName").value);
        updateSummaries();
        renderPaperDebounced();
      });
      $("patientDocType").addEventListener("change", ()=>{
        state.patientDocType = $("patientDocType").value || "CPF";
        updateSummaries();
        renderPaperDebounced();
      });
      $("patientDocValue").addEventListener("input", ()=>{
        state.patientDocValue = safeText($("patientDocValue").value);
        updateSummaries();
        renderPaperDebounced();
      });

      // meds
      $("btnAddMed").addEventListener("click", addBlock);
      $("btnAddMed2").addEventListener("click", addBlock);

      $("btnClear").addEventListener("click", ()=>{
        // limpa paciente + meds (mantém médico/config)
        state.patientName = "";
        state.patientDocValue = "";
        state.patientDocType = "CPF";
        state.blocks = [];
        state.selectedPage = 1;

        $("patientName").value = "";
        $("patientDocValue").value = "";
        $("patientDocType").value = "CPF";

        renderRxBlocks();
        updateSummaries();
        renderPaperDebounced();
        setMobileTab("editor");
      });

      // config modal
      $("btnOpenConfig").addEventListener("click", openConfig);
      $("btnCloseConfig").addEventListener("click", closeConfig);
      $("btnCloseConfig2").addEventListener("click", closeConfig);
      $("configMask").addEventListener("mousedown", (e)=>{ if(e.target === $("configMask")) closeConfig(); });

      // preview thumbs live
      $("headerUrl").addEventListener("input", ()=>{
        $("headerThumb").src = safeText($("headerUrl").value) || PLACEHOLDER_PNG;
      });
      $("footerUrl").addEventListener("input", ()=>{
        $("footerThumb").src = safeText($("footerUrl").value) || PLACEHOLDER_PNG;
      });
      $("headerThumb").addEventListener("error", ()=>{ $("headerThumb").src = PLACEHOLDER_PNG; }, { once:true });
      $("footerThumb").addEventListener("error", ()=>{ $("footerThumb").src = PLACEHOLDER_PNG; }, { once:true });

      $("btnResetConfig").addEventListener("click", ()=>{
        const d = getDefaultPageConfig();
        Object.assign(state, d);
        applyLayoutVars();
        saveConfig();
        syncConfigToInputs();
        renderPaperDebounced();
      });

      $("btnSaveConfig").addEventListener("click", ()=>{
        readConfigFromInputs();
        saveConfig();
        closeConfig();
        renderPaperDebounced();
      });

      // print
      $("btnPrintOnly").addEventListener("click", printCurrent);
      $("btnPrintAll").addEventListener("click", printAll);

      // copy
      $("btnCopyText").addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText($("copyBox").value || "");
          $("copyStatus").textContent = "Copiado ✅";
          setTimeout(()=>{ $("copyStatus").textContent = "Atualizado."; }, 900);
        }catch(e){
          $("copyStatus").textContent = "Não foi possível copiar automaticamente.";
        }
      });

      // pages
      $("pageSelect").addEventListener("change", ()=>{
        state.selectedPage = parseInt($("pageSelect").value, 10) || 1;
        renderPaperDebounced();
      });
      $("btnPrevPage").addEventListener("click", ()=>{
        state.selectedPage = Math.max(1, (parseInt(state.selectedPage,10)||1) - 1);
        renderPaperDebounced();
      });
      $("btnNextPage").addEventListener("click", ()=>{
        // we don't know max without computing; render will clamp
        state.selectedPage = (parseInt(state.selectedPage,10)||1) + 1;
        renderPaperDebounced();
      });

      // mobile tabs
      $("tabEditor").addEventListener("click", ()=> setMobileTab("editor"));
      $("tabPreview").addEventListener("click", ()=> setMobileTab("preview"));
      window.addEventListener("resize", ()=> setMobileTab($("tabPreview").classList.contains("on") ? "preview" : "editor"));

      // escape closes modals
      window.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          closeLogin();
          closeConfig();
          closeAccountMenu();
        }
      });
    }

    function applyLoadedConfig(){
      const cfg = loadConfig();
      if(!cfg) return;

      state.paperSize = cfg.paperSize || state.paperSize;
      state.includeDate = (cfg.includeDate !== undefined) ? !!cfg.includeDate : state.includeDate;
      state.dateValue = safeText(cfg.dateValue) || state.dateValue;

      state.rxFontSize = isFinite(cfg.rxFontSize) ? clamp(cfg.rxFontSize, 7.5, 18) : state.rxFontSize;
      state.rxFontFamily = cfg.rxFontFamily || state.rxFontFamily;

      state.headerImgUrl = safeText(cfg.headerImgUrl);
      state.footerImgUrl = safeText(cfg.footerImgUrl);
      state.instName = safeText(cfg.instName);
      state.instAddress = safeText(cfg.instAddress);

      state.headerTransform = cfg.headerTransform || state.headerTransform;
      state.footerTransform = cfg.footerTransform || state.footerTransform;

      state.edgeL = isFinite(cfg.edgeL) ? clamp(cfg.edgeL, 0, 120) : state.edgeL;
      state.edgeR = isFinite(cfg.edgeR) ? clamp(cfg.edgeR, 0, 120) : state.edgeR;
      state.paperMax = isFinite(cfg.paperMax) ? clamp(cfg.paperMax, 320, 1100) : state.paperMax;
      state.rightColW = isFinite(cfg.rightColW) ? clamp(cfg.rightColW, 280, 920) : state.rightColW;

      applyLayoutVars();
    }

    function init(){
      // brand logo override
      $("brandLogo").src = LOGO_URL || $("brandLogo").src;

      // default date
      state.dateValue = todayBR();

      // load config
      applyLoadedConfig();

      // session/profile
      const u = loadSession();
      if(u){
        state.user = u;
      }
      applyUserUI();

      if(state.user && state.user.email){
        const p = loadProfile();
        if(p){
          state.docTitle = (p.docTitle === "Dra.") ? "Dra." : "Dr.";
          state.docName = safeText(p.docName);
          state.crms = Array.isArray(p.crms) && p.crms.length ? p.crms.map(safeText) : [""];
          state.rqes = Array.isArray(p.rqes) && p.rqes.length ? p.rqes.map(safeText) : [""];
        }
        $("persistHint").textContent = "Logado — suas alterações do médico serão salvas automaticamente nesta conta.";
      }

      // apply to inputs
      $("docTitle").value = state.docTitle;
      $("docName").value = state.docName;

      renderCrmList();
      renderRqeList();

      $("patientName").value = state.patientName;
      $("patientDocType").value = state.patientDocType;
      $("patientDocValue").value = state.patientDocValue;

      // bind
      bindEvents();

      // sidebar
      loadSidebarNav();

      // meds DB
      loadMedicamentosDB().then(()=>{
        // refresh any open autocomplete hints
        renderRxBlocks();
        renderPaperDebounced();
      });

      // initial blocks (optional)
      if(!Array.isArray(state.blocks) || !state.blocks.length){
        state.blocks = [];
      }

      // initial summaries / render
      updateSummaries();
      renderRxBlocks();
      setMobileTab("editor");
      renderPaperDebounced();
    }

    init();
  </script>
</body>
</html>
