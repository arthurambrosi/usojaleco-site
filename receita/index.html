<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prescrição Médica - Premium</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            /* Cores */
            --bg-top: #070a10;
            --bg-bottom: #06070c;
            --text-primary: #e7ecf6;
            --text-muted: #97a5bb;
            --border-primary: rgba(170,195,235,0.12);
            --border-secondary: rgba(170,195,235,0.08);
            --accent-primary: #ff7a18;
            --accent-glow: rgba(255,122,24,0.12);
            --accent-secondary: #ffb703;
            
            /* Fontes */
            --font-display: 'DM Serif Display', serif;
            --font-body: 'Manrope', sans-serif;

            /* Sombras e Raios */
            --radius-lg: 26px;
            --radius-md: 22px;
            --radius-sm: 14px;
            --shadow-card: 0 28px 90px rgba(0,0,0,0.65);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(to bottom, var(--bg-top), var(--bg-bottom));
            color: var(--text-primary);
            font-family: var(--font-body);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            padding: 40px 20px;
        }

        /* Atmosfera de Fundo */
        body::before {
            content: '';
            position: fixed;
            top: -20%; left: -10%;
            width: 50vw; height: 50vw;
            background: radial-gradient(circle, rgba(255,122,24,0.03), transparent 70%);
            pointer-events: none;
            z-index: -1;
        }
        body::after {
            content: '';
            position: fixed;
            bottom: -20%; right: -10%;
            width: 60vw; height: 60vw;
            background: radial-gradient(circle, rgba(4, 56, 115, 0.04), transparent 70%);
            pointer-events: none;
            z-index: -1;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            max-width: 1400px;
            width: 100%;
        }

        /* Coluna Esquerda: Editor */
        .editor-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        header h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        header p { color: var(--text-muted); }

        .card {
            background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--shadow-card);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .input-group {
            margin-bottom: 24px;
            position: relative;
        }

        label {
            display: block;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="text"], textarea, select {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-secondary);
            color: var(--text-primary);
            padding: 16px;
            border-radius: var(--radius-sm);
            font-family: var(--font-body);
            font-size: 1rem;
            transition: all 0.18s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 1px var(--accent-glow);
        }

        /* Autocomplete List */
        .suggestions-list {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: #0f131a;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .suggestions-list div {
            padding: 12px 16px;
            cursor: pointer;
            color: var(--text-muted);
            transition: 0.1s;
        }
        .suggestions-list div:hover {
            background: rgba(255,122,24,0.1);
            color: var(--text-primary);
        }

        /* Container de Medicamentos */
        .medication-item {
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .med-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            align-items: center;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .image-preview-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .img-thumb {
            width: 40px; height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-secondary);
            object-fit: cover;
            cursor: pointer;
            opacity: 0.6;
            transition: 0.2s;
        }
        .img-thumb.selected {
            border-color: var(--accent-primary);
            opacity: 1;
        }

        /* Botões */
        .btn {
            padding: 14px 24px;
            border-radius: var(--radius-sm);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.18s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-family: var(--font-body);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            width: 100%;
            justify-content: center;
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.06);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(45deg, rgba(255,122,24,0.15), rgba(255,122,24,0.05));
            border: 1px solid rgba(255,122,24,0.3);
            color: var(--accent-primary);
            width: 100%;
            justify-content: center;
            box-shadow: 0 0 20px rgba(255,122,24,0.05);
        }
        .btn-primary:hover {
            box-shadow: 0 0 30px rgba(255,122,24,0.15);
            border-color: var(--accent-primary);
        }

        /* Coluna Direita: Preview (Papel) */
        .preview-panel {
            position: relative;
        }
        .paper-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
        }
        
        /* A FOLHA A4 */
        .a4-paper {
            background: white;
            width: 100%;
            aspect-ratio: 1 / 1.414; /* Proporção A4 */
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            padding: 40px;
            color: #222;
            font-family: 'Times New Roman', serif; /* Clássico para receita */
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        /* Elementos da Receita */
        .rx-header {
            margin-bottom: 30px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .patient-display {
            font-size: 1.2rem;
            font-weight: bold;
            font-family: 'Arial', sans-serif;
            text-transform: uppercase;
        }
        
        .rx-symbol {
            font-size: 3rem;
            font-weight: bold;
            font-family: serif;
            margin: 20px 0;
            display: block;
        }

        .med-display-group {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        .med-name-line {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        .med-name-line .dots {
            flex-grow: 1;
            border-bottom: 1px dotted #999;
            margin: 0 10px;
        }
        
        .med-use {
            font-size: 0.95rem;
            margin-top: 5px;
            padding-left: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon-visuals {
            display: flex;
            gap: 8px;
            margin-left: 10px;
            color: #444;
        }
        
        .med-image-print {
            max-width: 80px;
            max-height: 80px;
            margin-top: 5px;
            margin-left: 10px;
            border: 1px solid #ccc;
        }

        /* PRINT STYLES */
        @media print {
            body { 
                background: white; 
                display: block; 
                padding: 0; 
                margin: 0;
            }
            .editor-panel, .paper-controls, h1, p { display: none !important; }
            .preview-panel { width: 100%; margin: 0; }
            .app-container { display: block; width: 100%; max-width: none; }
            .card { border: none; box-shadow: none; padding: 0; background: none; }
            .a4-paper { 
                box-shadow: none; 
                width: 100%; 
                height: 100%; 
                aspect-ratio: auto;
                padding: 1cm;
                border-radius: 0;
            }
        }

        /* Mobile */
        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; }
            .preview-panel { order: -1; } /* Preview em cima no mobile? ou embaixo.. */
        }
    </style>
</head>
<body>

    <div class="app-container">
        
        <div class="editor-panel">
            <header>
                <h1>Nova Prescrição</h1>
                <p>Preencha os dados abaixo. O sistema aprende novos medicamentos automaticamente.</p>
            </header>

            <div class="card">
                <div class="input-group">
                    <label>Paciente</label>
                    <input type="text" id="patientInput" placeholder="Nome completo do paciente" oninput="updatePreview()">
                </div>
            </div>

            <div id="medicationsContainer">
                </div>

            <button class="btn btn-secondary" onclick="addMedicationRow()">
                <i class="fas fa-plus"></i> Adicionar Medicamento
            </button>

            <button class="btn btn-primary" onclick="handlePrintAndSave()" style="margin-top: 20px;">
                <i class="fas fa-print"></i> Imprimir e Salvar Novos
            </button>
        </div>

        <div class="preview-panel">
            <div class="paper-controls">
                <span style="color: var(--text-muted); font-size: 0.9rem;">Visualização A4</span>
                <select id="paperSize" style="width: auto; padding: 8px 12px;">
                    <option value="A4">A4</option>
                    <option value="A5">A5</option>
                </select>
            </div>

            <div class="a4-paper" id="paperPreview">
                <div class="rx-header">
                    <div style="font-size: 0.9rem;">Dr. Exemplo Médico <br> CRM 12345</div>
                    <div class="patient-display" id="previewPatientName">PACIENTE: __________________</div>
                </div>

                <div class="rx-symbol">℞</div>

                <div id="previewMedsList">
                    </div>

                <div style="margin-top: 50px; text-align: center; border-top: 1px solid #000; width: 60%; margin-left: auto; margin-right: auto; padding-top: 10px;">
                    Assinatura
                </div>
            </div>
        </div>

    </div>

<script>
    // --- CONFIGURAÇÃO ---
    // Substitua esta URL pelo SEU script publicado (Instruções abaixo)
    // Se não configurar, o salvamento não funcionará, mas a impressão sim.
    const APPS_SCRIPT_URL = "INSIRA_SUA_URL_DO_APPS_SCRIPT_AQUI"; 
    const SHEET_ID = "1es05SmJavEvGAK99kejsgy986T4kRJKw64wozSLTDRQ";
    
    // Dados em memória
    let allMedications = [];
    let medRows = []; // Rastreia IDs dos inputs

    // 1. CARREGAR DADOS DO GOOGLE SHEETS (CSV)
    async function loadSheetData() {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
        try {
            const response = await fetch(url);
            const text = await response.text();
            parseCSV(text);
        } catch (e) {
            console.error("Erro ao carregar planilha:", e);
        }
    }

    function parseCSV(csvText) {
        const lines = csvText.split('\n');
        // Ignora cabeçalho (linha 0)
        for (let i = 1; i < lines.length; i++) {
            // Separação simples por vírgula (pode precisar de regex se houver vírgulas dentro das células)
            // Assumindo estrutura: Col A (Nome), B, C, D, E (Imagens)
            const cols = lines[i].split(','); 
            if (cols[0]) {
                allMedications.push({
                    name: cols[0].trim(),
                    images: cols.slice(1, 5).map(url => url.trim()).filter(url => url.startsWith('http'))
                });
            }
        }
        // Inicializa com um campo vazio
        addMedicationRow();
    }

    // 2. GERENCIAMENTO DE LINHAS DE REMÉDIO
    function addMedicationRow() {
        const id = Date.now();
        const container = document.getElementById('medicationsContainer');
        
        const div = document.createElement('div');
        div.className = 'card medication-item';
        div.id = `med-row-${id}`;
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <label>Medicamento</label>
                ${medRows.length > 0 ? `<i class="fas fa-trash" style="cursor:pointer; color:#ff5555" onclick="removeRow(${id})"></i>` : ''}
            </div>
            <div class="input-group">
                <input type="text" class="med-name-input" id="med-name-${id}" placeholder="Digite para buscar..." autocomplete="off">
                <div class="suggestions-list" id="suggestions-${id}"></div>
            </div>
            
            <div class="input-group">
                <label>Posologia / Quantidade</label>
                <div style="display:flex; gap: 10px;">
                     <input type="text" id="med-qtd-${id}" placeholder="Ex: 1 Caixa" style="width: 30%">
                     <input type="text" id="med-use-${id}" placeholder="Ex: Tomar 1 comprimido a cada 8 horas..." style="flex:1">
                </div>
            </div>

            <div class="med-controls">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="check-icons-${id}" onchange="updatePreview()">
                    Adicionar ícones de horário
                </label>
                
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="check-img-${id}" onchange="toggleImageSelector(${id})">
                    Inserir foto da caixa
                </label>
            </div>

            <div id="img-selector-${id}" class="image-preview-selector" style="display:none;"></div>
        `;
        
        container.appendChild(div);
        medRows.push(id);

        // Setup Autocomplete
        const input = div.querySelector(`#med-name-${id}`);
        const list = div.querySelector(`#suggestions-${id}`);
        
        input.addEventListener('input', (e) => {
            handleAutocomplete(e.target.value, list, input, id);
            updatePreview();
        });
        
        // Listeners para update
        div.querySelectorAll('input').forEach(el => el.addEventListener('input', updatePreview));
    }

    function removeRow(id) {
        document.getElementById(`med-row-${id}`).remove();
        medRows = medRows.filter(r => r !== id);
        updatePreview();
    }

    // 3. AUTOCOMPLETE LOGIC
    function handleAutocomplete(val, listEl, inputEl, rowId) {
        listEl.innerHTML = '';
        if (!val) {
            listEl.style.display = 'none';
            return;
        }

        const matches = allMedications.filter(m => m.name.toLowerCase().includes(val.toLowerCase()));
        
        if (matches.length > 0) {
            listEl.style.display = 'block';
            matches.forEach(match => {
                const item = document.createElement('div');
                item.textContent = match.name;
                item.onclick = () => {
                    inputEl.value = match.name;
                    listEl.style.display = 'none';
                    // Popula imagens se existirem
                    setupImages(rowId, match.images);
                    updatePreview();
                };
                listEl.appendChild(item);
            });
        } else {
            listEl.style.display = 'none';
        }
    }

    function setupImages(rowId, images) {
        const selector = document.getElementById(`img-selector-${rowId}`);
        selector.innerHTML = '';
        if (images && images.length > 0) {
            images.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'img-thumb';
                img.onclick = () => {
                    // Desmarcar outros
                    selector.querySelectorAll('.img-thumb').forEach(i => i.classList.remove('selected'));
                    img.classList.add('selected');
                    selector.dataset.selected = url;
                    updatePreview();
                };
                selector.appendChild(img);
            });
            // Seleciona o primeiro por padrão
            selector.firstChild.click();
        }
    }

    function toggleImageSelector(id) {
        const check = document.getElementById(`check-img-${id}`);
        const selector = document.getElementById(`img-selector-${id}`);
        selector.style.display = check.checked ? 'flex' : 'none';
        updatePreview();
    }

    // 4. RENDER PREVIEW (CORE LOGIC)
    function updatePreview() {
        const patientName = document.getElementById('patientInput').value;
        document.getElementById('previewPatientName').textContent = patientName ? `PACIENTE: ${patientName}` : 'PACIENTE: __________________';

        const listContainer = document.getElementById('previewMedsList');
        listContainer.innerHTML = '';

        medRows.forEach(id => {
            const name = document.getElementById(`med-name-${id}`).value;
            const qtd = document.getElementById(`med-qtd-${id}`).value;
            const use = document.getElementById(`med-use-${id}`).value;
            const hasIcons = document.getElementById(`check-icons-${id}`).checked;
            const hasImg = document.getElementById(`check-img-${id}`).checked;
            const selectedImgSrc = document.getElementById(`img-selector-${id}`).dataset.selected;

            if (name) {
                const row = document.createElement('div');
                row.className = 'med-display-group';

                // Ícones HTML
                let iconsHtml = '';
                if (hasIcons) {
                    iconsHtml = `
                        <span title="Manhã"><i class="fas fa-sun"></i></span>
                        <span title="Tarde"><i class="fas fa-cloud-sun"></i></span>
                        <span title="Noite"><i class="fas fa-moon"></i></span>
                    `;
                }

                // Imagem HTML
                let imgHtml = '';
                if (hasImg && selectedImgSrc) {
                    imgHtml = `<img src="${selectedImgSrc}" class="med-image-print">`;
                }

                row.innerHTML = `
                    <div class="med-name-line">
                        <span>${name}</span>
                        <div class="dots"></div>
                        <span>${qtd}</span>
                    </div>
                    <div class="med-use">
                        <b>Uso:</b> ${use}
                        <div class="icon-visuals">${iconsHtml}</div>
                    </div>
                    ${imgHtml}
                `;
                listContainer.appendChild(row);
            }
        });
    }

    // 5. PRINT & SAVE LOGIC
    async function handlePrintAndSave() {
        // 1. Identificar novos remédios
        const newMeds = [];
        medRows.forEach(id => {
            const name = document.getElementById(`med-name-${id}`).value.trim();
            if (name && !allMedications.some(m => m.name.toLowerCase() === name.toLowerCase())) {
                newMeds.push(name);
            }
        });

        // 2. Chamar a impressão
        window.print();

        // 3. Enviar para a planilha (Background)
        if (newMeds.length > 0 && APPS_SCRIPT_URL !== "INSIRA_SUA_URL_DO_APPS_SCRIPT_AQUI") {
            try {
                // Usando 'no-cors' pois Google Scripts tem restrições de CORS simples, 
                // o script receberá, mas não conseguimos ler a resposta JSON aqui.
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ medications: newMeds })
                });
                console.log("Novos remédios enviados para cadastro.");
                // Adiciona localmente para não enviar de novo na mesma sessão
                newMeds.forEach(n => allMedications.push({ name: n, images: [] }));
            } catch (e) {
                console.error("Erro ao salvar novos remédios:", e);
            }
        }
    }

    // Init
    window.onload = loadSheetData;

</script>
</body>
</html>
